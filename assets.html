<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asset Management - MERC-CMMS</title>
<link rel="icon" type="image/x-icon" href="public/favicon.ico">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="stylesheet" href="mobile-responsive.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>
<script src="auth.js"></script>
<script src="js/mmd-asset-form.js"></script>
<script src="js/depreciation-reference-manager.js"></script>
<script src="js/asset-depreciation-handler.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
* { font-family: 'Inter', sans-serif; }
.medical-gradient { background: linear-gradient(135deg, #1e293b 0%, #2563eb 50%, #0891b2 100%); }
.card-hover { transition: all 0.3s ease; }
.card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
.status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
.status-active { background-color: #059669; }
.status-inactive { background-color: #6b7280; }
.status-maintenance { background-color: #d97706; }
.status-retired { background-color: #dc2626; }
.asset-header-bg { background-image: url('/resources/asset-header.jpg'); background-size: cover; background-position: center; }
.form-input { width: 100%; padding: 10px 16px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; transition: all 0.2s; }
@media (max-width: 768px) {
    .form-input { padding: 14px 16px; font-size: 16px; min-height: 48px; }
    input[type="text"], input[type="number"], input[type="date"], input[type="email"], input[type="password"], textarea, select { font-size: 16px !important; }
}
.form-input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
.btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s; border: none; min-height: 44px; min-width: 44px; }
@media (max-width: 768px) {
    .btn { padding: 14px 20px; font-size: 16px; min-height: 48px; }
}
.btn-primary { background: #2563eb; color: white; }
.btn-primary:hover { background: #1d4ed8; }
.btn-secondary { background: #e2e8f0; color: #475569; }
.btn-secondary:hover { background: #cbd5e1; }
.btn-success { background: #059669; color: white; }
.btn-success:hover { background: #047857; }
.loading-spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: #2563eb; border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.fade-in { animation: fadeIn 0.3s ease-in-out; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
#toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
.toast { padding: 12px 20px; border-radius: 8px; color: white; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); animation: slideIn 0.3s ease-out; max-width: 400px; }
.toast-success { background: #059669; }
.toast-error { background: #dc2626; }
.toast-warning { background: #d97706; }
.toast-info { background: #2563eb; }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
.status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: capitalize; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; }
.modal.active { display: flex; align-items: center; justify-content: center; }
.modal-content { background: white; border-radius: 16px; max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
@media (max-width: 768px) {
    .modal-content { width: 100%; max-width: 100%; max-height: 100vh; border-radius: 0; margin: 0; }
    .modal { padding: 0; align-items: flex-start; }
    .modal.active { padding-top: 0; }
}
.tab-button { padding: 12px 24px; border-bottom: 2px solid transparent; font-weight: 600; cursor: pointer; transition: all 0.2s; color: #64748b; min-height: 44px; }
@media (max-width: 768px) {
    .tab-button { padding: 14px 16px; font-size: 14px; min-height: 48px; }
    .tab-button i { margin-right: 6px; }
}
.column-item { user-select: none; }
.column-item.dragging { opacity: 0.5; }
.column-item.drag-over { border-color: #2563eb !important; background-color: #eff6ff !important; transform: scale(1.02); }
.column-item .fa-grip-vertical { transition: color 0.2s; }
.column-item:hover .fa-grip-vertical { color: #64748b; }
.tab-button.active { color: #2563eb; border-bottom-color: #2563eb; background: #eff6ff; }
.tab-button:hover { background: #f8fafc; }
.tab-content { display: none; }
.tab-content.active { display: block; }
#mobile-menu { position: fixed; top: 64px; right: 0; left: auto; min-width: 200px; z-index: 40; background: linear-gradient(135deg, #1e293b 0%, #2563eb 50%, #0891b2 100%); padding: 1rem; box-shadow: -4px 4px 6px -1px rgba(0, 0, 0, 0.1); transform: translateX(0); visibility: visible; opacity: 1; transition: transform 0.3s ease, opacity 0.3s ease; border-radius: 0 0 0 8px; }
#mobile-menu.hidden { transform: translateX(100%); opacity: 0; pointer-events: none; visibility: hidden; }
.drag-drop-zone { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 40px; text-align: center; transition: all 0.2s; cursor: pointer; }
.drag-drop-zone.drag-over { border-color: #2563eb; background: #eff6ff; }
.wo-card { background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; border-left: 4px solid #2563eb; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
.wo-card.priority-critical { border-left-color: #dc2626; }
.wo-card.priority-high { border-left-color: #d97706; }
.wo-card.priority-medium { border-left-color: #2563eb; }
.wo-card.priority-low { border-left-color: #6b7280; }
.view-toggle-btn { 
    background: white; 
    color: #64748b; 
    border: 1px solid #cbd5e1; 
    transition: all 0.2s ease;
}
.view-toggle-btn:hover { 
    background: #f8fafc; 
}
.view-toggle-btn.active { 
    background: #2563eb; 
    color: white; 
    border-color: #2563eb; 
}
</style>
</head>
<body class="bg-slate-50 text-slate-800">
    <!-- Header -->
    <nav class="fixed top-0 left-0 right-0 z-50 medical-gradient shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-nowrap justify-between items-center gap-3 py-2 min-h-[4rem]">
                <a href="index.html" class="flex items-center space-x-4 min-w-0">
                    <img src="/resources/Logo_without%20name.png" alt="MERC-CMMS logo" class="w-10 h-10 rounded-full bg-white object-contain p-1">
                    <div class="min-w-0">
                        <h1 class="text-white text-xl font-bold truncate">MERC-CMMS</h1>
                        <p class="text-blue-200 text-xs truncate">Enterprise Medical Device Management</p>
                    </div>
                </a>
                <div class="hidden md:flex items-center space-x-6">
                    <a href="index.html" class="text-blue-200 hover:text-white transition-colors whitespace-nowrap">Dashboard</a>
                    <a href="customers.html" class="text-blue-200 hover:text-white transition-colors whitespace-nowrap">Customers</a>
                    <a href="assets.html" class="text-white font-semibold border-b-2 border-blue-300 pb-1 whitespace-nowrap">Assets</a>
                    <a href="work-orders.html" class="text-blue-200 hover:text-white transition-colors whitespace-nowrap">Work Orders</a>
                    <a href="inventory.html" class="text-blue-200 hover:text-white transition-colors whitespace-nowrap">Inventory</a>
                    <a href="compliance.html" class="text-blue-200 hover:text-white transition-colors whitespace-nowrap">Compliance</a>
                    <a href="settings.html" class="text-blue-200 hover:text-white transition-colors whitespace-nowrap">Settings</a>
                </div>
                <div class="flex items-center gap-3 flex-shrink-0 ml-auto">
                    <div class="flex items-center gap-3">
                        <button id="logout-button" class="text-white hover:text-blue-200 transition-colors" aria-label="Sign out">
                            <i class="fas fa-right-from-bracket text-xl"></i>
                        </button>
                    </div>
                    <div class="flex items-center space-x-2 min-w-0">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-white text-sm"></i>
                        </div>
                        <div class="hidden md:block min-w-0">
                            <p class="text-white text-sm font-medium truncate">System Admin</p>
                            <p class="text-blue-200 text-xs truncate">Super Administrator</p>
                        </div>
                    </div>
                    <button id="mobile-menu-button" class="md:hidden text-white hover:text-blue-200 transition-colors ml-2" aria-label="Open menu">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>
    <div id="mobile-menu" class="md:hidden hidden medical-gradient shadow-lg">
        <div class="px-4 py-4 space-y-2">
            <a href="index.html" class="block text-blue-200 hover:text-white transition-colors">Dashboard</a>
            <a href="customers.html" class="block text-blue-200 hover:text-white transition-colors">Customers</a>
            <a href="assets.html" class="block text-white font-semibold">Assets</a>
            <a href="work-orders.html" class="block text-blue-200 hover:text-white transition-colors">Work Orders</a>
            <a href="inventory.html" class="block text-blue-200 hover:text-white transition-colors">Inventory</a>
            <a href="compliance.html" class="block text-blue-200 hover:text-white transition-colors">Compliance</a>
            <a href="settings.html" class="block text-blue-200 hover:text-white transition-colors">Settings</a>
        </div>
    </div>

    <!-- Main Content -->
    <main class="pt-16">
        <!-- Page Header -->
        <section class="bg-gradient-to-r from-blue-600 to-blue-800">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <h1 class="text-2xl font-bold text-white">Asset Management</h1>
            </div>
        </section>

        <!-- Statistics Dashboard -->
        <section class="py-8 bg-white">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Asset Summary</h2>
                        <p class="text-sm text-slate-500">Counts update automatically from the latest asset data.</p>
                    </div>
                    <div class="text-sm text-slate-500">Last refreshed: <span id="assets-last-refresh">--</span></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                    <div class="bg-slate-50 rounded-lg p-4 text-center">
                        <div id="stat-total" class="text-2xl font-bold text-blue-600">0</div>
                        <div class="text-slate-600 text-sm">Total Assets</div>
                    </div>
                    <div class="bg-slate-50 rounded-lg p-4 text-center">
                        <div id="stat-active" class="text-2xl font-bold text-green-600">0</div>
                        <div class="text-slate-600 text-sm">Active</div>
                    </div>
                    <div class="bg-slate-50 rounded-lg p-4 text-center">
                        <div id="stat-maintenance" class="text-2xl font-bold text-amber-600">0</div>
                        <div class="text-slate-600 text-sm">In Maintenance</div>
                    </div>
                    <div class="bg-slate-50 rounded-lg p-4 text-center">
                        <div id="stat-overdue" class="text-2xl font-bold text-red-600">0</div>
                        <div class="text-slate-600 text-sm">Overdue PM</div>
                    </div>
                    <div class="bg-slate-50 rounded-lg p-4 text-center">
                        <div id="stat-compliant" class="text-2xl font-bold text-purple-600">0%</div>
                        <div class="text-slate-600 text-sm">Compliant</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Controls Bar -->
        <section class="py-6 bg-slate-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div class="flex-1 min-w-[300px]">
                            <div class="relative">
                                <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <input type="text" id="search-input" placeholder="Search by name or serial number..." class="form-input pl-12">
                            </div>
                        </div>
                        <select id="category-filter" class="form-input max-w-[200px]">
                            <option value="">All Categories</option>
                        </select>
                        <select id="status-filter" class="form-input max-w-[180px]">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="maintenance">Maintenance</option>
                    <option value="inactive">Inactive</option>
                    <option value="retired">Retired</option>
                </select>
                <button onclick="showColumnVisibilityModal()" class="btn btn-secondary" title="Customize visible columns">
                    <i class="fas fa-columns"></i>
                    <span class="hidden sm:inline ml-2">Columns</span>
                    </button>
                <button onclick="resetAllFilters()" class="btn btn-secondary" title="Reset all filters">
                    <i class="fas fa-filter"></i>
                    <i class="fas fa-times ml-1 text-xs"></i>
                    <span class="hidden sm:inline ml-2">Reset Filters</span>
                    </button>
                <div class="flex gap-2 flex-wrap items-center">
                    <button id="bulk-edit-btn" onclick="showBulkEditModal()" class="btn btn-secondary hidden" title="Bulk edit selected assets">
                        <i class="fas fa-edit"></i>
                        <span class="hidden sm:inline ml-2">Bulk Edit</span>
                        <span id="selected-count-badge" class="ml-2 bg-blue-600 text-white text-xs px-2 py-1 rounded-full">0</span>
                    </button>
                    <button onclick="showPMManagement()" class="btn btn-secondary">
                        <i class="fas fa-calendar-check"></i>
                        <span class="hidden sm:inline ml-2">PM Management</span>
                    </button>
                <button onclick="showBulkImportModal()" class="btn btn-secondary">
                    <i class="fas fa-file-import"></i>
                        <span class="hidden sm:inline ml-2">Bulk Import</span>
                </button>
                <button onclick="exportToCSV()" class="btn btn-success">
                    <i class="fas fa-download"></i>
                        <span class="hidden sm:inline ml-2">Export</span>
                </button>
                <button onclick="showAddAssetModal()" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                        <span class="hidden sm:inline ml-2">Add Asset</span>
                </button>
                </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Loading State -->
        <section class="py-8 bg-white">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div id="loading" class="text-center py-16" style="display: none;">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-600 font-medium">Loading assets from Supabase...</p>
                </div>
                <div id="assets-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 fade-in hidden"></div>
                <div id="assets-list">
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <!-- Mobile Filter Button -->
                        <div class="md:hidden p-4 border-b border-slate-200">
                            <button onclick="showMobileFilters()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg transition-colors flex items-center justify-center space-x-2">
                                <i class="fas fa-filter"></i>
                                <span>Filters</span>
                                <span id="mobile-filter-count" class="bg-blue-800 text-xs px-2 py-1 rounded-full">0</span>
                            </button>
                        </div>
                        <!-- Table Container with Horizontal Scroll -->
                        <div class="overflow-x-auto -mx-4 sm:mx-0 px-4 sm:px-0">
                        <table class="min-w-full divide-y divide-slate-200" id="assets-table" style="min-width: 800px;">
                            <thead class="bg-slate-50" id="assets-list-header">
                                <tr id="assets-list-header-row">
                                    <!-- Headers will be dynamically generated based on visibleColumns -->
                                </tr>
                            </thead>
                            <tbody id="assets-list-body" class="bg-white divide-y divide-slate-200">
                                <!-- Assets will be rendered here -->
                            </tbody>
                        </table>
                        </div>
                    </div>
                    <!-- Pagination Controls -->
                    <div id="assets-pagination" class="px-4 py-2 border-t border-slate-200 bg-white">
                        <!-- Pagination will be rendered here -->
                    </div>
                </div>
                <div id="empty-state" class="text-center py-16 bg-slate-50 rounded-xl" style="display:none">
                    <i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-2xl font-bold text-gray-700 mb-2">No Assets Found</h3>
                    <p class="text-gray-500 mb-6">Get started by adding your first medical device asset</p>
                    <button onclick="showAddAssetModal()" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        Add Your First Asset
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-slate-800 text-white py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-slate-400">&copy; 2025 MERC-CMMS Enterprise. All rights reserved.</p>
        </div>
    </footer>

    <!-- Bulk Import Modal -->
    <div id="bulk-import-modal" class="modal">
        <div class="modal-content" style="max-width: 900px; width: 95vw;">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">Bulk Import Assets</h2>
                    <button onclick="closeBulkImportModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <!-- Step 1: File Upload -->
                <div id="import-step-1">
                <div class="mb-6">
                    <h3 class="font-semibold text-gray-900 mb-2">CSV Format Requirements:</h3>
                    <p class="text-sm text-gray-600 mb-3">Your CSV file should include the following columns:</p>
                        <div class="bg-slate-50 p-4 rounded-lg text-sm font-mono mb-3">
                            name,serial_number,status,equipment_type,equipment_make,equipment_model,last_maintenance,next_maintenance,purchase_date,purchase_cost,warranty_expiry,customer_id,location_id,description
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-xs text-blue-800 mb-3">
                            <p class="font-semibold mb-1">ðŸ“‹ CSV Format Notes:</p>
                            <ul class="list-disc list-inside space-y-1">
                                <li><strong>equipment_type, equipment_make, equipment_model:</strong> Must match existing MMD entries (or create them first in Settings)</li>
                                <li><strong>last_maintenance:</strong> Date format: YYYY-MM-DD (e.g., 2024-01-15)</li>
                                <li><strong>next_maintenance:</strong> Will be auto-calculated from PM frequency if left empty</li>
                                <li><strong>status:</strong> active, maintenance, inactive, or retired</li>
                            </ul>
                    </div>
                    <button onclick="downloadTemplate()" class="mt-3 text-blue-600 hover:text-blue-700 text-sm font-semibold">
                        <i class="fas fa-download mr-2"></i>Download CSV Template
                    </button>
                </div>
                <div class="drag-drop-zone" id="drop-zone">
                    <i class="fas fa-cloud-upload-alt text-5xl text-gray-400 mb-4"></i>
                    <p class="text-lg font-semibold text-gray-700 mb-2">Drag and drop your CSV file here</p>
                    <p class="text-sm text-gray-500 mb-4">or</p>
                    <button onclick="document.getElementById('csv-file-input').click()" class="btn btn-primary">
                        <i class="fas fa-file-csv mr-2"></i>Select CSV File
                    </button>
                    <input type="file" id="csv-file-input" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
                </div>
                </div>

                <!-- Step 2: Column Mapping -->
                <div id="import-step-2" class="mt-6" style="display: none;">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-900">Column Mapping</h3>
                        <button onclick="showAddColumnModal()" class="btn btn-secondary text-sm">
                            <i class="fas fa-plus mr-2"></i>Add New Column
                        </button>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">Map your CSV columns to database columns. Unmapped columns will be ignored.</p>
                    <div class="bg-slate-50 p-4 rounded-lg max-h-96 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-300">
                                    <th class="text-left p-2 font-semibold">CSV Column</th>
                                    <th class="text-left p-2 font-semibold">Sample Value</th>
                                    <th class="text-left p-2 font-semibold">Map To Database Column</th>
                                    <th class="text-left p-2 font-semibold">Data Type</th>
                                </tr>
                            </thead>
                            <tbody id="column-mapping-table">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-end gap-3 mt-4">
                        <button onclick="backToStep1()" class="btn btn-secondary">Back</button>
                        <button onclick="proceedToPreview()" class="btn btn-primary">
                            <i class="fas fa-arrow-right mr-2"></i>Continue to Preview
                        </button>
                    </div>
                </div>

                <!-- Step 3: Import Preview -->
                <div id="import-step-3" class="mt-6" style="display: none;">
                    <h3 class="font-semibold text-gray-900 mb-2">Import Preview:</h3>
                    <div id="preview-content" class="bg-slate-50 p-4 rounded-lg max-h-48 overflow-auto"></div>
                    <div class="flex justify-end gap-3 mt-4">
                        <button onclick="backToStep2()" class="btn btn-secondary">Back</button>
                        <button onclick="cancelImport()" class="btn btn-secondary">Cancel</button>
                        <button onclick="confirmImport()" class="btn btn-primary">
                            <i class="fas fa-check mr-2"></i>Import Assets
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Filters Modal -->
    <div id="mobile-filters-modal" class="modal">
        <div class="modal-content" style="max-width: 100%; width: 100vw; height: 100vh; border-radius: 0; margin: 0;">
            <div class="p-4 border-b border-gray-200 bg-blue-600 text-white">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold">Filters</h2>
                    <button onclick="closeMobileFilters()" class="text-white hover:text-gray-200 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-4 overflow-y-auto" style="max-height: calc(100vh - 140px);">
                <div id="mobile-filters-content" class="space-y-4">
                    <!-- Filters will be populated here -->
                </div>
                <div class="flex gap-3 mt-6 pt-4 border-t border-gray-200 sticky bottom-0 bg-white pb-4">
                    <button onclick="clearAllMobileFilters()" class="flex-1 btn btn-secondary py-3 text-base">
                        <i class="fas fa-undo mr-2"></i>Clear All
                    </button>
                    <button onclick="applyMobileFilters()" class="flex-1 btn btn-primary py-3 text-base">
                        <i class="fas fa-check mr-2"></i>Apply Filters
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Column Visibility Modal -->
    <div id="column-visibility-modal" class="modal">
        <div class="modal-content" style="max-width: 600px; width: 95vw;">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">Customize Columns</h2>
                    <button onclick="closeColumnVisibilityModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <p class="text-sm text-gray-600 mb-4">Select which columns to display and drag to reorder them.</p>
                <div id="column-visibility-list" class="space-y-2 max-h-96 overflow-y-auto">
                    <!-- Will be populated by JavaScript -->
                </div>
                <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200">
                    <button onclick="resetColumnVisibility()" class="btn btn-secondary text-sm">
                        <i class="fas fa-undo mr-2"></i>Reset to Default
                    </button>
                    <div class="flex gap-3">
                        <button onclick="closeColumnVisibilityModal()" class="btn btn-secondary">Cancel</button>
                        <button onclick="applyColumnVisibility()" class="btn btn-primary">
                            <i class="fas fa-check mr-2"></i>Apply
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Edit Modal -->
    <div id="bulk-edit-modal" class="modal">
        <div class="modal-content" style="max-width: 700px; width: 95vw;">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">Bulk Edit Assets</h2>
                    <button onclick="closeBulkEditModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <p class="text-sm text-gray-600 mt-2">
                    <span id="bulk-edit-count">0</span> asset(s) selected
                </p>
            </div>
            <div class="p-6">
                <form id="bulk-edit-form">
                    <p class="text-sm text-gray-600 mb-4">
                        Only fill in the fields you want to update. Leave fields empty to keep existing values.
                    </p>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                            <select name="status" class="form-input">
                                <option value="">-- Keep existing --</option>
                                <option value="active">Active</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="inactive">Inactive</option>
                                <option value="retired">Retired</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Location</label>
                            <select name="location_id" id="bulk-edit-location" class="form-input">
                                <option value="">-- Keep existing --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Customer</label>
                            <select name="customer_id" id="bulk-edit-customer" class="form-input">
                                <option value="">-- Keep existing --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Last Maintenance Date</label>
                            <input type="date" name="last_maintenance" class="form-input">
                            <p class="text-xs text-gray-500 mt-1">Leave empty to keep existing value</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Next Maintenance Date</label>
                            <input type="date" name="next_maintenance" class="form-input">
                            <p class="text-xs text-gray-500 mt-1">Leave empty to keep existing value</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Warranty Expiry</label>
                            <input type="date" name="warranty_expiry" class="form-input">
                            <p class="text-xs text-gray-500 mt-1">Leave empty to keep existing value</p>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-200">
                        <button type="button" onclick="closeBulkEditModal()" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save mr-2"></i>Update Selected Assets
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- PM Management Modal -->
    <div id="pm-management-modal" class="modal">
        <div class="modal-content" style="max-width: 800px; width: 95vw;">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">PM Management</h2>
                    <button onclick="closePMManagement()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <!-- Filters -->
                <div class="mb-6 grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                        <select id="pm-status-filter" class="form-input" onchange="PMManagement.filters.status = this.value; PMManagement.render();">
                            <option value="all">All</option>
                            <option value="overdue">Overdue</option>
                            <option value="due-soon">Due Soon (â‰¤7 days)</option>
                            <option value="upcoming">Upcoming (â‰¤30 days)</option>
                            <option value="scheduled">Scheduled</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Due Within (days)</label>
                        <select id="pm-due-filter" class="form-input" onchange="PMManagement.filters.dueWithin = parseInt(this.value) || null; PMManagement.render();">
                            <option value="">All</option>
                            <option value="7">7 days</option>
                            <option value="30" selected>30 days</option>
                            <option value="60">60 days</option>
                            <option value="90">90 days</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Search</label>
                        <input type="text" id="pm-search-filter" class="form-input" placeholder="Search assets..." 
                               oninput="PMManagement.filters.search = this.value; PMManagement.render();">
                    </div>
                </div>
                
                <!-- PM List -->
                <div id="pm-management-container" class="space-y-3 max-h-[60vh] overflow-y-auto">
                    <div class="text-center py-12">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="text-gray-600">Loading PM schedules...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Column Modal -->
    <div id="add-column-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">Add New Column to Assets Table</h2>
                    <button onclick="closeAddColumnModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <form id="add-column-form" onsubmit="handleAddColumn(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Column Name *</label>
                        <input type="text" id="new-column-name" class="form-input" required 
                               pattern="[a-z_][a-z0-9_]*" 
                               title="Must start with a letter and contain only lowercase letters, numbers, and underscores"
                               placeholder="e.g., installation_date">
                        <p class="text-xs text-gray-500 mt-1">Use lowercase with underscores (e.g., installation_date)</p>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Type *</label>
                        <select id="new-column-type" class="form-input" required>
                            <option value="text">Text</option>
                            <option value="integer">Integer</option>
                            <option value="numeric">Numeric (Decimal)</option>
                            <option value="date">Date</option>
                            <option value="timestamp">Timestamp</option>
                            <option value="boolean">Boolean</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Default Value (Optional)</label>
                        <input type="text" id="new-column-default" class="form-input" 
                               placeholder="Leave empty for NULL">
                    </div>
                    <div class="mb-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="new-column-nullable" class="mr-2" checked>
                            <span class="text-sm text-gray-700">Allow NULL values</span>
                        </label>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                        <textarea id="new-column-description" class="form-input" rows="2" 
                                  placeholder="What this column will store"></textarea>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="closeAddColumnModal()" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus mr-2"></i>Add Column
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Asset View/Edit Modal with Tabs -->
    <div id="asset-modal" class="modal">
        <div class="modal-content" onclick="event.stopPropagation(); return false;">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900" id="modal-title">Asset Details</h2>
                        <p class="text-sm text-gray-500 mt-1" id="modal-subtitle"></p>
                    </div>
                    <button onclick="closeAssetModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <!-- Tabs -->
                <div class="flex gap-2 mt-4 border-b">
                    <button class="tab-button active" onclick="switchTab('details')">
                        <i class="fas fa-info-circle mr-2"></i>Details
                    </button>
                    <button class="tab-button" onclick="switchTab('workorders')" id="wo-tab-button">
                        <i class="fas fa-clipboard-list mr-2"></i>Work Orders <span id="wo-count" class="ml-1 bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-xs"></span>
                    </button>
                </div>
            </div>

            <!-- Details Tab -->
            <div id="details-tab" class="tab-content active p-6">
                <form id="asset-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Asset Name *</label>
                            <input type="text" name="name" required class="form-input" placeholder="e.g., MRI Scanner">
                        </div>
                        <!-- Master Database (MMD) Selection - Redesigned to match asset fields style -->
                        <div class="md:col-span-2 border-t border-slate-200 pt-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i class="fas fa-database text-blue-600 mr-2"></i>
                                Equipment Information
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Equipment Type -->
                        <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        Equipment Type <span class="text-red-500">*</span>
                                    </label>
                                    <div class="flex gap-2">
                                        <select id="mmd-type-select" required 
                                                class="form-input flex-1"
                                                onchange="handleMMDTypeChange()">
                                            <option value="">-- Select Equipment Type --</option>
                                        </select>
                                        <button type="button" onclick="openUnifiedMMDModal()" 
                                                class="btn btn-primary px-3 py-2 flex-shrink-0" 
                                                title="Add New Equipment Configuration">
                                            <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                                
                                <!-- Make -->
                        <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        Make <span class="text-red-500">*</span>
                                    </label>
                                    <div class="flex gap-2">
                                        <select id="mmd-make-select" required disabled 
                                                class="form-input flex-1"
                                                onchange="handleMMDMakeChange()">
                                            <option value="">-- Select Type First --</option>
                                        </select>
                                        <button type="button" id="add-mmd-make-btn" onclick="(function(){ const tId = document.getElementById('mmd-type-select')?.value; if(typeof openUnifiedMMDModal === 'function' && tId) { openUnifiedMMDModal({type_id: tId}); } else if(!tId) { alert('Please select a Type first'); } else { console.error('openUnifiedMMDModal not available'); alert('MMD Modal not loaded. Please refresh the page.'); } })()" 
                                                class="btn btn-primary px-3 py-2 flex-shrink-0" 
                                                title="Add New Equipment Configuration" disabled>
                                            <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                                
                                <!-- Model -->
                        <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        Model <span class="text-red-500">*</span>
                                    </label>
                                    <div class="flex gap-2">
                                        <select id="mmd-model-select" name="model_id" required disabled 
                                                class="form-input flex-1"
                                                onchange="handleMMDModelChange()">
                                            <option value="">-- Select Make First --</option>
                                        </select>
                                        <button type="button" id="add-mmd-model-btn" onclick="(function(){ const tId = document.getElementById('mmd-type-select')?.value; const mId = document.getElementById('mmd-make-select')?.value; if(typeof openUnifiedMMDModal === 'function' && tId && mId) { openUnifiedMMDModal({type_id: tId, make_id: mId}); } else if(!tId || !mId) { alert('Please select a Type and Make first'); } else { console.error('openUnifiedMMDModal not available'); alert('MMD Modal not loaded. Please refresh the page.'); } })()" 
                                                class="btn btn-primary px-3 py-2 flex-shrink-0" 
                                                title="Add New Equipment Configuration" disabled>
                                            <i class="fas fa-plus"></i>
                                </button>
                            </div>
                                </div>
                                
                                <!-- PM Frequency (Auto-populated, Read-only) -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        PM Frequency
                                    </label>
                                    <div id="mmd-pm-frequency-display" class="form-input bg-gray-50 text-gray-600">
                                        <span class="text-sm italic">Select a model to see PM frequency</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Selected Configuration Summary -->
                            <div id="mmd-summary" class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <p class="text-sm text-blue-800 text-center">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Complete the selection above to see your configuration
                                </p>
                            </div>
                            
                            <!-- Hidden fields for form submission -->
                            <input type="hidden" id="mmd-type-id" name="type_id">
                            <input type="hidden" id="mmd-make-id" name="make_id">
                            <input type="hidden" id="mmd-pm-frequency-id" name="pm_frequency_id">
                            <input type="hidden" id="mmd-pm-frequency-days" name="pm_frequency_days">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Serial Number *</label>
                            <input type="text" name="serial_number" required class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                            <select name="status" class="form-input">
                                <option value="active">Active</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="inactive">Inactive</option>
                                <option value="retired">Retired</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Purchase Date</label>
                            <input type="date" name="purchase_date" class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Purchase Cost ($)</label>
                            <input type="number" name="purchase_cost" id="purchase-cost" step="0.01" class="form-input" onchange="updateDepreciationPreview()">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Warranty Expiry</label>
                            <input type="date" name="warranty_expiry" class="form-input">
                        </div>
                        <div class="md:col-span-2 border-t border-slate-200 pt-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-gray-900">Depreciation</h3>
                                <span class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded">Profile-Based (Auto-Calculated)</span>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Depreciation Profile *</label>
                                    <select name="depreciation_profile_id" id="depreciation-profile-select" class="form-input" onchange="updateDepreciationPreview()">
                                        <option value="">-- Select Profile --</option>
                                    </select>
                                    <p class="text-xs text-slate-500 mt-1">Select a profile from Settings > Depreciation Profiles</p>
                                </div>
                                <div id="depreciation-override-section" style="display: none;">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Override Reason (Admin Only)</label>
                                    <input type="text" name="depreciation_override_reason" id="depreciation-override-reason" class="form-input" placeholder="Reason for manual override">
                                    <p class="text-xs text-amber-600 mt-1">âš ï¸ Override requires admin permission and audit trail</p>
                                </div>
                                <div class="md:col-span-2 bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <h4 class="font-semibold text-blue-900 mb-2">Calculated Depreciation (Read-Only)</h4>
                                    <div id="depreciation-preview" class="text-sm text-blue-800 space-y-1">
                                        <p class="text-slate-500">Select a depreciation profile and enter purchase cost to see calculation.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Customer</label>
                            <select name="customer_id" id="customer-select" class="form-input">
                                <option value="">Select Customer</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Location</label>
                            <select name="location_id" id="location-select" class="form-input">
                                <option value="">Select Location</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                            <textarea name="description" rows="3" class="form-input"></textarea>
                        </div>
                        <!-- Simplified PM Management (PM frequency comes from MMD) -->
                        <div class="md:col-span-2 border-t border-slate-200 pt-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i class="fas fa-calendar-check text-blue-600 mr-2"></i>
                                Maintenance Dates
                            </h3>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                <p class="text-sm text-blue-800 mb-3">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    <strong>PM Frequency is set automatically</strong> from your selected Model above. You only need to set maintenance dates below.
                                </p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Last Maintenance Date</label>
                                    <input type="date" name="last_maintenance" id="last-maintenance" class="form-input" onchange="calculateNextMaintenance()">
                                    <p class="text-xs text-gray-500 mt-1">When was this asset last serviced?</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Next Maintenance Due</label>
                                    <input type="date" name="next_maintenance" id="next-maintenance" class="form-input">
                                    <p class="text-xs text-gray-500 mt-1">Auto-calculated from PM frequency when last maintenance is set</p>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="flex items-center gap-2 p-3 bg-white border border-gray-200 rounded-lg">
                                        <input type="checkbox" name="auto_generate_wo" id="auto-generate-wo" class="rounded border-gray-300" checked>
                                        <div>
                                            <span class="text-sm font-semibold text-gray-700 block">Auto-Generate Work Orders</span>
                                            <span class="text-xs text-gray-500">Automatically create PM work orders 7 days before due date</span>
                                        </div>
                                    </label>
                                </div>
                                    </div>
                                </div>
                        
                        <!-- Asset Images Section -->
                        <div class="md:col-span-2 border-t border-slate-200 pt-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i class="fas fa-images text-blue-600 mr-2"></i>
                                Asset Images
                            </h3>
                            <div class="mb-4">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Upload Images</label>
                                <input type="file" id="asset-image-input" accept="image/*" multiple class="form-input" onchange="handleAssetImageUpload(event)">
                                <p class="text-xs text-gray-500 mt-1">You can upload multiple images. Supported formats: JPG, PNG, GIF, WebP</p>
                                </div>
                            <div id="asset-images-preview" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                                <!-- Image previews will be shown here -->
                            </div>
                            <input type="hidden" id="asset-images-urls" name="image_urls">
                        </div>
                    </div>
                    <input type="hidden" name="id" id="edit-asset-id">
                    <div class="flex justify-end gap-3 mt-8">
                        <button type="button" onclick="closeAssetModal()" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> <span id="submit-btn-text">Save Asset</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Work Orders Tab -->
            <div id="workorders-tab" class="tab-content p-6 border-t border-slate-200">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">Work Orders for this Asset</h3>
                    <button onclick="createWorkOrderForAsset()" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i> Create Work Order
                    </button>
                </div>
                <div id="asset-work-orders-list">
                    <p class="text-center text-gray-500 py-8">Loading work orders...</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Lookup Add New Modal -->
    <!-- Quick Add MMD Modal -->
    <div id="quick-add-mmd-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">Quick Add Equipment</h2>
                    <button onclick="closeQuickAddMMDModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <p class="text-sm text-gray-600 mt-2">Add Type, Make, Model, and PM Frequency all at once</p>
            </div>
            <div class="p-6">
                <form id="quick-add-mmd-form" class="space-y-4">
                        <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Equipment Type <span class="text-red-500">*</span>
                        </label>
                        <div class="flex gap-2">
                            <select id="quick-type-select" class="form-input flex-1" required>
                                <option value="">-- Select Existing Type --</option>
                            </select>
                            <input type="text" id="quick-type-new" class="form-input flex-1" 
                                   placeholder="Or enter new type name">
                        </div>
                        </div>
                        <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Make <span class="text-red-500">*</span>
                        </label>
                        <div class="flex gap-2">
                            <select id="quick-make-select" class="form-input flex-1" required disabled>
                                <option value="">-- Select Type First --</option>
                            </select>
                            <input type="text" id="quick-make-new" class="form-input flex-1" 
                                   placeholder="Or enter new make name" disabled>
                        </div>
                        </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Model <span class="text-red-500">*</span>
                            </label>
                        <div class="flex gap-2">
                            <select id="quick-model-select" class="form-input flex-1" required disabled>
                                <option value="">-- Select Make First --</option>
                            </select>
                            <input type="text" id="quick-model-new" class="form-input flex-1" 
                                   placeholder="Or enter new model name" disabled>
                        </div>
                            </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            PM Frequency <span class="text-red-500">*</span>
                        </label>
                        <select id="quick-pm-frequency" class="form-input" required disabled>
                            <option value="">-- Select Model First --</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">PM frequency is required for the model</p>
                        </div>
                    <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
                        <button type="button" onclick="closeQuickAddMMDModal()" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save mr-2"></i>Save & Apply
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="lookup-modal" class="modal">
        <div class="modal-content" style="max-width: 480px;" onclick="event.stopPropagation(); return false;">
            <div class="p-6 border-b border-gray-200" onclick="event.stopPropagation(); return false;">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-900" id="lookup-modal-title">Add New</h2>
                    <button onclick="closeLookupModal(); event.stopPropagation(); return false;" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6" onclick="event.stopPropagation(); return false;">
                <label class="block text-sm font-semibold text-gray-700 mb-2" id="lookup-modal-label">Name</label>
                <input type="text" id="lookup-modal-input" class="form-input" placeholder="Enter value" onclick="event.stopPropagation(); return false;" onfocus="event.stopPropagation(); return false;">
                
                <!-- PM Frequency field (only shown when adding equipment_models) -->
                <div id="lookup-modal-pm-frequency-container" style="display: none;" class="mt-4" onclick="event.stopPropagation(); return false;">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        PM Frequency <span class="text-red-500">*</span>
                    </label>
                    <select id="lookup-modal-pm-frequency" class="form-input" onclick="event.stopPropagation(); return false;" onfocus="event.stopPropagation(); return false;" onmousedown="event.stopPropagation(); return false;">
                        <option value="">-- Select PM Frequency --</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">PM Frequency is required for all models</p>
                </div>
                
                <div class="flex justify-end gap-3 mt-6" onclick="event.stopPropagation(); return false;">
                    <button type="button" class="btn btn-secondary" onclick="closeLookupModal(); event.stopPropagation(); return false;">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveLookupModal(); event.stopPropagation(); return false;">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        const SUPABASE_URL = 'https://hmdemsbqiqlqcggwblvl.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_Z9oNxTGDCCz3EZnh6NqySg_QzF6amCN';
        let supabaseClient;
        let allAssets = [];
        let filteredAssets = [];
        // Store assets by ID for quick lookup
        const assetsById = new Map();
        let customers = [];
        let locations = [];
        let currentAsset = null;
        let deviceConfigurations = [];
        let csvData = null;
        let csvHeaders = [];
        let csvSampleRow = {};
        let columnMapping = {};
        let databaseColumns = [];
        let assetSchema = { hasCustomerId: true, hasLookupIds: true, makeField: 'manufacturer_id' };
        let referenceData = { categories: [], manufacturers: [], models: [], pmFrequencies: [] };
        let referenceMaps = {
            categoriesById: new Map(),
            manufacturersById: new Map(),
            modelsById: new Map(),
            pmFrequenciesByCode: new Map()
        };
        // Expose to window for global access
        window.referenceMaps = referenceMaps;
        let lookupContext = { type: null, label: null, parentId: null };
        let canManageReferenceData = false;
        
        // Column visibility management
        const availableColumns = [
            { id: 'status', label: 'Status', default: true },
            { id: 'name', label: 'Asset Name', default: true },
            { id: 'category', label: 'Category', default: true },
            { id: 'serial_number', label: 'Serial Number', default: true },
            { id: 'next_maintenance', label: 'Next PM', default: true },
            { id: 'compliance', label: 'Compliance', default: true },
            { id: 'location', label: 'Location', default: false },
            { id: 'customer', label: 'Customer', default: false },
            { id: 'purchase_date', label: 'Purchase Date', default: false },
            { id: 'purchase_cost', label: 'Purchase Cost', default: false },
            { id: 'warranty_expiry', label: 'Warranty Expiry', default: false },
            { id: 'last_maintenance', label: 'Last PM', default: false },
            { id: 'model', label: 'Model', default: false },
            { id: 'manufacturer', label: 'Manufacturer', default: false },
            { id: 'description', label: 'Description', default: false }
        ];
        
        let visibleColumns = [];
        
        // Pagination state
        let currentPage = 1;
        let itemsPerPage = 10;
        
        // Sorting state
        let currentSortColumn = null;
        let currentSortDirection = 'asc'; // 'asc' or 'desc'
        
        // Load pagination settings from localStorage
        function loadPaginationSettings() {
            const saved = localStorage.getItem('assetListItemsPerPage');
            if (saved) {
                const parsed = parseInt(saved, 10);
                if (!isNaN(parsed) && parsed > 0) {
                    itemsPerPage = parsed;
                }
            }
        }
        
        // Save pagination settings to localStorage
        function savePaginationSettings() {
            localStorage.setItem('assetListItemsPerPage', itemsPerPage.toString());
        }
        
        // Load column visibility from localStorage
        function loadColumnVisibility() {
            const saved = localStorage.getItem('assetListVisibleColumns');
            if (saved) {
                try {
                    const savedColumns = JSON.parse(saved);
                    // Validate saved columns against available columns
                    visibleColumns = savedColumns.filter(col => 
                        availableColumns.find(ac => ac.id === col)
                    );
                    // Ensure at least one column is visible
                    if (visibleColumns.length === 0) {
                        visibleColumns = availableColumns.filter(c => c.default).map(c => c.id);
                    }
                    // Load and apply column order
                    loadColumnOrder();
                } catch (e) {
                    visibleColumns = availableColumns.filter(c => c.default).map(c => c.id);
                }
            } else {
                visibleColumns = availableColumns.filter(c => c.default).map(c => c.id);
            }
        }
        
        // Save column visibility and order to localStorage
        function saveColumnVisibility() {
            localStorage.setItem('assetListVisibleColumns', JSON.stringify(visibleColumns));
            // Also save column order
            const columnOrder = visibleColumns.map((colId, index) => ({ id: colId, order: index }));
            localStorage.setItem('assetListColumnOrder', JSON.stringify(columnOrder));
        }
        
        // Load column order from localStorage
        function loadColumnOrder() {
            const saved = localStorage.getItem('assetListColumnOrder');
            if (saved) {
                try {
                    const savedOrder = JSON.parse(saved);
                    // Reorder visibleColumns based on saved order
                    const orderedColumns = savedOrder
                        .sort((a, b) => a.order - b.order)
                        .map(item => item.id)
                        .filter(id => visibleColumns.includes(id));
                    
                    // Add any new columns that weren't in saved order
                    const newColumns = visibleColumns.filter(id => !orderedColumns.includes(id));
                    visibleColumns = [...orderedColumns, ...newColumns];
                } catch (e) {
                    console.warn('Error loading column order:', e);
                }
            }
        }
        
        // Initialize column visibility on page load
        loadColumnVisibility();

        document.addEventListener('DOMContentLoaded', async () => {
            // Setup mobile menu using centralized function
            if (typeof setupMobileMenu === 'function') {
                setupMobileMenu();
            } else {
                // Fallback if setupMobileMenu not available
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', () => {
                    mobileMenu.classList.toggle('hidden');
                        const isExpanded = !mobileMenu.classList.contains('hidden');
                        mobileMenuButton.setAttribute('aria-expanded', isExpanded);
                    });
                    // Close menu when clicking links
                    mobileMenu.querySelectorAll('a').forEach(link => {
                        link.addEventListener('click', () => {
                            if (!mobileMenu.classList.contains('hidden')) {
                                mobileMenu.classList.add('hidden');
                                mobileMenuButton.setAttribute('aria-expanded', 'false');
                            }
                        });
                    });
                }
            }

            // Use shared Supabase client from auth.js to avoid multiple instances
            if (window.sharedSupabaseClient) {
                supabaseClient = window.sharedSupabaseClient;
            } else if (window.supabase) {
                // Fallback: create client if shared one not available
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            } else {
                showToast('Supabase library not loaded', 'error');
                return;
            }
            
            // Show loading indicator only when actually loading assets
            showLoading(true);
            
            // Load data in parallel where possible
            await Promise.all([
                detectAssetSchema(),
                loadReferenceData(),
                loadPMFrequencies(),
                loadCustomers(),
                loadLocations()
            ]);
            
            // Load these after reference data is ready (they depend on it)
            await Promise.all([
                loadDeviceConfigurations(),
                loadDatabaseColumns() // Load database columns for import mapping
            ]);
            
            // Finally load assets (which uses reference data)
            await loadAssets();
            setupEventListeners();
            setupDragDrop();
            // Load column order after visibility is loaded
            if (visibleColumns.length > 0) {
                loadColumnOrder();
            }
            renderTableHeader(); // Render table header with visible columns
            initializeView(); // Initialize to list view
            updateBulkEditButton(); // Initialize bulk edit button (hidden initially)
            
            // Setup Quick Add MMD form event listeners
            setupQuickAddMMDListeners();
            
            // Initialize MMD Asset Form Manager with unified reference manager
            if (window.MMDAssetFormManager && !window.mmdAssetFormManager) {
                window.mmdAssetFormManager = new window.MMDAssetFormManager();
                await window.mmdAssetFormManager.init();
            }
        });
        
        function setupQuickAddMMDListeners() {
            const typeSelect = document.getElementById('quick-type-select');
            const typeNew = document.getElementById('quick-type-new');
            const makeSelect = document.getElementById('quick-make-select');
            const makeNew = document.getElementById('quick-make-new');
            const modelSelect = document.getElementById('quick-model-select');
            const modelNew = document.getElementById('quick-model-new');
            const pmSelect = document.getElementById('quick-pm-frequency');
            
            // Type selection - enable/disable make fields
            if (typeSelect) {
                typeSelect.addEventListener('change', async (e) => {
                    const typeId = e.target.value;
                    if (typeId) {
                        // Load makes for this type
                        if (supabaseClient) {
                            try {
                                const { data: makes } = await supabaseClient
                                    .from('equipment_makes')
                                    .select('id, name')
                                    .eq('type_id', typeId)
                                    .is('deleted_at', null)
                                    .order('name');
                                
                                if (makeSelect) {
                                    makeSelect.innerHTML = '<option value="">-- Select Existing Make --</option>' +
                                        (makes || []).map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
                                    makeSelect.disabled = false;
                                }
                                if (makeNew) {
                                    makeNew.disabled = false;
                                }
                            } catch (error) {
                                console.error('Error loading makes:', error);
                            }
                        }
                    } else {
                        if (makeSelect) {
                            makeSelect.innerHTML = '<option value="">-- Select Type First --</option>';
                            makeSelect.disabled = true;
                        }
                        if (makeNew) makeNew.disabled = true;
                        if (modelSelect) {
                            modelSelect.innerHTML = '<option value="">-- Select Make First --</option>';
                            modelSelect.disabled = true;
                        }
                        if (modelNew) modelNew.disabled = true;
                        if (pmSelect) {
                            pmSelect.innerHTML = '<option value="">-- Select Model First --</option>';
                            pmSelect.disabled = true;
                        }
                    }
                });
            }
            
            // Make selection - enable/disable model fields
            if (makeSelect) {
                makeSelect.addEventListener('change', async (e) => {
                    const makeId = e.target.value;
                    if (makeId) {
                        // Load models for this make
                        if (supabaseClient) {
                            try {
                                const { data: models } = await supabaseClient
                                    .from('equipment_models')
                                    .select('id, name, pm_frequency_id')
                                    .eq('make_id', makeId)
                                    .is('deleted_at', null)
                                    .order('name');
                                
                                if (modelSelect) {
                                    modelSelect.innerHTML = '<option value="">-- Select Existing Model --</option>' +
                                        (models || []).map(m => `<option value="${m.id}" data-pm-freq="${m.pm_frequency_id || ''}">${escapeHtml(m.name)}</option>`).join('');
                                    modelSelect.disabled = false;
                                }
                                if (modelNew) {
                                    modelNew.disabled = false;
                }
            } catch (error) {
                                console.error('Error loading models:', error);
                            }
                        }
                    } else {
                        if (modelSelect) {
                            modelSelect.innerHTML = '<option value="">-- Select Make First --</option>';
                            modelSelect.disabled = true;
                        }
                        if (modelNew) modelNew.disabled = true;
                        if (pmSelect) {
                            pmSelect.innerHTML = '<option value="">-- Select Model First --</option>';
                            pmSelect.disabled = true;
                        }
                    }
                });
            }
            
            // Model selection - load PM frequencies
            if (modelSelect) {
                modelSelect.addEventListener('change', async (e) => {
                    const modelId = e.target.value;
                    const selectedOption = e.target.options[e.target.selectedIndex];
                    const pmFreqId = selectedOption?.dataset.pmFreq;
                    
                    if (modelId && pmFreqId) {
                        // Model already has PM frequency, just enable the select
                        if (pmSelect) {
                            pmSelect.value = pmFreqId;
                            pmSelect.disabled = false;
                        }
                    } else if (modelId) {
                        // Model doesn't have PM frequency, need to select one
                        if (supabaseClient) {
                            try {
                                const { data: frequencies } = await supabaseClient
                                    .from('pm_frequencies')
                                    .select('id, name, days')
                                    .eq('is_active', true)
                                    .order('sort_order');
                                
                                if (pmSelect) {
                                    pmSelect.innerHTML = '<option value="">-- Select PM Frequency --</option>' +
                                        (frequencies || []).map(f => `<option value="${f.id}">${escapeHtml(f.name)} (${f.days} days)</option>`).join('');
                                    pmSelect.disabled = false;
                                }
                            } catch (error) {
                                console.error('Error loading PM frequencies:', error);
                            }
                        }
                    } else {
                        if (pmSelect) {
                            pmSelect.innerHTML = '<option value="">-- Select Model First --</option>';
                            pmSelect.disabled = true;
                        }
                    }
                });
            }
            
            // When creating new model, always need PM frequency
            if (modelNew) {
                modelNew.addEventListener('input', () => {
                    if (modelNew.value.trim() && supabaseClient) {
                        // Load PM frequencies if not already loaded
                        if (pmSelect && pmSelect.disabled) {
                            supabaseClient
                                .from('pm_frequencies')
                                .select('id, name, days')
                                .eq('is_active', true)
                                .order('sort_order')
                                .then(({ data: frequencies }) => {
                                    if (pmSelect && frequencies) {
                                        pmSelect.innerHTML = '<option value="">-- Select PM Frequency --</option>' +
                                            frequencies.map(f => `<option value="${f.id}">${escapeHtml(f.name)} (${f.days} days)</option>`).join('');
                                        pmSelect.disabled = false;
                                    }
                                });
                        }
                    }
                });
            }
        }

        async function detectAssetSchema() {
            // Use actual schema from database - assets table has:
            // - customer_id (text, nullable) - exists
            // - model_id (text, nullable) - exists, references equipment_models
            // - NO category_id, manufacturer_id, or make_id columns
            assetSchema = { 
                hasCustomerId: true,  // customer_id exists in schema
                hasLookupIds: true,   // model_id exists, uses MMD system
                makeField: 'model_id' // Assets use model_id which links to equipment_models -> equipment_makes
            };
        }

        async function detectReferenceAccess() {
            try {
                if (!supabaseClient.auth?.getUser) {
                    canManageReferenceData = false;
                    return;
                }
                const { data, error } = await supabaseClient.auth.getUser();
                if (error) throw error;
                canManageReferenceData = Boolean(data?.user);
            } catch (error) {
                if (error?.name === 'AuthSessionMissingError' || /auth session missing/i.test(error?.message || '')) {
                    canManageReferenceData = false;
                    return;
                }
                console.warn('Unable to detect reference access.', error);
                canManageReferenceData = false;
            }
        }

        // Helper function for retrying queries with exponential backoff
        async function retryQuery(fn, maxRetries = 3, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const result = await fn();
                    if (!result.error || !/does not exist|not found|schema cache|relation.*does not exist/i.test(result.error.message || '')) {
                        return result;
                    }
                    if (i < maxRetries - 1) {
                        console.log(`Retrying query (attempt ${i + 2}/${maxRetries}) after ${delay * (i + 1)}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
                    }
                } catch (err) {
                    if (i === maxRetries - 1) throw err;
                    await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
                }
            }
            return await fn(); // Final attempt
        }

        async function loadReferenceData() {
            try {
                await detectReferenceAccess();
                
                // Try direct table queries first
                let categories = null, manufacturers = null, models = null;
                let categoryError = null, manufacturerError = null, modelError = null;
                
                // Load with retry logic for schema cache issues
                const [
                    categoryResult,
                    manufacturerResult,
                    modelResult
                ] = await Promise.all([
                    retryQuery(() => supabaseClient.from('device_categories').select('id, name').order('name'), 2, 500),
                    retryQuery(() => supabaseClient.from('device_makes').select('id, name, category_id').order('name'), 2, 500),
                    retryQuery(() => supabaseClient.from('device_models').select('id, name, make_id').order('name'), 2, 500)
                ]);
                
                categories = categoryResult.data;
                categoryError = categoryResult.error;
                manufacturers = manufacturerResult.data;
                manufacturerError = manufacturerResult.error;
                models = modelResult.data;
                modelError = modelResult.error;
                
                // If direct queries failed with schema errors, try using functions as fallback
                const hasSchemaErrors = [categoryError, manufacturerError, modelError].some(
                    error => error && /does not exist|not found|schema cache|relation.*does not exist|400/i.test(error.message || '')
                );
                
                if (hasSchemaErrors) {
                    console.log('Direct table queries failed, trying function-based fallback...');
                    
                    // Try using RPC functions as fallback
                    try {
                        if (categoryError && /does not exist|not found|schema cache|relation.*does not exist|400/i.test(categoryError.message || '')) {
                            const funcResult = await supabaseClient.rpc('get_device_categories');
                            if (funcResult.data && !funcResult.error) {
                                categories = funcResult.data;
                                categoryError = null;
                                console.log('Successfully loaded categories via function');
                            }
                        }
                    } catch (e) {
                        console.warn('Function fallback for categories failed:', e);
                    }
                    
                    try {
                        if (manufacturerError && /does not exist|not found|schema cache|relation.*does not exist|400/i.test(manufacturerError.message || '')) {
                            const funcResult = await supabaseClient.rpc('get_device_makes', { p_category_id: null });
                            if (funcResult.data && !funcResult.error) {
                                manufacturers = funcResult.data;
                                manufacturerError = null;
                                console.log('Successfully loaded manufacturers via function');
                            }
                        }
                    } catch (e) {
                        console.warn('Function fallback for manufacturers failed:', e);
                    }
                    
                    try {
                        if (modelError && /does not exist|not found|schema cache|relation.*does not exist|400/i.test(modelError.message || '')) {
                            const funcResult = await supabaseClient.rpc('get_device_models', { p_make_id: null });
                            if (funcResult.data && !funcResult.error) {
                                models = funcResult.data;
                                modelError = null;
                                console.log('Successfully loaded models via function');
                            }
                        }
                    } catch (e) {
                        console.warn('Function fallback for models failed:', e);
                    }
                }
                
                // Use data even if there were some errors (graceful degradation)
                referenceData = {
                    categories: categories || [],
                    manufacturers: manufacturers || [],
                    models: models || []
                };
                
                buildReferenceMaps();
                refreshReferenceLookups();
                updateReferenceActionState();
                
                // Show warning if we had to use fallback or if there are still errors
                if (hasSchemaErrors && (categories || manufacturers || models)) {
                    console.log('Loaded data using function fallback - PostgREST schema cache may need time to refresh');
                }
                
                // Only throw if we got no data at all and there were real errors
                if (!categories && !manufacturers && !models && (categoryError || manufacturerError || modelError)) {
                    const nonCacheErrors = [categoryError, manufacturerError, modelError].filter(
                        error => error && !/does not exist|not found|schema cache|relation.*does not exist|400/i.test(error.message || '')
                    );
                    if (nonCacheErrors.length) {
                        throw nonCacheErrors[0];
                    } else {
                        console.error('All queries failed:', { categoryError, manufacturerError, modelError });
                        showToast('Unable to load device catalog data. Please check your database connection.', 'error');
                    }
                }
            } catch (error) {
                console.error('Error loading reference data:', error);
                showToast(`Failed to load reference data: ${error.message}`, 'error');
            }
        }

        async function loadPMFrequencies() {
            try {
                const { data, error } = await retryQuery(() => 
                    supabaseClient.from('pm_frequencies')
                        .select('*')
                        .eq('is_active', true)
                        .order('sort_order', { ascending: true })
                , 2, 500);

                if (error && !/does not exist|not found|schema cache|relation.*does not exist|400/i.test(error.message || '')) {
                    throw error;
                }

                referenceData.pmFrequencies = data || [];
                referenceMaps.pmFrequenciesByCode = new Map(
                    referenceData.pmFrequencies.map(freq => [freq.code, freq])
                );
                // Update window reference
                window.referenceMaps = referenceMaps;

                // Update PM schedule dropdowns
                updatePMScheduleDropdowns();
            } catch (error) {
                console.error('Error loading PM frequencies:', error);
                // Use default frequencies if table doesn't exist
                referenceData.pmFrequencies = [
                    { code: 'daily', name: 'Daily', days: 1 },
                    { code: 'weekly', name: 'Weekly', days: 7 },
                    { code: 'biweekly', name: 'Bi-Weekly', days: 14 },
                    { code: 'monthly', name: 'Monthly', days: 30 },
                    { code: 'quarterly', name: 'Quarterly', days: 90 },
                    { code: 'semiannually', name: 'Semi-Annually', days: 180 },
                    { code: 'annually', name: 'Annually', days: 365 }
                ];
                updatePMScheduleDropdowns();
            }
        }

        function updatePMScheduleDropdowns() {
            // PM schedule dropdowns were removed - PM frequency now comes from MMD selection
            // This function is kept for compatibility but does nothing
        }

        function buildReferenceMaps() {
            referenceMaps.categoriesById = new Map(referenceData.categories.map(category => [category.id, category]));
            referenceMaps.manufacturersById = new Map(referenceData.manufacturers.map(manufacturer => [manufacturer.id, manufacturer]));
            referenceMaps.modelsById = new Map(referenceData.models.map(model => [model.id, model]));
            // Update window reference
            window.referenceMaps = referenceMaps;
        }

        // Apply sorting when assets are loaded
        async function loadAssets() {
            try {
                const { data, error } = await supabaseClient
                    .from('assets')
                    .select('*')
                    .is('deleted_at', null) // Only load assets that haven't been soft deleted
                    .order('id', { ascending: false });
                if (error) throw error;

                // Batch load customers and locations for all assets
                const customerIds = [...new Set((data || []).map(a => a.customer_id).filter(Boolean))];
                const locationIds = [...new Set((data || []).map(a => a.location_id).filter(Boolean))];
                
                const [customersData, locationsData] = await Promise.all([
                    customerIds.length > 0 && assetSchema.hasCustomerId
                        ? supabaseClient.from('customers').select('id, name').in('id', customerIds)
                        : Promise.resolve({ data: [] }),
                    locationIds.length > 0
                        ? supabaseClient.from('locations').select('id, name').in('id', locationIds)
                        : Promise.resolve({ data: [] })
                ]);
                
                const customersMap = new Map((customersData.data || []).map(c => [c.id, c.name]));
                const locationsMap = new Map((locationsData.data || []).map(l => [l.id, l.name]));
                
                // Enrich assets with customer and location names
                const enrichedAssets = (data || []).map(asset => {
                    const categoryName = referenceMaps.categoriesById.get(asset.category_id)?.name || asset.category;
                    const manufacturerKey = asset.manufacturer_id || asset.make_id;
                    const manufacturerName = referenceMaps.manufacturersById.get(manufacturerKey)?.name || asset.manufacturer;
                    const modelName = referenceMaps.modelsById.get(asset.model_id)?.name || asset.model;
                    const customerName = asset.customer_id ? customersMap.get(asset.customer_id) : null;
                    const locationName = asset.location_id ? locationsMap.get(asset.location_id) : null;
                    
                    return {
                        ...asset,
                        category: categoryName,
                        manufacturer: manufacturerName,
                        model: modelName,
                        customers: customerName ? { name: customerName } : null,
                        locations: locationName ? { name: locationName } : null
                    };
                });

                // Store all assets in map for quick lookup
                assetsById.clear();
                enrichedAssets.forEach(asset => {
                    if (asset && asset.id) {
                        assetsById.set(asset.id, asset);
                    }
                });
                
                // Update with enriched data
                allAssets = enrichedAssets;
                filteredAssets = [...allAssets];
                
                // Apply sorting if active
                if (currentSortColumn) {
                    applySorting();
                }
                
                updateStatistics();
                renderTableHeader();
                renderAssets();
                
                // Hide loading immediately after rendering
                showLoading(false);
                
                const lastRefresh = document.getElementById('assets-last-refresh');
                if (lastRefresh) {
                    lastRefresh.textContent = new Date().toLocaleString();
                }
            } catch (error) {
                console.error('Error loading assets:', error);
                showToast(`Failed to load assets: ${error.message}`, 'error');
                allAssets = [];
                filteredAssets = [];
                renderAssets();
                showLoading(false);
            }
        }

        async function loadCustomers() {
            try {
                const { data, error } = await supabaseClient
                    .from('customers')
                    .select('id, name')
                    .eq('status', 'active')
                    .order('name');
                if (error) throw error;
                customers = data || [];
                updateCustomerDropdown();
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        async function loadLocations() {
            try {
                const { data, error } = await supabaseClient
                    .from('locations')
                    .select('id, name, customer_id')
                    .eq('status', 'active')
                    .order('name');
                if (error) throw error;
                locations = data || [];
                updateLocationDropdown();
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }

        function updateCustomerDropdown() {
            const select = document.getElementById('customer-select');
            select.innerHTML = '<option value="">Select Customer</option>';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name;
                select.appendChild(option);
            });
            select.disabled = !assetSchema.hasCustomerId;
            if (!assetSchema.hasCustomerId) {
                select.innerHTML = '<option value="">Customer field unavailable</option>';
            }
        }

        function updateLocationDropdown(customerId = null) {
            const select = document.getElementById('location-select');
            if (!select) return;
            
            const currentValue = select.value; // Preserve current selection if it's still valid
            select.innerHTML = '<option value="">Select Location</option>';
            
            // Filter locations by customer if customerId is provided
            const filteredLocs = customerId ? locations.filter(loc => loc.customer_id === customerId) : locations;
            
            filteredLocs.forEach(location => {
                const option = document.createElement('option');
                option.value = location.id;
                option.textContent = location.name;
                select.appendChild(option);
            });
            
            // Restore previous selection if it's still valid
            if (currentValue && filteredLocs.some(loc => loc.id === currentValue)) {
                select.value = currentValue;
            }
        }

        function refreshReferenceLookups() {
            if (typeof updateCategoryFilterOptions === 'function') {
            updateCategoryFilterOptions();
            }
            if (typeof updateCategorySelectOptions === 'function') {
            updateCategorySelectOptions();
            }
        }

        function updateCategoryFilterOptions() {
            const select = document.getElementById('category-filter');
            if (!select) return;
            const current = select.value;
            select.innerHTML = '<option value="">All Categories</option>';
            if (referenceData && referenceData.categories) {
            referenceData.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
            }
            if (referenceMaps && referenceMaps.categoriesById && referenceMaps.categoriesById.has(current)) {
                select.value = current;
            }
        }

        function updateCategorySelectOptions() {
            const select = document.getElementById('category-select');
            if (!select) return; // Element doesn't exist (likely using MMD form)
            const current = select.value;
            select.innerHTML = '<option value="">Select Category</option>';
            if (referenceData && referenceData.categories) {
            referenceData.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
            }
            if (referenceMaps && referenceMaps.categoriesById && referenceMaps.categoriesById.has(current)) {
                select.value = current;
            }
            if (typeof updateManufacturerOptions === 'function') {
            updateManufacturerOptions(select.value);
            }
        }

        function updateManufacturerOptions(categoryId, selectedManufacturerId = '') {
            const select = document.getElementById('manufacturer-select');
            select.innerHTML = '<option value="">Select Make</option>';
            if (!categoryId) {
                select.disabled = true;
                updateModelOptions('', '');
                return;
            }
            const manufacturers = referenceData.manufacturers.filter(manufacturer => manufacturer.category_id === categoryId);
            manufacturers.forEach(manufacturer => {
                const option = document.createElement('option');
                option.value = manufacturer.id;
                option.textContent = manufacturer.name;
                select.appendChild(option);
            });
            select.disabled = false;
            if (selectedManufacturerId) {
                select.value = selectedManufacturerId;
            }
            updateModelOptions(selectedManufacturerId || select.value);
        }

        function updateModelOptions(manufacturerId, selectedModelId = '') {
            const select = document.getElementById('model-select');
            select.innerHTML = '<option value="">Select Model</option>';
            if (!manufacturerId) {
                select.disabled = true;
                return;
            }
            const models = referenceData.models.filter(model => model.make_id === manufacturerId);
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.name;
                select.appendChild(option);
            });
            select.disabled = false;
            if (selectedModelId) {
                select.value = selectedModelId;
            }
        }

        function updateReferenceActionState() {
            const buttons = [
                document.getElementById('add-category-btn'),
                document.getElementById('add-manufacturer-btn'),
                document.getElementById('add-model-btn')
            ];
            buttons.forEach(button => {
                if (!button) return;
                button.disabled = !canManageReferenceData;
                button.classList.toggle('opacity-50', !canManageReferenceData);
                button.classList.toggle('pointer-events-none', !canManageReferenceData);
            });
        }

        function addNewLookup(type, label) {
            if (!canManageReferenceData) {
                showToast('You do not have permission to add reference data.', 'warning');
                return;
            }
            let parentId = null;
            if (type === 'manufacturers') {
                parentId = document.getElementById('category-select').value;
                if (!parentId) {
                    showToast('Select a category before adding a manufacturer.', 'warning');
                    return;
                }
            }
            if (type === 'models') {
                parentId = document.getElementById('manufacturer-select').value;
                if (!parentId) {
                    showToast('Select a manufacturer before adding a model.', 'warning');
                    return;
                }
            }
            lookupContext = { type, label: label || type.slice(0, -1), parentId };
            const modal = document.getElementById('lookup-modal');
            const title = document.getElementById('lookup-modal-title');
            const inputLabel = document.getElementById('lookup-modal-label');
            const input = document.getElementById('lookup-modal-input');
            title.textContent = `Add New ${lookupContext.label}`;
            inputLabel.textContent = `${lookupContext.label} Name`;
            input.value = '';
            modal.classList.add('active');
            setTimeout(() => input.focus(), 0);
        }

        function closeLookupModal() {
            document.getElementById('lookup-modal').classList.remove('active');
            const pmFrequencyContainer = document.getElementById('lookup-modal-pm-frequency-container');
            const pmFrequencySelect = document.getElementById('lookup-modal-pm-frequency');
            if (pmFrequencyContainer) pmFrequencyContainer.style.display = 'none';
            if (pmFrequencySelect) pmFrequencySelect.value = '';
            lookupContext = { type: null, label: null, parentId: null, isMMD: false };
        }
        
        async function addNewMMD(type, label, parentId = null) {
            if (!canManageReferenceData) {
                showToast('You do not have permission to add reference data.', 'warning');
                return;
            }
            // If parentId not provided, try to get it from dropdowns
            if (!parentId) {
                if (type === 'equipment_makes') {
                    const typeSelect = document.getElementById('mmd-type-select');
                    parentId = typeSelect ? typeSelect.value : null;
                    if (!parentId) {
                        showToast('Select an Equipment Type before adding a Make.', 'warning');
                        return;
                    }
                } else if (type === 'equipment_models') {
                    const makeSelect = document.getElementById('mmd-make-select');
                    parentId = makeSelect ? makeSelect.value : null;
                    if (!parentId) {
                        showToast('Select a Make before adding a Model.', 'warning');
                        return;
                    }
                }
            } else {
                // Validate parentId if provided
                if (type === 'equipment_makes' && !parentId) {
                    showToast('Select an Equipment Type before adding a Make.', 'warning');
                    return;
                } else if (type === 'equipment_models' && !parentId) {
                    showToast('Select a Make before adding a Model.', 'warning');
                    return;
                }
            }
            lookupContext = { type, label: label || type.slice(0, -1), parentId, isMMD: true };
            const modal = document.getElementById('lookup-modal');
            const title = document.getElementById('lookup-modal-title');
            const inputLabel = document.getElementById('lookup-modal-label');
            const input = document.getElementById('lookup-modal-input');
            const pmFrequencyContainer = document.getElementById('lookup-modal-pm-frequency-container');
            const pmFrequencySelect = document.getElementById('lookup-modal-pm-frequency');
            
            title.textContent = `Add New ${lookupContext.label}`;
            inputLabel.textContent = `${lookupContext.label} Name`;
            input.value = '';
            
            // Show PM Frequency field only for equipment_models
            if (type === 'equipment_models') {
                if (pmFrequencyContainer) {
                    pmFrequencyContainer.style.display = 'block';
                }
                // Load PM frequencies
                if (supabaseClient && pmFrequencySelect) {
                    try {
                        const { data: frequencies, error } = await supabaseClient
                            .from('pm_frequencies')
                            .select('id, name, days')
                            .eq('is_active', true)
                            .order('sort_order', { ascending: true });
                        
                        if (!error && frequencies && frequencies.length > 0) {
                            pmFrequencySelect.innerHTML = '<option value="">-- Select PM Frequency --</option>';
                            frequencies.forEach(freq => {
                                const option = document.createElement('option');
                                option.value = freq.id;
                                option.textContent = `${freq.name} (${freq.days} days)`;
                                pmFrequencySelect.appendChild(option);
                            });
                        } else {
                            console.error('No PM frequencies found or error loading:', error);
                            if (pmFrequencySelect) {
                                pmFrequencySelect.innerHTML = '<option value="">-- No PM Frequencies Available --</option>';
                            }
                        }
                    } catch (err) {
                        console.error('Error loading PM frequencies:', err);
                        if (pmFrequencySelect) {
                            pmFrequencySelect.innerHTML = '<option value="">-- Error Loading PM Frequencies --</option>';
                        }
                    }
                } else {
                    console.error('Supabase client or PM frequency select not available');
                }
            } else {
                if (pmFrequencyContainer) {
                    pmFrequencyContainer.style.display = 'none';
                }
                if (pmFrequencySelect) {
                    pmFrequencySelect.value = '';
                }
            }
            
            modal.classList.add('active');
            setTimeout(() => input.focus(), 0);
        }
        
        // Expose addNewMMD to window
        window.addNewMMD = addNewMMD;

        async function saveLookupModal() {
            const input = document.getElementById('lookup-modal-input');
            const value = input.value.trim();
            if (!value || !lookupContext.type) {
                showToast('Please enter a value to add.', 'warning');
                return;
            }
            
            if (!supabaseClient) {
                showToast('Supabase is not connected. Please check your configuration.', 'error');
                return;
            }
            
            try {
                const payload = { name: value };
                let table = '';
                let tableDisplayName = '';
                if (lookupContext.type === 'categories') {
                    table = 'device_categories';
                    tableDisplayName = 'device_categories';
                } else if (lookupContext.type === 'manufacturers') {
                    table = 'device_makes';
                    tableDisplayName = 'device_makes';
                    payload.category_id = lookupContext.parentId;
                    if (!lookupContext.parentId) {
                        showToast('Please select a category first.', 'warning');
                        return;
                    }
                } else if (lookupContext.type === 'models') {
                    table = 'device_models';
                    tableDisplayName = 'device_models';
                    payload.make_id = lookupContext.parentId;
                    if (!lookupContext.parentId) {
                        showToast('Please select a manufacturer first.', 'warning');
                        return;
                    }
                } else if (lookupContext.type === 'equipment_types') {
                    table = 'equipment_types';
                    tableDisplayName = 'equipment_types';
                    payload.is_active = true;
                } else if (lookupContext.type === 'equipment_makes') {
                    table = 'equipment_makes';
                    tableDisplayName = 'equipment_makes';
                    payload.type_id = lookupContext.parentId;
                    payload.is_active = true;
                    if (!lookupContext.parentId) {
                        showToast('Please select an Equipment Type first.', 'warning');
                        return;
                    }
                } else if (lookupContext.type === 'equipment_models') {
                    table = 'equipment_models';
                    tableDisplayName = 'equipment_models';
                    payload.make_id = lookupContext.parentId;
                    payload.is_active = true;
                    if (!lookupContext.parentId) {
                        showToast('Please select a Make first.', 'warning');
                        return;
                    }
                    // PM Frequency is REQUIRED for models (database constraint)
                    const pmFrequencySelect = document.getElementById('lookup-modal-pm-frequency');
                    if (!pmFrequencySelect) {
                        showToast('PM Frequency selector not found. Please refresh the page.', 'error');
                        console.error('PM Frequency select element not found');
                        return;
                    }
                    const pmFrequencyId = pmFrequencySelect.value ? pmFrequencySelect.value.trim() : null;
                    if (!pmFrequencyId || pmFrequencyId === '') {
                        showToast('PM Frequency is required for all models. Please select one from the dropdown.', 'error');
                        // Focus on the PM frequency dropdown
                        setTimeout(() => pmFrequencySelect.focus(), 100);
                        return;
                    }
                    payload.pm_frequency_id = pmFrequencyId;
                    console.log('Creating model with PM Frequency ID:', pmFrequencyId, 'for Make ID:', lookupContext.parentId);
                }
                if (!table) {
                    showToast('Unknown reference type.', 'error');
                    return;
                }
                
                // Helper function to retry with exponential backoff for schema cache issues
                const retryWithBackoff = async (fn, maxRetries = 3, delay = 1000) => {
                    for (let i = 0; i < maxRetries; i++) {
                        try {
                            const result = await fn();
                            if (!result.error || !/does not exist|not found|schema cache|relation.*does not exist/i.test(result.error.message || '')) {
                                return result;
                            }
                            if (i < maxRetries - 1) {
                                await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
                            }
                        } catch (err) {
                            if (i === maxRetries - 1) throw err;
                            await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
                        }
                    }
                    return await fn(); // Final attempt
                };
                
                // Try to check table existence with retry (for schema cache issues)
                const tableCheck = await retryWithBackoff(async () => {
                    return await supabaseClient
                    .from(table)
                    .select('id')
                    .limit(1);
                });
                
                // Only show error if it's definitely not a schema cache issue after retries
                if (tableCheck.error && /does not exist|not found|schema cache|relation.*does not exist/i.test(tableCheck.error.message || '')) {
                    console.warn('Table check failed, but proceeding anyway - may be schema cache issue:', tableCheck.error);
                    // Don't block - proceed with insert attempt as tables exist in database
                }
                
                // Generate IDs for all lookup types
                if (lookupContext.type === 'categories') {
                    // Generate ID from name (lowercase, replace spaces with underscores)
                    payload.id = value.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '').substring(0, 50);
                    // Ensure ID is not empty
                    if (!payload.id) {
                        payload.id = 'category_' + Date.now();
                    }
                } else if (lookupContext.type === 'manufacturers') {
                    // Generate ID from category_id and name
                    const nameSlug = value.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '').substring(0, 30);
                    payload.id = `${lookupContext.parentId}_${nameSlug}`;
                    if (!payload.id || payload.id.length < 2) {
                        payload.id = `${lookupContext.parentId}_make_${Date.now()}`;
                    }
                } else if (lookupContext.type === 'models') {
                    // Generate ID from make_id and name
                    const nameSlug = value.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '').substring(0, 30);
                    payload.id = `${lookupContext.parentId}_${nameSlug}`;
                    if (!payload.id || payload.id.length < 2) {
                        payload.id = `${lookupContext.parentId}_model_${Date.now()}`;
                    }
                } else if (lookupContext.type === 'equipment_types') {
                    // Don't set ID - let database generate it using default (ET-YYYYMMDD-XXXXXX)
                    // payload.id will be undefined, allowing the database default to generate it
                } else if (lookupContext.type === 'equipment_makes') {
                    // Don't set ID - let database generate it using default (EM-YYYYMMDD-XXXXXX)
                    // payload.id will be undefined, allowing the database default to generate it
                } else if (lookupContext.type === 'equipment_models') {
                    // Don't set ID - let database generate it using default (EMOD-YYYYMMDD-XXXXXX)
                    // payload.id will be undefined, allowing the database default to generate it
                }
                
                // Check for duplicate name with retry
                // For manufacturers and models, also check parent relationship
                // Note: For MMD entries, we don't check duplicates by ID since ID is auto-generated
                let duplicateQuery = supabaseClient
                    .from(table)
                    .select('id, name')
                    .is('deleted_at', null); // Only check non-deleted records
                
                if (lookupContext.type === 'manufacturers' && lookupContext.parentId) {
                    duplicateQuery = duplicateQuery.eq('category_id', lookupContext.parentId);
                } else if (lookupContext.type === 'models' && lookupContext.parentId) {
                    duplicateQuery = duplicateQuery.eq('make_id', lookupContext.parentId);
                } else if (lookupContext.type === 'equipment_makes' && lookupContext.parentId) {
                    duplicateQuery = duplicateQuery.eq('type_id', lookupContext.parentId);
                } else if (lookupContext.type === 'equipment_models' && lookupContext.parentId) {
                    duplicateQuery = duplicateQuery.eq('make_id', lookupContext.parentId);
                }
                
                const duplicateCheck = await retryWithBackoff(async () => {
                    return await duplicateQuery.eq('name', value);
                }, 2, 500);
                
                if (duplicateCheck.data && duplicateCheck.data.length > 0) {
                    showToast(`A ${lookupContext.label.toLowerCase()} with this name already exists.`, 'warning');
                    return;
                }
                
                // Use RPC functions (they're more reliable and avoid ambiguous column issues)
                let data = null;
                let error = null;
                
                try {
                    if (lookupContext.type === 'categories') {
                        const { data: funcData, error: funcError } = await supabaseClient.rpc('insert_device_category', {
                            p_id: payload.id,
                            p_name: payload.name,
                            p_description: payload.description || null
                        });
                        if (funcError) {
                            error = funcError;
                            console.error('RPC insert_device_category error:', funcError);
                        } else if (funcData) {
                            // RPC functions returning TABLE return array
                            data = Array.isArray(funcData) ? funcData[0] : funcData;
                            console.log('Successfully inserted category via RPC');
                        }
                    } else if (lookupContext.type === 'manufacturers') {
                        const { data: funcData, error: funcError } = await supabaseClient.rpc('insert_device_make', {
                            p_id: payload.id,
                            p_name: payload.name,
                            p_category_id: payload.category_id,
                            p_description: payload.description || null
                        });
                        if (funcError) {
                            error = funcError;
                            console.error('RPC insert_device_make error:', funcError);
                        } else if (funcData) {
                            data = Array.isArray(funcData) ? funcData[0] : funcData;
                            console.log('Successfully inserted manufacturer via RPC');
                        }
                    } else if (lookupContext.type === 'models') {
                        const { data: funcData, error: funcError } = await supabaseClient.rpc('insert_device_model', {
                            p_id: payload.id,
                            p_name: payload.name,
                            p_make_id: payload.make_id,
                            p_description: payload.description || null
                        });
                        if (funcError) {
                            error = funcError;
                            console.error('RPC insert_device_model error:', funcError);
                        } else if (funcData) {
                            data = Array.isArray(funcData) ? funcData[0] : funcData;
                            console.log('Successfully inserted model via RPC');
                        }
                    } else if (lookupContext.type === 'equipment_types' || lookupContext.type === 'equipment_makes' || lookupContext.type === 'equipment_models') {
                        // MMD entries use direct insert (no RPC functions available)
                        // Database will auto-generate IDs using defaults (ET-YYYYMMDD-XXXXXX, etc.)
                        console.log('MMD entry - using direct insert for', lookupContext.type);
                        
                        // Use validation module if available
                        if (window.MMDValidation && (lookupContext.type === 'equipment_makes' || lookupContext.type === 'equipment_models')) {
                            const validator = new window.MMDValidation(supabaseClient);
                            
                            if (lookupContext.type === 'equipment_makes') {
                                const validation = await validator.validateMakeCreation(value, lookupContext.parentId);
                                if (!validation.valid) {
                                    showToast(validation.error, 'error');
                                    return;
                                }
                            } else if (lookupContext.type === 'equipment_models') {
                                // PM frequency is now required in the modal, so validation is handled above
                                if (!lookupContext.parentId) {
                                    showToast('Make is required for Model', 'error');
                                    return;
                                }
                            }
                        }
                        
                        try {
                            // Insert with select to get the created record (database generates ID)
                            const { data: insertData, error: insertError } = await supabaseClient
                    .from(table)
                    .insert([payload])
                                .select('id, name')
                    .single();
                
                            if (insertError) {
                                error = insertError;
                                console.error('Direct insert error for', lookupContext.type, ':', insertError);
                                
                                // Provide user-friendly error messages
                                if (insertError.code === '23505') { // Unique violation
                                    if (lookupContext.type === 'equipment_makes') {
                                        showToast(`Make "${value}" already exists for this Equipment Type. Please select it from the dropdown or choose a different name.`, 'error');
                                    } else if (lookupContext.type === 'equipment_models') {
                                        showToast(`Model "${value}" already exists for this Make. Please select it from the dropdown or choose a different name.`, 'error');
                                    } else {
                                        showToast(`A ${lookupContext.label.toLowerCase()} with this name already exists.`, 'error');
                                    }
                                    return;
                                } else if (insertError.code === '23503') { // Foreign key violation
                                    if (lookupContext.type === 'equipment_makes') {
                                        showToast('Selected Equipment Type does not exist. Please refresh and try again.', 'error');
                                    } else if (lookupContext.type === 'equipment_models') {
                                        showToast('Selected Make or PM Frequency does not exist. Please refresh and try again.', 'error');
                                    } else {
                                        showToast('Invalid parent selection. Please refresh and try again.', 'error');
                                    }
                                    return;
                                } else if (insertError.code === '23514') { // Check constraint violation
                                    if (lookupContext.type === 'equipment_models') {
                                        showToast('PM Frequency is required for all models. Please select one.', 'error');
                                    } else {
                                        showToast(`Failed to add ${lookupContext.label}: ${insertError.message || 'Validation failed'}`, 'error');
                                    }
                                    return;
                                } else {
                                    // Generic error
                                    showToast(`Failed to add ${lookupContext.label}: ${insertError.message || 'Unknown error'}`, 'error');
                                    return;
                                }
                            } else if (insertData) {
                                data = insertData;
                                error = null;
                                console.log('Successfully inserted MMD entry via direct insert:', data);
                            } else {
                                // If no error but also no data, something went wrong
                                error = { message: 'Insert succeeded but no data returned' };
                                console.error('Insert succeeded but no data returned for', lookupContext.type);
                            }
                        } catch (mmdError) {
                            console.error('MMD direct insert failed:', mmdError);
                            error = mmdError;
                            showToast(`Failed to add ${lookupContext.label}: ${mmdError.message || 'Unknown error'}`, 'error');
                            return;
                        }
                    }
                } catch (funcError) {
                    console.error('RPC function exception:', funcError);
                    error = funcError;
                }
                
                // If RPC failed, try direct insert as fallback (without select to avoid ambiguous column)
                if (error && !data && !lookupContext.isMMD) {
                    console.log('RPC failed, trying direct insert as fallback...');
                    try {
                        // Insert without select first
                        const { error: insertError } = await supabaseClient
                    .from(table)
                            .insert([payload]);
                        
                        if (insertError) {
                            error = insertError;
                        } else {
                            // If insert succeeded, fetch the record
                            const { data: fetchData, error: fetchError } = await supabaseClient
                                .from(table)
                                .select('id, name')
                                .eq('id', payload.id)
                    .single();
                
                            if (fetchError) {
                                error = fetchError;
                            } else if (fetchData) {
                                data = fetchData;
                                error = null;
                                console.log('Successfully inserted via direct insert fallback');
                            }
                        }
                    } catch (fallbackError) {
                        console.error('Direct insert fallback failed:', fallbackError);
                        error = fallbackError;
                    }
                }
                
                // Handle errors - show user-friendly messages
                if (error && !data) {
                    console.error('Final error inserting into', table, ':', error);
                    
                    // Handle schema cache errors with helpful message
                    if (/does not exist|not found|schema cache|relation.*does not exist|400/i.test(error.message || '')) {
                        console.error('Schema cache error detected:', error);
                        const errorMsg = `PostgREST schema cache issue detected. The ${tableDisplayName} table exists but may not be visible yet.\n\n` +
                                       `Please try:\n` +
                                       `1. Wait 30-60 seconds and try again\n` +
                                       `2. Hard refresh your browser (Ctrl+F5 or Cmd+Shift+R)\n` +
                                       `3. Check Supabase dashboard to verify tables exist`;
                        showToast(errorMsg, 'warning', 15000);
                    closeLookupModal();
                    return;
                }
                
                    // Check for specific error types
                    let errorMessage = `Failed to add ${lookupContext.label.toLowerCase()}`;
                    
                    if (error.message) {
                        if (error.message.includes('duplicate key') || error.message.includes('unique constraint')) {
                            errorMessage = `A ${lookupContext.label.toLowerCase()} with this name or ID already exists.`;
                        } else if (error.message.includes('foreign key')) {
                            errorMessage = `Invalid parent reference. Please ensure the parent ${lookupContext.type === 'manufacturers' ? 'category' : 'manufacturer'} exists.`;
                        } else if (error.message.includes('ambiguous')) {
                            errorMessage = `Database error: ${error.message}. Please try again.`;
                    } else {
                            errorMessage = `${errorMessage}: ${error.message}`;
                    }
                    }
                    
                    showToast(errorMessage, 'error');
                    closeLookupModal();
                    return;
                }
                if (lookupContext.type === 'categories') {
                    referenceData.categories.push({ id: data.id, name: data.name });
                    referenceData.categories.sort((a, b) => a.name.localeCompare(b.name));
                    buildReferenceMaps();
                    updateCategorySelectOptions();
                    updateCategoryFilterOptions();
                    document.getElementById('category-select').value = data.id;
                } else if (lookupContext.type === 'manufacturers') {
                    referenceData.manufacturers.push({ id: data.id, name: data.name, category_id: data.category_id });
                    referenceData.manufacturers.sort((a, b) => a.name.localeCompare(b.name));
                    buildReferenceMaps();
                    const categoryId = lookupContext.parentId;
                    updateManufacturerOptions(categoryId, data.id);
                    document.getElementById('manufacturer-select').value = data.id;
                } else if (lookupContext.type === 'models') {
                    referenceData.models.push({ id: data.id, name: data.name, make_id: data.make_id });
                    referenceData.models.sort((a, b) => a.name.localeCompare(b.name));
                    buildReferenceMaps();
                    const manufacturerId = lookupContext.parentId;
                    updateModelOptions(manufacturerId, data.id);
                    document.getElementById('model-select').value = data.id;
                } else if (lookupContext.isMMD) {
                    // Validate data exists before using it
                    if (!data || !data.id) {
                        console.error('Failed to get created record data for', lookupContext.type);
                        showToast(`Failed to add ${lookupContext.label}: Could not retrieve created record.`, 'error');
                        closeLookupModal();
                        return;
                    }
                    
                    // Handle MMD refresh - update both Asset Modal and Settings page
                    if (lookupContext.type === 'equipment_types') {
                        // Refresh type dropdown and select new type (using unified reference manager)
                        if (window.mmdAssetFormManager) {
                            // Invalidate cache and reload
                            if (window.mmdAssetFormManager.referenceManager) {
                                window.mmdAssetFormManager.referenceManager.invalidateCache();
                            }
                            await window.mmdAssetFormManager.loadMMDHierarchy();
                            const typeSelect = document.getElementById('mmd-type-select');
                            if (typeSelect) {
                                typeSelect.value = data.id;
                                window.mmdAssetFormManager.selectedType = data.id;
                                window.mmdAssetFormManager.populateMakeDropdown(data.id);
                                // Update visual feedback
                                if (typeof handleMMDTypeChange === 'function') {
                                    handleMMDTypeChange();
                                }
                            }
                        }
                        // Also refresh Settings page if it's open
                        if (window.MasterDBManager && typeof window.MasterDBManager.loadHierarchy === 'function') {
                            await window.MasterDBManager.loadHierarchy();
                        }
                    } else if (lookupContext.type === 'equipment_makes') {
                        // Refresh make dropdown and select new make (using unified reference manager)
                        if (window.mmdAssetFormManager) {
                            // Invalidate cache and reload
                            if (window.mmdAssetFormManager.referenceManager) {
                                window.mmdAssetFormManager.referenceManager.invalidateCache();
                            }
                            await window.mmdAssetFormManager.loadMMDHierarchy();
                            const typeSelect = document.getElementById('mmd-type-select');
                            const typeId = typeSelect ? typeSelect.value : null;
                            if (typeId) {
                                window.mmdAssetFormManager.populateMakeDropdown(typeId);
                                setTimeout(() => {
                                    const makeSelect = document.getElementById('mmd-make-select');
                                    if (makeSelect) {
                                        makeSelect.value = data.id;
                                        window.mmdAssetFormManager.selectedMake = data.id;
                                        window.mmdAssetFormManager.populateModelDropdown(data.id);
                                        // Update visual feedback
                                        if (typeof handleMMDMakeChange === 'function') {
                                            handleMMDMakeChange();
                                        }
                                    }
                                }, 100);
                            }
                        }
                        // Also refresh Settings page if it's open
                        if (window.MasterDBManager && typeof window.MasterDBManager.loadHierarchy === 'function') {
                            await window.MasterDBManager.loadHierarchy();
                        }
                    } else if (lookupContext.type === 'equipment_models') {
                        // Refresh model dropdown and select new model
                        if (window.mmdAssetFormManager) {
                            // Invalidate cache and reload
                            if (window.mmdAssetFormManager.referenceManager) {
                                window.mmdAssetFormManager.referenceManager.invalidateCache();
                            }
                            await window.mmdAssetFormManager.loadMMDHierarchy();
                            const makeSelect = document.getElementById('mmd-make-select');
                            const makeId = makeSelect ? makeSelect.value : null;
                            if (makeId) {
                                await window.mmdAssetFormManager.populateModelDropdown(makeId);
                                setTimeout(() => {
                                    const modelSelect = document.getElementById('mmd-model-select');
                                    if (modelSelect) {
                                        modelSelect.value = data.id;
                                        window.mmdAssetFormManager.selectedModel = data.id;
                                        window.mmdAssetFormManager.updatePMFrequency(data.id);
                                        // Update visual feedback
                                        if (typeof handleMMDModelChange === 'function') {
                                            handleMMDModelChange();
                                        }
                                    }
                                }, 100);
                            }
                        }
                        // Also refresh Settings page if it's open
                        if (window.MasterDBManager && typeof window.MasterDBManager.loadHierarchy === 'function') {
                            await window.MasterDBManager.loadHierarchy();
                        }
                    }
                }
                closeLookupModal();
            } catch (error) {
                console.error('Error saving lookup value:', error);
                showToast(`Failed to add ${lookupContext.label}: ${error.message}`, 'error');
            }
        }

        function updateStatistics() {
            const total = allAssets.length;
            const active = allAssets.filter(a => a.status === 'active').length;
            const maintenance = allAssets.filter(a => a.status === 'maintenance').length;
            const overdue = allAssets.filter(a => {
                if (!a.next_maintenance) return false;
                return new Date(a.next_maintenance) < new Date();
            }).length;
            const compliant = total > 0 ? Math.round(((total - overdue) / total) * 100) : 0;
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-active').textContent = active;
            document.getElementById('stat-maintenance').textContent = maintenance;
            document.getElementById('stat-overdue').textContent = overdue;
            document.getElementById('stat-compliant').textContent = compliant + '%';
        }

        let currentView = 'list';

        function switchView(view) {
            // Force list view only - ignore grid view requests
            currentView = 'list';
            const gridBtn = document.getElementById('grid-view-btn');
            const listBtn = document.getElementById('list-view-btn');
            if (gridBtn) {
                gridBtn.style.display = 'none'; // Always hide grid button
                gridBtn.classList.remove('active');
            }
            if (listBtn) {
                listBtn.classList.add('active');
            }
            renderAssets();
        }

        function renderAssets() {
            // Force list view only - always render list
            currentView = 'list';
                renderAssetsList();
            }

        // Initialize view on page load
        function initializeView() {
            switchView('list');
        }

        function renderAssetsGrid() {
            const grid = document.getElementById('assets-grid');
            const list = document.getElementById('assets-list');
            const empty = document.getElementById('empty-state');
            
            if (list) list.classList.add('hidden');
            if (grid) grid.classList.remove('hidden');
            
            if (filteredAssets.length === 0) {
                if (grid) grid.style.display = 'none';
                if (empty) empty.style.display = 'block';
                return;
            }
            if (grid) grid.style.display = 'grid';
            if (empty) empty.style.display = 'none';
            if (grid) grid.innerHTML = filteredAssets.map(asset => createAssetCard(asset)).join('');
        }

        function renderAssetsList() {
            const grid = document.getElementById('assets-grid');
            const list = document.getElementById('assets-list');
            const listBody = document.getElementById('assets-list-body');
            const empty = document.getElementById('empty-state');
            
            if (grid) grid.style.display = 'none';
            if (list) list.classList.remove('hidden');
            if (empty) empty.style.display = 'none';
            
            if (!listBody) return;
            
            if (filteredAssets.length === 0) {
                const emptyColspan = visibleColumns.length + 2; // +1 for checkbox, +1 for Actions column
                listBody.innerHTML = `
                    <tr>
                        <td colspan="${emptyColspan}" class="px-6 py-12 text-center text-slate-500">
                            <i class="fas fa-box-open text-4xl mb-4 text-slate-300"></i>
                            <p class="text-lg font-semibold mb-2">No assets found</p>
                            <p class="text-sm mb-4">Get started by adding your first medical device asset</p>
                            <button onclick="showAddAssetModal()" class="btn btn-primary">
                                <i class="fas fa-plus"></i>Add Your First Asset
                            </button>
                        </td>
                    </tr>
                `;
                renderPaginationControls();
                updateBulkEditButton(); // Clear bulk edit button when no assets
                return;
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(filteredAssets.length / itemsPerPage);
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedAssets = filteredAssets.slice(startIndex, endIndex);
            
            listBody.innerHTML = paginatedAssets.map(asset => {
                // Store asset in map for lookup
                assetsById.set(asset.id, asset);
                
                // Add checkbox cell first
                const checkboxCell = `
                    <td class="px-4 py-4 whitespace-nowrap text-center" onclick="event.stopPropagation();">
                        <input type="checkbox" class="asset-checkbox h-4 w-4 text-blue-600 rounded border-slate-300 focus:ring-blue-500" 
                               data-asset-id="${asset.id}" 
                               onclick="handleAssetCheckboxClick(event, this)"
                               onchange="handleAssetCheckboxClick(event, this)">
                        </td>
                `;
                
                // Generate cells based on visible columns
                const cells = visibleColumns.map(colId => {
                    return `<td class="px-6 py-4 whitespace-nowrap">${getColumnValue(asset, colId)}</td>`;
                }).join('');
                
                // Always add Actions column
                const actionsCell = `
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium" onclick="event.stopPropagation();">
                        <button onclick="event.stopPropagation(); viewAssetById('${asset.id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                                <i class="fas fa-eye"></i> View
                            </button>
                        <button onclick="event.stopPropagation(); deleteAsset('${asset.id}')" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                `;
                
                return `
                    <tr class="hover:bg-slate-50 transition-colors cursor-pointer" data-asset-id="${asset.id}" title="Click to view/edit asset">
                        ${checkboxCell}${cells}${actionsCell}
                    </tr>
                `;
            }).join('');
            
            // Update colspan for empty state
            const emptyColspan = visibleColumns.length + 2; // +1 for checkbox, +1 for Actions column
            
            // Update bulk edit button visibility
            updateBulkEditButton();
            
            // Render pagination controls
            renderPaginationControls();
        }

        function createAssetCard(asset) {
            const days = getDaysUntil(asset.next_maintenance);
            const statusColors = {
                active: 'bg-green-100 text-green-800',
                maintenance: 'bg-yellow-100 text-yellow-800',
                inactive: 'bg-gray-100 text-gray-800',
                retired: 'bg-red-100 text-red-800'
            };
                // Store asset in map for lookup
                assetsById.set(asset.id, asset);
                
            return `
                <div class="bg-white rounded-xl p-6 shadow-md card-hover border-l-4 ${days !== null && days < 0 ? 'border-red-500' : days !== null && days <= 7 ? 'border-orange-500' : 'border-green-500'} cursor-pointer" data-asset-id="${asset.id}" title="Click to view/edit asset">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-gray-900 mb-1">${escapeHtml(asset.name)}</h3>
                        </div>
                        <span class="text-xs px-3 py-1 rounded-full ${statusColors[asset.status] || 'bg-gray-100 text-gray-800'}">
                            ${asset.status}
                        </span>
                    </div>
                    <div class="space-y-2 mb-4 text-sm">
                        <div class="flex items-center"><i class="fas fa-tag w-5 text-gray-400"></i><span class="text-gray-700">${escapeHtml(asset.category || 'N/A')}</span></div>
                        <div class="flex items-center"><i class="fas fa-industry w-5 text-gray-400"></i><span class="text-gray-700">${escapeHtml(asset.manufacturer || 'N/A')}</span></div>
                        <div class="flex items-center"><i class="fas fa-building w-5 text-gray-400"></i><span class="text-gray-700">${escapeHtml(asset.customers?.name || 'Unassigned')}</span></div>
                        <div class="flex items-center"><i class="fas fa-map-marker-alt w-5 text-gray-400"></i><span class="text-gray-700">${escapeHtml(asset.locations?.name || 'No Location')}</span></div>
                    </div>
                    <div class="border-t pt-4 mb-4">
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div><span class="text-gray-500 block">Last PM:</span><span class="font-medium text-gray-900">${formatDate(asset.last_maintenance)}</span></div>
                            <div><span class="text-gray-500 block">Next PM:</span><span class="font-medium ${days !== null && days < 0 ? 'text-red-600' : 'text-gray-900'}">${formatDate(asset.next_maintenance)}</span></div>
                        </div>
                        ${days !== null ? `<div class="mt-2 text-sm"><span class="text-gray-500">PM Status:</span><span class="font-bold ${days < 0 ? 'text-red-600' : days <= 7 ? 'text-orange-600' : 'text-green-600'}">${days < 0 ? `${Math.abs(days)} days OVERDUE` : `${days} days remaining`}</span></div>` : ''}
                    </div>
                    <div class="flex gap-2" onclick="event.stopPropagation();">
                        <button onclick="event.stopPropagation(); viewAssetById('${asset.id}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"><i class="fas fa-eye mr-1"></i>View</button>
                        <button onclick="event.stopPropagation(); deleteAsset('${asset.id}')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        }

        function getDaysUntil(date) {
            if (!date) return null;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const targetDate = new Date(date);
            targetDate.setHours(0, 0, 0, 0);
            return Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
        }

        function formatDate(date) {
            if (!date) return 'N/A';
            return new Date(date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showPMManagement() {
            document.getElementById('pm-management-modal').classList.add('active');
            if (window.PMManagement) {
                PMManagement.init();
            }
        }

        function closePMManagement() {
            document.getElementById('pm-management-modal').classList.remove('active');
        }

        function showAddAssetModal() {
            currentAsset = null;
            assetImageUrls = [];
            document.getElementById('modal-title').textContent = 'Add New Asset';
            document.getElementById('modal-subtitle').textContent = '';
            document.getElementById('submit-btn-text').textContent = 'Save Asset';
            document.getElementById('asset-form').reset();
            document.getElementById('edit-asset-id').value = '';
            loadAssetImages([]); // Clear images
            
            // Reset location dropdown to show all locations (no customer selected yet)
            updateLocationDropdown(null);
            
            // Reset MMD form
            if (window.mmdAssetFormManager) {
                window.mmdAssetFormManager.reset();
            }
            
            // Load MMD hierarchy if not already loaded (using unified reference manager)
            if (window.mmdAssetFormManager && window.mmdAssetFormManager.mmdData.types.length === 0) {
                window.mmdAssetFormManager.loadMMDHierarchy();
            }
            
            document.getElementById('wo-tab-button').style.display = 'none';
            switchTab('details');
            document.getElementById('asset-modal').classList.add('active');
        }

        // Helper function to view asset by ID
        function viewAssetById(assetId) {
            if (!assetId) {
                console.error('viewAssetById called without assetId');
                showToast('Invalid asset ID', 'error');
                return;
            }
            const asset = assetsById.get(assetId);
            if (asset) {
                viewAsset(asset);
            } else {
                // If not in map, try to fetch from database
                loadAssetById(assetId);
            }
        }
        
        // Expose globally for onclick handlers
        window.viewAssetById = viewAssetById;
        
        // Load asset from database by ID
        async function loadAssetById(assetId) {
            try {
                const { data, error } = await supabaseClient
                    .from('assets')
                    .select(`
                        *,
                        customers:customer_id(name),
                        locations:location_id(name),
                        equipment_models:model_id(
                            id,
                            name,
                            equipment_makes:make_id(
                                id,
                                name,
                                equipment_types:type_id(
                                    id,
                                    name
                                )
                            )
                        )
                    `)
                    .eq('id', assetId)
                    .is('deleted_at', null) // Only load assets that haven't been soft deleted
                    .single();
                
                if (error) throw error;
                if (data) {
                    // Store in map and view
                    assetsById.set(data.id, data);
                    viewAsset(data);
                } else {
                    showToast('Asset not found', 'error');
                }
            } catch (error) {
                console.error('Error loading asset:', error);
                showToast(`Failed to load asset: ${error.message}`, 'error');
            }
        }

        async function viewAsset(asset) {
            try {
                if (!asset || !asset.id) {
                    console.error('Invalid asset data:', asset);
                    showToast('Invalid asset data', 'error');
                    return;
                }

            currentAsset = asset;
                
                // Set modal title and subtitle with null checks
                const modalTitle = document.getElementById('modal-title');
                const modalSubtitle = document.getElementById('modal-subtitle');
                if (modalTitle) modalTitle.textContent = asset.name || 'Asset Details';
                if (modalSubtitle) modalSubtitle.textContent = asset.name || 'Asset details';
                
            const form = document.getElementById('asset-form');
                if (!form) {
                    console.error('Asset form not found');
                    showToast('Form not found', 'error');
                    return;
                }

                // Basic asset fields with null checks
                const nameInput = form.querySelector('input[name="name"]');
                if (nameInput) nameInput.value = asset.name || '';
                
                const serialInput = form.querySelector('input[name="serial_number"]');
                if (serialInput) serialInput.value = asset.serial_number || '';
                
                const statusSelect = form.querySelector('select[name="status"]');
                if (statusSelect) statusSelect.value = asset.status || 'active';
                
                // Date fields - format properly
                const formatDateForInput = (dateValue) => {
                    if (!dateValue) return '';
                    try {
                        const date = new Date(dateValue);
                        if (isNaN(date.getTime())) return '';
                        return date.toISOString().split('T')[0];
                    } catch (e) {
                        return '';
                    }
                };
                
                const purchaseDateInput = form.querySelector('input[name="purchase_date"]');
                if (purchaseDateInput) purchaseDateInput.value = formatDateForInput(asset.purchase_date);
                
                const purchaseCostInput = form.querySelector('input[name="purchase_cost"]');
                if (purchaseCostInput) purchaseCostInput.value = asset.purchase_cost || '';
                
                const warrantyExpiryInput = form.querySelector('input[name="warranty_expiry"]');
                if (warrantyExpiryInput) warrantyExpiryInput.value = formatDateForInput(asset.warranty_expiry);
                
                // Depreciation profile
                const depProfileSelect = form.querySelector('select[name="depreciation_profile_id"]');
                if (depProfileSelect) {
                    depProfileSelect.value = asset.depreciation_profile_id || '';
                    // Reload profiles if needed
                    if (window.assetDepreciationHandler) {
                        await window.assetDepreciationHandler.loadProfiles();
                        window.assetDepreciationHandler.populateProfileDropdown();
                        depProfileSelect.value = asset.depreciation_profile_id || '';
                    }
                    // Update preview after setting profile
                    setTimeout(() => {
                        if (window.assetDepreciationHandler) {
                            window.assetDepreciationHandler.updatePreview();
                        }
                    }, 200);
                }
                
                // Depreciation override (admin only)
                const depOverrideCheckbox = form.querySelector('input[name="depreciation_override"]');
                if (depOverrideCheckbox) {
                    depOverrideCheckbox.checked = asset.depreciation_override || false;
                    const overrideSection = document.getElementById('depreciation-override-section');
                    if (overrideSection) {
                        overrideSection.style.display = asset.depreciation_override ? 'block' : 'none';
                    }
                }
                
                const depOverrideReasonInput = form.querySelector('input[name="depreciation_override_reason"]');
                if (depOverrideReasonInput) {
                    depOverrideReasonInput.value = asset.depreciation_override_reason || '';
                }
                
                // Customer and Location
                if (assetSchema && assetSchema.hasCustomerId) {
                    const customerSelect = form.querySelector('select[name="customer_id"]');
                    if (customerSelect) customerSelect.value = asset.customer_id || '';
                }
                
                const locationSelect = form.querySelector('select[name="location_id"]');
                if (locationSelect) locationSelect.value = asset.location_id || '';
                
                // Description
                const descriptionTextarea = form.querySelector('textarea[name="description"]');
                if (descriptionTextarea) descriptionTextarea.value = asset.description || '';
                
                // Set asset ID for edit mode
                const editAssetIdInput = document.getElementById('edit-asset-id');
                if (editAssetIdInput) editAssetIdInput.value = asset.id;
                
                // Load MMD data if model_id exists
                if (asset.model_id && window.mmdAssetFormManager) {
                    try {
                        // Load the model with make and type relationships
                        const { data: modelData, error: modelError } = await supabaseClient
                            .from('equipment_models')
                            .select(`
                                id,
                                name,
                                make_id,
                                equipment_makes!equipment_models_make_id_fkey(
                                    id,
                                    name,
                                    type_id,
                                    equipment_types!equipment_makes_type_id_fkey(
                                        id,
                                        name
                                    )
                                )
                            `)
                            .eq('id', asset.model_id)
                            .single();
                        
                        if (!modelError && modelData && modelData.equipment_makes) {
                            const make = modelData.equipment_makes;
                            const type = make && make.equipment_types ? make.equipment_types : null;
                            
                            if (type && type.id) {
                                // Ensure MMD data is loaded (using unified reference manager)
                                if (window.mmdAssetFormManager && window.mmdAssetFormManager.mmdData.types.length === 0) {
                                    await window.mmdAssetFormManager.loadMMDHierarchy();
                                }
                                
                                // Set Type
                                const typeSelect = document.getElementById('mmd-type-select');
                                if (typeSelect && window.mmdAssetFormManager) {
                                    typeSelect.value = type.id;
                                    window.mmdAssetFormManager.selectedType = type.id;
                                    window.mmdAssetFormManager.populateMakeDropdown(type.id);
                                    
                                    // Wait a bit for makes to populate, then set Make
                                    setTimeout(async () => {
                                        const makeSelect = document.getElementById('mmd-make-select');
                                        if (makeSelect && make && make.id) {
                                            makeSelect.value = make.id;
                                            window.mmdAssetFormManager.selectedMake = make.id;
                                            await window.mmdAssetFormManager.populateModelDropdown(make.id);
                                            
                                            // Wait a bit for models to populate, then set Model
                                            setTimeout(() => {
                                                const modelSelect = document.getElementById('mmd-model-select');
                                                if (modelSelect && asset.model_id) {
                                                    modelSelect.value = asset.model_id;
                                                    window.mmdAssetFormManager.selectedModel = asset.model_id;
                                                    window.mmdAssetFormManager.updatePMFrequency(asset.model_id);
                                                }
                                            }, 300);
                                        }
                                    }, 300);
                                }
                            } else {
                                console.warn('Could not load type information for model');
                                if (window.mmdAssetFormManager) {
                                    window.mmdAssetFormManager.reset();
                                }
                            }
                        } else {
                            if (modelError) {
                                console.warn('Error loading MMD data:', modelError);
                            }
                            if (window.mmdAssetFormManager) {
                                window.mmdAssetFormManager.reset();
                            }
                        }
                    } catch (error) {
                        console.error('Error loading MMD data:', error);
                        if (window.mmdAssetFormManager) {
                            window.mmdAssetFormManager.reset();
                        }
                    }
                } else if (window.mmdAssetFormManager) {
                    // Reset MMD if no model_id
                    window.mmdAssetFormManager.reset();
                }
                
                // Load images
                let imageUrls = [];
                if (asset.image_urls) {
                    if (typeof asset.image_urls === 'string') {
                        try {
                            imageUrls = JSON.parse(asset.image_urls);
                        } catch (e) {
                            imageUrls = [];
                        }
                    } else if (Array.isArray(asset.image_urls)) {
                        imageUrls = asset.image_urls;
                    }
                }
                loadAssetImages(imageUrls);
                
                // Load PM Schedule
                loadPMSchedule(asset);
                
                // Update depreciation preview
                if (asset.purchase_cost) {
                    setTimeout(() => {
                        if (typeof updateDepreciationPreview === 'function') {
                            updateDepreciationPreview();
                        }
                    }, 100);
                }
                
                // Update location dropdown if customer is set
                if (assetSchema && assetSchema.hasCustomerId && asset.customer_id) {
                    if (typeof updateLocationDropdown === 'function') {
                updateLocationDropdown(asset.customer_id);
            }
                }
                
                // Show work orders tab
                const woTabButton = document.getElementById('wo-tab-button');
                if (woTabButton) woTabButton.style.display = 'block';
                
                // Load work orders
            await loadAssetWorkOrders(asset.id);
                
                // Open modal
                const assetModal = document.getElementById('asset-modal');
                if (assetModal) {
                    assetModal.classList.add('active');
                } else {
                    console.error('Asset modal not found');
                    showToast('Modal not found', 'error');
                }
            } catch (error) {
                console.error('Error in viewAsset:', error);
                showToast(`Error loading asset: ${error.message}`, 'error');
            }
        }

        function resolveCategoryIdByName(name) {
            if (!name) return '';
            const match = referenceData.categories.find(category => category.name.toLowerCase() === name.toLowerCase());
            return match?.id || '';
        }

        function resolveManufacturerIdByName(name, categoryId = '') {
            if (!name) return '';
            return referenceData.manufacturers.find(manufacturer => {
                const matchesName = manufacturer.name.toLowerCase() === name.toLowerCase();
                const matchesCategory = !categoryId || manufacturer.category_id === categoryId;
                return matchesName && matchesCategory;
            })?.id || '';
        }

        function resolveModelIdByName(name, manufacturerId = '') {
            if (!name) return '';
            return referenceData.models.find(model => {
                const matchesName = model.name.toLowerCase() === name.toLowerCase();
                const matchesManufacturer = !manufacturerId || model.make_id === manufacturerId;
                return matchesName && matchesManufacturer;
            })?.id || '';
        }

        async function loadAssetWorkOrders(assetId) {
            const listEl = document.getElementById('asset-work-orders-list');
            listEl.innerHTML = '<p class="text-center text-gray-500 py-4">Loading...</p>';
            try {
                const { data, error } = await supabaseClient
                    .from('work_orders')
                    .select('*')
                    .eq('asset_id', assetId)
                    .in('status', ['open', 'in-progress'])
                    .order('created_date', { ascending: false });
                if (error) throw error;
                const workOrders = data || [];
                document.getElementById('wo-count').textContent = workOrders.length;
                if (workOrders.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-gray-500 py-8">No work orders found for this asset.</p>';
                } else {
                    listEl.innerHTML = workOrders.map(wo => `
                        <div class="wo-card priority-${wo.priority}">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-semibold text-gray-900">${wo.id}</h4>
                                    <p class="text-sm text-gray-600">${wo.type?.replace(/_/g, ' ') || 'N/A'}</p>
                                </div>
                                <span class="text-xs px-2 py-1 rounded-full ${wo.status === 'completed' ? 'bg-green-100 text-green-800' : wo.status === 'in-progress' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}">
                                    ${wo.status}
                                </span>
                            </div>
                            <p class="text-sm text-gray-700 mb-2">${escapeHtml(wo.description || '')}</p>
                            <div class="flex justify-between items-center text-xs text-gray-500">
                                <span>Priority: ${wo.priority}</span>
                                <span>Due: ${formatDate(wo.due_date)}</span>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading work orders:', error);
                listEl.innerHTML = '<p class="text-center text-red-600 py-4">Failed to load work orders.</p>';
            }
        }

        function loadPMSchedule(asset) {
            if (!asset) return;
            
            const formatDateForInput = (dateValue) => {
                if (!dateValue) return '';
                try {
                    const date = new Date(dateValue);
                    if (isNaN(date.getTime())) return '';
                    return date.toISOString().split('T')[0];
                } catch (e) {
                    return '';
                }
            };
            
            const pmScheduleType = document.getElementById('pm-schedule-type');
            if (pmScheduleType) pmScheduleType.value = asset.pm_schedule_type || '';
            
            const pmIntervalDays = document.getElementById('pm-interval-days');
            if (pmIntervalDays) pmIntervalDays.value = asset.pm_interval_days || '';
            
            const lastMaintenance = document.getElementById('last-maintenance');
            if (lastMaintenance) lastMaintenance.value = formatDateForInput(asset.last_maintenance);
            
            const nextMaintenance = document.getElementById('next-maintenance');
            if (nextMaintenance) nextMaintenance.value = formatDateForInput(asset.next_maintenance);
            
            const autoGenerateWO = document.getElementById('auto-generate-wo');
            if (autoGenerateWO) autoGenerateWO.checked = asset.auto_generate_wo !== false;
            
            if (typeof updatePMPreview === 'function') {
            updatePMPreview();
            }
        }

        function createWorkOrderForAsset() {
            if (!currentAsset?.id) {
                showToast('Please select an asset first.', 'warning');
                return;
            }
            window.location.href = `work-orders.html?asset=${encodeURIComponent(currentAsset.id)}`;
        }

        function clearPMSchedule() {
            // PM schedule section was removed - this function is kept for compatibility
            const lastMaint = document.getElementById('last-maintenance');
            const nextMaint = document.getElementById('next-maintenance');
            if (lastMaint) lastMaint.value = '';
            if (nextMaint) nextMaint.value = '';
        }

        function updatePMPreview() {
            // PM schedule section was removed - this function is kept for compatibility
            // PM frequency now comes from MMD selection
            const lastMaint = document.getElementById('last-maintenance');
            const nextMaint = document.getElementById('next-maintenance');
            
            if (lastMaint && lastMaint.value && window.mmdAssetFormManager && window.mmdAssetFormManager.selectedPMFrequency) {
                const pmDays = window.mmdAssetFormManager.selectedPMFrequency.days;
                if (pmDays) {
                    const lastDate = new Date(lastMaint.value);
                const nextDate = new Date(lastDate);
                    nextDate.setDate(nextDate.getDate() + pmDays);
                    if (nextMaint) {
                        nextMaint.value = nextDate.toISOString().split('T')[0];
                    }
                }
            }
        }

        function calculateNextMaintenanceDate(scheduleType, lastMaint, customInterval) {
            if (!scheduleType || !lastMaint) return null;
            const intervals = { daily: 1, weekly: 7, biweekly: 14, monthly: 30, quarterly: 90, semiannually: 180, annually: 365, custom: parseInt(customInterval) || 30 };
            const days = intervals[scheduleType];
            const lastDate = new Date(lastMaint);
            const nextDate = new Date(lastDate);
            nextDate.setDate(nextDate.getDate() + days);
            return nextDate;
        }

        // Auto-calculate next_maintenance from last_maintenance and PM frequency
        async function calculateNextMaintenance() {
            const lastMaintenanceInput = document.getElementById('last-maintenance');
            const nextMaintenanceInput = document.getElementById('next-maintenance');
            const modelSelect = document.getElementById('mmd-model-select');
            
            if (!lastMaintenanceInput || !nextMaintenanceInput || !lastMaintenanceInput.value) {
                return;
            }

            const lastMaintenance = lastMaintenanceInput.value;
            if (!lastMaintenance) {
                nextMaintenanceInput.value = '';
                return;
            }

            // Get PM frequency from selected model
            let pmDays = null;
            
            if (modelSelect && modelSelect.value && window.mmdAssetFormManager) {
                const selectedOption = modelSelect.options[modelSelect.selectedIndex];
                const pmFrequencyDays = selectedOption.dataset.pmFrequencyDays;
                if (pmFrequencyDays) {
                    pmDays = parseInt(pmFrequencyDays);
                }
            }

            // If no PM frequency from model, try to get from hidden field
            if (!pmDays) {
                const pmFrequencyDaysInput = document.getElementById('mmd-pm-frequency-days');
                if (pmFrequencyDaysInput && pmFrequencyDaysInput.value) {
                    pmDays = parseInt(pmFrequencyDaysInput.value);
                }
            }

            // Default to 90 days if no PM frequency found
            if (!pmDays || isNaN(pmDays)) {
                pmDays = 90; // Default quarterly
            }

            // Calculate next maintenance date
            const lastDate = new Date(lastMaintenance);
            const nextDate = new Date(lastDate);
            nextDate.setDate(nextDate.getDate() + pmDays);
            
            // Format as YYYY-MM-DD for date input
            const year = nextDate.getFullYear();
            const month = String(nextDate.getMonth() + 1).padStart(2, '0');
            const day = String(nextDate.getDate()).padStart(2, '0');
            nextMaintenanceInput.value = `${year}-${month}-${day}`;
        }

        function closeAssetModal() {
            document.getElementById('asset-modal').classList.remove('active');
            currentAsset = null;
            assetImageUrls = [];
            loadAssetImages([]); // Clear images
        }

        async function deleteAsset(assetId) {
            // Check if Supabase client is available
            if (!supabaseClient) {
                showToast('Database connection not available. Please refresh the page.', 'error');
                return;
            }
            
            // Check for related work orders first
            try {
                const { data: workOrders, error: woError } = await supabaseClient
                    .from('work_orders')
                    .select('id, status, type')
                    .eq('asset_id', assetId)
                    .in('status', ['open', 'in-progress']);

                if (woError) {
                    console.warn('Error checking work orders:', woError);
                }

                let confirmMessage = 'Delete this asset?';
                if (workOrders && workOrders.length > 0) {
                    const openCount = workOrders.filter(wo => wo.status === 'open').length;
                    const inProgressCount = workOrders.filter(wo => wo.status === 'in-progress').length;
                    confirmMessage = `This asset has ${workOrders.length} related work order(s) (${openCount} open, ${inProgressCount} in-progress).\n\n` +
                                   `The asset will be marked as deleted (soft delete) to preserve work order history.\n\n` +
                                   `Continue with deletion?`;
                } else {
                    confirmMessage = 'Delete this asset? The asset will be marked as deleted (soft delete) to preserve historical records.';
                }

                if (!confirm(confirmMessage)) return;

                // Use soft delete - set deleted_at timestamp instead of actually deleting
                const { error } = await supabaseClient
                    .from('assets')
                    .update({ 
                        deleted_at: new Date().toISOString(),
                        status: 'retired' // Also set status to retired for UI consistency
                    })
                    .eq('id', assetId);

                if (error) throw error;
                showToast('Asset deleted successfully', 'success');
                await loadAssets();
            } catch (error) {
                console.error('Error deleting asset:', error);
                showToast(`Failed to delete asset: ${error.message}`, 'error');
            }
        }

        document.getElementById('asset-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const assetData = {
                name: formData.get('name'),
                serial_number: formData.get('serial_number'),
                status: formData.get('status'),
                purchase_date: formData.get('purchase_date') || null,
                purchase_cost: formData.get('purchase_cost') ? parseFloat(formData.get('purchase_cost')) : null,
                depreciation_profile_id: formData.get('depreciation_profile_id') || null,
                depreciation_override: formData.get('depreciation_override') === 'on' || formData.get('depreciation_override') === true,
                depreciation_override_reason: formData.get('depreciation_override_reason') || null,
                warranty_expiry: formData.get('warranty_expiry') || null,
                description: formData.get('description') || null,
                last_maintenance: formData.get('last_maintenance') ? new Date(formData.get('last_maintenance')).toISOString() : null,
                next_maintenance: formData.get('next_maintenance') ? new Date(formData.get('next_maintenance')).toISOString() : null,
                image_urls: formData.get('image_urls') ? JSON.parse(formData.get('image_urls')) : null,
                pm_schedule_type: formData.get('pm_schedule_type') || null,
                pm_interval_days: formData.get('pm_interval_days') ? parseInt(formData.get('pm_interval_days')) : null,
                auto_generate_wo: formData.get('auto_generate_wo') === 'on' || formData.get('auto_generate_wo') === true
            };
            // Get assetId first (needed for validation logic)
            const assetId = document.getElementById('edit-asset-id').value;
            
            // MMD-based asset creation - model_id is required
            // Get model_id from MMD form manager (primary) or form field (fallback)
            let modelId = null;
            if (window.mmdAssetFormManager && window.mmdAssetFormManager.selectedModel) {
                modelId = window.mmdAssetFormManager.selectedModel;
            } else {
                modelId = formData.get('model_id');
            }
            
            // For new assets, model_id is mandatory
            if (!assetId && !modelId) {
                showToast('Please select a Model from the MMD hierarchy (Type â†’ Make â†’ Model)', 'error');
                return;
            }
            
            // Set model_id - this enforces MMD relationship
            if (modelId) {
                assetData.model_id = modelId;
            }
            
            // Only include location_id if it has a value
            const locationId = formData.get('location_id');
            if (locationId) {
                assetData.location_id = locationId;
            }
            
            if (assetSchema.hasCustomerId) {
                const customerId = formData.get('customer_id');
                if (customerId) {
                    assetData.customer_id = customerId;
                }
            }
            
            // Validate MMD selection for new assets
            if (!assetId) {
                // New asset - must have MMD selection
                if (window.mmdAssetFormManager) {
                    const validation = window.mmdAssetFormManager.validateMMDSelection();
                    if (!validation.valid) {
                        showToast(validation.message, 'error');
                        return;
                    }
                    
                    // Get MMD data and add to assetData
                    const mmdData = window.mmdAssetFormManager.getSelectedMMDData();
                    assetData.model_id = mmdData.model_id;
                    
                    // Copy PM frequency ID from model at creation time (REQUIRED per requirements)
                    // This is copied, not inferred - it does NOT auto-update if model changes later
                    if (mmdData.pm_frequency_id) {
                        assetData.pm_frequency_id = mmdData.pm_frequency_id;
                    }
                    
                    // Set PM schedule from model's PM frequency if available
                    if (mmdData.pm_frequency_days) {
                        assetData.pm_interval_days = mmdData.pm_frequency_days;
                        // Map PM frequency to schedule type
                        if (mmdData.pm_frequency_days === 365) {
                            assetData.pm_schedule_type = 'annually';
                        } else if (mmdData.pm_frequency_days === 180) {
                            assetData.pm_schedule_type = 'semiannually';
                        } else if (mmdData.pm_frequency_days === 90) {
                            assetData.pm_schedule_type = 'quarterly';
                        } else if (mmdData.pm_frequency_days === 30) {
                            assetData.pm_schedule_type = 'monthly';
                        } else if (mmdData.pm_frequency_days === 7) {
                            assetData.pm_schedule_type = 'weekly';
                        } else if (mmdData.pm_frequency_days === 1) {
                            assetData.pm_schedule_type = 'daily';
                        } else {
                            assetData.pm_schedule_type = 'custom';
                        }
                        
                        // Calculate next_maintenance if last_maintenance is provided
                        const lastMaintenance = formData.get('last_maintenance');
                        if (lastMaintenance) {
                            const nextDate = calculateNextMaintenanceDate(
                                assetData.pm_schedule_type,
                                lastMaintenance,
                                mmdData.pm_frequency_days
                            );
                            if (nextDate) {
                                assetData.next_maintenance = nextDate.toISOString();
                            }
                        }
                    }
                    
                    // If next_maintenance is manually entered, use that instead
                    const manualNextMaintenance = formData.get('next_maintenance');
                    if (manualNextMaintenance) {
                        assetData.next_maintenance = new Date(manualNextMaintenance).toISOString();
                    }
                } else {
                    showToast('MMD form manager not initialized. Please refresh the page.', 'error');
                    return;
                }
            }
            
            // Get image URLs from hidden input
            const imageUrlsInput = document.getElementById('asset-images-urls');
            if (imageUrlsInput && imageUrlsInput.value) {
                try {
                    assetData.image_urls = JSON.parse(imageUrlsInput.value);
                } catch (e) {
                    assetData.image_urls = assetImageUrls;
                }
            } else {
                assetData.image_urls = assetImageUrls.length > 0 ? assetImageUrls : null;
            }
            
            // Check if Supabase client is available
            if (!supabaseClient) {
                showToast('Database connection not available. Please refresh the page.', 'error');
                return;
            }
            
            try {
                if (assetId) {
                    // Update existing asset - allow model_id update
                    if (window.mmdAssetFormManager && window.mmdAssetFormManager.selectedModel) {
                        const mmdData = window.mmdAssetFormManager.getSelectedMMDData();
                        assetData.model_id = mmdData.model_id;
                    }
                    const { error } = await supabaseClient.from('assets').update(assetData).eq('id', assetId);
                    if (error) throw error;
                    showToast('Asset updated successfully', 'success');
                } else {
                    assetData.id = generateAssetId();
                    const { error } = await supabaseClient.from('assets').insert([assetData]);
                    if (error) throw error;
                    showToast('Asset created successfully', 'success');
                }
                closeAssetModal();
                await loadAssets();
            } catch (error) {
                console.error('Error saving asset:', error);
                showToast(`Failed to save asset: ${error.message}`, 'error');
            }
        });

        function getSelectOptionText(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return '';
            const option = select.selectedOptions?.[0];
            if (!option || !select.value) return '';
            return option.textContent?.trim() || '';
        }

        // Bulk Edit Functions
        let selectedAssetIds = new Set();
        let lastClickedCheckbox = null; // Track last clicked checkbox for shift+click range selection

        function toggleSelectAllAssets(checked) {
            const checkboxes = document.querySelectorAll('.asset-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = checked;
                const assetId = checkbox.getAttribute('data-asset-id');
                if (checked) {
                    selectedAssetIds.add(assetId);
                } else {
                    selectedAssetIds.delete(assetId);
                }
            });
            lastClickedCheckbox = null; // Reset last clicked when using select all
            updateBulkEditButton();
        }
        
        function handleAssetCheckboxClick(event, checkbox) {
            const assetId = checkbox.getAttribute('data-asset-id');
            const isShiftClick = event.shiftKey;
            
            if (isShiftClick && lastClickedCheckbox && lastClickedCheckbox !== checkbox) {
                // Range selection: select all checkboxes between last clicked and current
                const allCheckboxes = Array.from(document.querySelectorAll('.asset-checkbox'));
                const lastIndex = allCheckboxes.indexOf(lastClickedCheckbox);
                const currentIndex = allCheckboxes.indexOf(checkbox);
                
                if (lastIndex !== -1 && currentIndex !== -1) {
                    const startIndex = Math.min(lastIndex, currentIndex);
                    const endIndex = Math.max(lastIndex, currentIndex);
                    const targetState = checkbox.checked; // Use the state of the clicked checkbox
                    
                    // Select/deselect all checkboxes in the range
                    for (let i = startIndex; i <= endIndex; i++) {
                        const cb = allCheckboxes[i];
                        cb.checked = targetState;
                        const id = cb.getAttribute('data-asset-id');
                        if (targetState) {
                            selectedAssetIds.add(id);
                        } else {
                            selectedAssetIds.delete(id);
                        }
                    }
                }
            } else {
                // Normal click: just update this checkbox
                if (checkbox.checked) {
                    selectedAssetIds.add(assetId);
                } else {
                    selectedAssetIds.delete(assetId);
                }
            }
            
            // Update last clicked checkbox (only if not shift+click, to allow multiple ranges)
            if (!isShiftClick) {
                lastClickedCheckbox = checkbox;
            }
            
            updateBulkEditButton();
        }

        function clearAssetSelections() {
            selectedAssetIds.clear();
            document.querySelectorAll('.asset-checkbox').forEach(cb => cb.checked = false);
            const selectAllCheckbox = document.getElementById('select-all-assets');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
            lastClickedCheckbox = null; // Reset last clicked when clearing
            updateBulkEditButton();
        }

        function updateBulkEditButton() {
            const checkboxes = document.querySelectorAll('.asset-checkbox:checked');
            const selectedCount = checkboxes.length;
            const bulkEditBtn = document.getElementById('bulk-edit-btn');
            const badge = document.getElementById('selected-count-badge');
            
            if (bulkEditBtn) {
                if (selectedCount > 0) {
                    bulkEditBtn.classList.remove('hidden');
                    if (badge) badge.textContent = selectedCount;
                } else {
                    bulkEditBtn.classList.add('hidden');
                }
            }
            
            // Update selectedAssetIds set
            selectedAssetIds.clear();
            checkboxes.forEach(checkbox => {
                selectedAssetIds.add(checkbox.getAttribute('data-asset-id'));
            });
        }

        function getSelectedAssetIds() {
            return Array.from(selectedAssetIds);
        }

        function showBulkEditModal() {
            const selectedIds = getSelectedAssetIds();
            if (selectedIds.length === 0) {
                showToast('Please select at least one asset', 'warning');
                return;
            }

            const modal = document.getElementById('bulk-edit-modal');
            const countEl = document.getElementById('bulk-edit-count');
            if (countEl) countEl.textContent = selectedIds.length;
            
            // Populate location and customer dropdowns
            populateBulkEditDropdowns();
            
            // Reset form
            const form = document.getElementById('bulk-edit-form');
            if (form) form.reset();
            
            if (modal) modal.classList.add('active');
        }

        function closeBulkEditModal() {
            const modal = document.getElementById('bulk-edit-modal');
            if (modal) modal.classList.remove('active');
        }

        async function populateBulkEditDropdowns() {
            if (!supabaseClient) return;

            try {
                // Load locations
                const { data: locations } = await supabaseClient
                    .from('locations')
                    .select('id, name')
                    .eq('status', 'active')
                    .order('name');
                
                const locationSelect = document.getElementById('bulk-edit-location');
                if (locationSelect && locations) {
                    const currentValue = locationSelect.value;
                    locationSelect.innerHTML = '<option value="">-- Keep existing --</option>' +
                        locations.map(loc => `<option value="${loc.id}">${escapeHtml(loc.name)}</option>`).join('');
                    if (currentValue) locationSelect.value = currentValue;
                }

                // Load customers
                if (assetSchema.hasCustomerId) {
                    const { data: customers } = await supabaseClient
                        .from('customers')
                        .select('id, name')
                        .eq('status', 'active')
                        .order('name');
                    
                    const customerSelect = document.getElementById('bulk-edit-customer');
                    if (customerSelect && customers) {
                        const currentValue = customerSelect.value;
                        customerSelect.innerHTML = '<option value="">-- Keep existing --</option>' +
                            customers.map(cust => `<option value="${cust.id}">${escapeHtml(cust.name)}</option>`).join('');
                        if (currentValue) customerSelect.value = currentValue;
                    }
                }
            } catch (error) {
                console.error('Error loading dropdowns for bulk edit:', error);
            }
        }

        // PM schedule form was removed - maintenance dates are now saved with the main asset form
        // This code is kept for compatibility but the form submission is handled in the main asset form
        const pmScheduleForm = document.getElementById('pm-schedule-form');
        if (pmScheduleForm) {
            pmScheduleForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentAsset || !currentAsset.id) {
                    showToast('No asset selected', 'error');
                    return;
                }
                
                try {
                    const autoGenerate = document.getElementById('pm-auto-generate-wo')?.checked || false;
                    const nextMaintenance = document.getElementById('next-maintenance')?.value;
                    
                const { error: updateError } = await supabaseClient
                    .from('assets')
                    .update({
                        auto_generate_wo: autoGenerate
                    })
                    .eq('id', currentAsset.id);

                if (updateError) throw updateError;

                if (autoGenerate && nextMaintenance) {
                    const now = new Date();
                    const threshold = new Date();
                    threshold.setDate(threshold.getDate() + 7);
                    if (new Date(nextMaintenance) <= threshold) {
                        const { data: existingWorkOrders, error: woError } = await supabaseClient
                            .from('work_orders')
                            .select('id')
                            .eq('asset_id', currentAsset.id)
                            .eq('type', 'preventive_maintenance')
                            .in('status', ['open', 'in-progress'])
                            .limit(1);
                        if (woError) throw woError;
                        if (!existingWorkOrders?.length) {
                            const { error: createError } = await supabaseClient
                                .from('work_orders')
                                .insert([{
                                    asset_id: currentAsset.id,
                                    type: 'preventive_maintenance',
                                    priority: 'medium',
                                    status: 'open',
                                    due_date: nextMaintenance,
                                    description: `Auto-generated PM for ${currentAsset.name || currentAsset.id}`
                                }]);
                            if (createError) throw createError;
                            await supabaseClient
                                .from('assets')
                                .update({ pm_last_generated_at: now.toISOString() })
                                .eq('id', currentAsset.id);
                        }
                    }
                }

                showToast('PM schedule saved successfully.', 'success');
                await loadAssets();
                await loadAssetWorkOrders(currentAsset.id);
                closeAssetModal();
            } catch (error) {
                showToast(`Failed to save PM schedule: ${error.message}`, 'error');
            }
        });
        }

        function generateAssetId() {
            const today = new Date();
            const dateStamp = today.toISOString().split('T')[0].replace(/-/g, '');
            const randomPart = Math.random().toString(36).slice(2, 6).toUpperCase();
            return `AST-${dateStamp}-${randomPart}`;
        }

        // Handle bulk edit form submission
        document.addEventListener('DOMContentLoaded', () => {
            const bulkEditForm = document.getElementById('bulk-edit-form');
            if (bulkEditForm) {
                bulkEditForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const selectedIds = getSelectedAssetIds();
                    if (selectedIds.length === 0) {
                        showToast('No assets selected', 'warning');
                        return;
                    }

                    if (!supabaseClient) {
                        showToast('Database connection not available. Please refresh the page.', 'error');
                        return;
                    }

                    const formData = new FormData(e.target);
                    const updateData = {};

                    // Only include fields that have values
                    const status = formData.get('status');
                    if (status) updateData.status = status;

                    const locationId = formData.get('location_id');
                    if (locationId) updateData.location_id = locationId;

                    const customerId = formData.get('customer_id');
                    if (customerId) updateData.customer_id = customerId;

                    const lastMaintenance = formData.get('last_maintenance');
                    if (lastMaintenance) {
                        updateData.last_maintenance = new Date(lastMaintenance).toISOString();
                    }

                    const nextMaintenance = formData.get('next_maintenance');
                    if (nextMaintenance) {
                        updateData.next_maintenance = new Date(nextMaintenance).toISOString();
                    }

                    const warrantyExpiry = formData.get('warranty_expiry');
                    if (warrantyExpiry) {
                        updateData.warranty_expiry = new Date(warrantyExpiry).toISOString();
                    }

                    // Check if any fields were filled
                    if (Object.keys(updateData).length === 0) {
                        showToast('Please fill in at least one field to update', 'warning');
                        return;
                    }

                    try {
                        showToast(`Updating ${selectedIds.length} asset(s)...`, 'info');
                        
                        // Update all selected assets
                        const { error } = await supabaseClient
                            .from('assets')
                            .update(updateData)
                            .in('id', selectedIds);

                        if (error) throw error;

                        showToast(`Successfully updated ${selectedIds.length} asset(s)`, 'success');
                        
                        // Clear selections
                        selectedAssetIds.clear();
                        document.querySelectorAll('.asset-checkbox').forEach(cb => cb.checked = false);
                        const selectAllCheckbox = document.getElementById('select-all-assets');
                        if (selectAllCheckbox) selectAllCheckbox.checked = false;
                        updateBulkEditButton();
                        
                        // Close modal and refresh assets
                        closeBulkEditModal();
                        await loadAssets();
                    } catch (error) {
                        console.error('Error updating assets:', error);
                        showToast(`Failed to update assets: ${error.message}`, 'error');
                    }
                });
            }
        });

        function setupEventListeners() {
            // Add event delegation for asset clicks (more reliable than inline onclick)
            const listBody = document.getElementById('assets-list-body');
            const grid = document.getElementById('assets-grid');
            
            if (listBody) {
                listBody.addEventListener('click', (e) => {
                    const row = e.target.closest('tr[data-asset-id]');
                    if (row && !e.target.closest('button')) {
                        const assetId = row.getAttribute('data-asset-id');
                        if (assetId) {
                            viewAssetById(assetId);
                        }
                    }
                });
            }
            
            if (grid) {
                grid.addEventListener('click', (e) => {
                    const card = e.target.closest('[data-asset-id]');
                    if (card && !e.target.closest('button')) {
                        const assetId = card.getAttribute('data-asset-id');
                        if (assetId) {
                            viewAssetById(assetId);
                        }
                    }
                });
            }
            
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('input', debounce((e) => {
                    const term = e.target.value.toLowerCase();
                    filteredAssets = allAssets.filter(a => a.name?.toLowerCase().includes(term) || a.serial_number?.toLowerCase().includes(term));
                    renderAssets();
                }, 300));
            }
            const categoryFilter = document.getElementById('category-filter');
            const statusFilter = document.getElementById('status-filter');
            const customerSelect = document.getElementById('customer-select');
            const categorySelect = document.getElementById('category-select');
            
            // Add event listener to customer dropdown to filter locations
            if (customerSelect) {
                customerSelect.addEventListener('change', (e) => {
                    const selectedCustomerId = e.target.value;
                    updateLocationDropdown(selectedCustomerId || null);
                    
                    // Clear location selection if customer changed
                    const locationSelect = document.getElementById('location-select');
                    if (locationSelect) {
                        locationSelect.value = '';
                    }
                });
            }
            const manufacturerSelect = document.getElementById('manufacturer-select');
            const pmScheduleType = document.getElementById('pm-schedule-type');
            const pmIntervalDays = document.getElementById('pm-interval-days');
            const lastMaintenance = document.getElementById('last-maintenance');
            
            if (categoryFilter) categoryFilter.addEventListener('change', applyFilters);
            if (statusFilter) statusFilter.addEventListener('change', applyFilters);
            if (customerSelect) {
                customerSelect.addEventListener('change', (e) => {
                    const selectedCustomerId = e.target.value || null;
                    updateLocationDropdown(selectedCustomerId);
                    
                    // Clear location selection when customer changes
                    const locationSelect = document.getElementById('location-select');
                    if (locationSelect) {
                        locationSelect.value = '';
                    }
                });
            }
            
            // Only add listeners for old category/manufacturer selects if they exist (for backward compatibility)
            if (categorySelect) {
                categorySelect.addEventListener('change', (e) => {
                    if (typeof updateManufacturerOptions === 'function') {
                updateManufacturerOptions(e.target.value);
                    }
            });
            }
            if (manufacturerSelect) {
                manufacturerSelect.addEventListener('change', (e) => {
                    if (typeof updateModelOptions === 'function') {
                updateModelOptions(e.target.value);
                    }
                });
            }
            
            // PM schedule elements were removed - PM frequency now comes from MMD selection
            // Only keep the lastMaintenance listener for calculating next_maintenance
            if (lastMaintenance) {
                lastMaintenance.addEventListener('change', () => {
                    if (typeof calculateNextMaintenance === 'function') {
                        calculateNextMaintenance();
                    }
                });
            }
            
            // Device configuration selector
            const configSelect = document.getElementById('device-config-select');
            if (configSelect) {
                configSelect.addEventListener('change', function() {
                    applyDeviceConfiguration(this.value);
                });
            }
        }

        function applyFilters() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const category = document.getElementById('category-filter').value;
            const status = document.getElementById('status-filter').value;
            const selectedCategoryName = category ? referenceMaps.categoriesById.get(category)?.name : '';
            filteredAssets = allAssets.filter(a => {
                const matchesTerm = !term || a.name?.toLowerCase().includes(term);
                const matchesCat = !category || a.category_id === category || (selectedCategoryName && a.category === selectedCategoryName);
                const matchesStat = !status || a.status === status;
                return matchesTerm && matchesCat && matchesStat;
            });
            currentPage = 1; // Reset to first page when filters change
            renderAssets();
        }

        function exportToCSV() {
            if (!filteredAssets || filteredAssets.length === 0) {
                showToast('No assets to export', 'warning');
                return;
            }
            
            const formatDate = (date) => {
                if (!date) return '';
                try {
                    return new Date(date).toISOString().split('T')[0];
                } catch {
                    return String(date);
                }
            };
            
            const headers = ['Name', 'Category', 'Status', 'Serial Number', 'Manufacturer', 'Model', 'Customer', 'Location', 'Purchase Date', 'Purchase Cost', 'Last PM', 'Next PM'];
            const rows = filteredAssets.map(a => [
                a.name || '',
                a.category || '',
                a.status || '',
                a.serial_number || '',
                a.manufacturer || '',
                a.model || '',
                a.customers?.name || a.customer_id || '',
                a.locations?.name || a.location_id || '',
                formatDate(a.purchase_date),
                a.purchase_cost || '0',
                formatDate(a.last_maintenance),
                formatDate(a.next_maintenance)
            ]);
            
            // Properly escape CSV values
            const escapeCSV = (value) => {
                const str = String(value);
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return `"${str.replace(/"/g, '""')}"`;
                }
                return str;
            };
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(escapeCSV).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `assets_export_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast(`Exported ${filteredAssets.length} assets`, 'success');
        }

        function showBulkImportModal() {
            document.getElementById('bulk-import-modal').classList.add('active');
        }

        function closeBulkImportModal() {
            document.getElementById('bulk-import-modal').classList.remove('active');
            csvData = null;
            csvHeaders = [];
            csvSampleRow = {};
            columnMapping = {};
            document.getElementById('import-step-1').style.display = 'block';
            document.getElementById('import-step-2').style.display = 'none';
            document.getElementById('import-step-3').style.display = 'none';
        }

        function closeAddColumnModal() {
            document.getElementById('add-column-modal').classList.remove('active');
            document.getElementById('add-column-form').reset();
        }

        function showAddColumnModal() {
            document.getElementById('add-column-modal').classList.add('active');
        }

        async function handleAddColumn(event) {
            event.preventDefault();
            const columnName = document.getElementById('new-column-name').value.trim();
            const columnType = document.getElementById('new-column-type').value;
            const defaultValue = document.getElementById('new-column-default').value.trim();
            const nullable = document.getElementById('new-column-nullable').checked;
            const description = document.getElementById('new-column-description').value.trim();

            if (!supabaseClient) {
                showToast('Database not connected', 'error');
                return;
            }

            try {
                // Map JavaScript types to PostgreSQL types
                const pgTypeMap = {
                    'text': 'TEXT',
                    'integer': 'INTEGER',
                    'numeric': 'NUMERIC',
                    'date': 'DATE',
                    'timestamp': 'TIMESTAMP WITHOUT TIME ZONE',
                    'boolean': 'BOOLEAN'
                };

                const pgType = pgTypeMap[columnType] || 'TEXT';
                let sql = `ALTER TABLE public.assets ADD COLUMN IF NOT EXISTS ${columnName} ${pgType}`;
                
                if (!nullable) {
                    sql += ' NOT NULL';
                }
                
                if (defaultValue) {
                    // Handle different default value types
                    if (columnType === 'text') {
                        sql += ` DEFAULT '${defaultValue.replace(/'/g, "''")}'`;
                    } else if (columnType === 'boolean') {
                        sql += ` DEFAULT ${defaultValue.toLowerCase() === 'true' ? 'TRUE' : 'FALSE'}`;
                    } else {
                        sql += ` DEFAULT ${defaultValue}`;
                    }
                }

                // Execute SQL via Supabase RPC or direct SQL
                const { error } = await supabaseClient.rpc('execute_sql', { sql_query: sql });
                
                if (error) {
                    // If RPC doesn't exist, try direct SQL execution
                    // Note: This requires proper permissions
                    throw error;
                }

                showToast(`Column "${columnName}" added successfully!`, 'success');
                closeAddColumnModal();
                
                // Reload database columns and refresh mapping
                await loadDatabaseColumns();
                if (csvHeaders.length > 0) {
                    renderColumnMapping();
                }
            } catch (error) {
                console.error('Error adding column:', error);
                // Try alternative method using migration
                showToast(`Adding column via migration...`, 'info');
                
                // Create a migration SQL
                const migrationSQL = `
                    ALTER TABLE public.assets 
                    ADD COLUMN IF NOT EXISTS ${columnName} ${pgTypeMap[columnType] || 'TEXT'}
                    ${!nullable ? ' NOT NULL' : ''}
                    ${defaultValue ? ` DEFAULT ${columnType === 'text' ? `'${defaultValue.replace(/'/g, "''")}'` : defaultValue}` : ''};
                `;
                
                // Store migration for user to run manually
                const migrationBlob = new Blob([migrationSQL], { type: 'text/plain' });
                const url = URL.createObjectURL(migrationBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `add_column_${columnName}.sql`;
                a.click();
                URL.revokeObjectURL(url);
                
                showToast(`Column migration SQL downloaded. Please run it in Supabase SQL Editor, then refresh.`, 'warning');
            }
        }

        async function loadDatabaseColumns() {
            if (!supabaseClient) return;
            
            try {
                // Get column information from information_schema
                const { data, error } = await supabaseClient.rpc('get_table_columns', { 
                    table_name: 'assets',
                    schema_name: 'public'
                }).catch(() => ({ data: null, error: { message: 'RPC function not available' } }));

                if (error) {
                    // RPC function may not exist - this is expected, use fallback
                    // Silently fall back to known columns without logging error
                    // Suppress console error for missing RPC function
                    databaseColumns = [
                        { name: 'name', type: 'text', nullable: true },
                        { name: 'category', type: 'text', nullable: true },
                        { name: 'manufacturer', type: 'text', nullable: true },
                        { name: 'model', type: 'text', nullable: true },
                        { name: 'serial_number', type: 'text', nullable: true },
                        { name: 'status', type: 'text', nullable: true },
                        { name: 'location', type: 'text', nullable: true },
                        { name: 'description', type: 'text', nullable: true },
                        { name: 'purchase_date', type: 'timestamp', nullable: true },
                        { name: 'purchase_cost', type: 'numeric', nullable: true },
                        { name: 'warranty_expiry', type: 'timestamp', nullable: true },
                        { name: 'customer_id', type: 'text', nullable: true },
                        { name: 'location_id', type: 'text', nullable: true },
                        { name: 'last_maintenance', type: 'timestamp', nullable: true },
                        { name: 'next_maintenance', type: 'timestamp', nullable: true },
                        { name: 'depreciation_method', type: 'text', nullable: true },
                        { name: 'useful_life_years', type: 'integer', nullable: true },
                        { name: 'salvage_value', type: 'numeric', nullable: true },
                        { name: 'depreciation_start_date', type: 'date', nullable: true }
                    ];
                } else {
                    databaseColumns = data || [];
                    // Ensure critical columns are present even if not returned by RPC
                    const criticalColumns = [
                        { name: 'last_maintenance', type: 'timestamp', nullable: true },
                        { name: 'next_maintenance', type: 'timestamp', nullable: true }
                    ];
                    criticalColumns.forEach(critCol => {
                        if (!databaseColumns.find(c => c.name === critCol.name)) {
                            databaseColumns.push(critCol);
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading database columns:', error);
                // Use fallback columns
                databaseColumns = [
                    { name: 'name', type: 'text', nullable: true },
                    { name: 'category', type: 'text', nullable: true },
                    { name: 'manufacturer', type: 'text', nullable: true },
                    { name: 'model', type: 'text', nullable: true },
                    { name: 'serial_number', type: 'text', nullable: true },
                    { name: 'status', type: 'text', nullable: true },
                    { name: 'location', type: 'text', nullable: true },
                    { name: 'description', type: 'text', nullable: true },
                    { name: 'purchase_date', type: 'timestamp', nullable: true },
                    { name: 'purchase_cost', type: 'numeric', nullable: true },
                    { name: 'warranty_expiry', type: 'timestamp', nullable: true },
                    { name: 'customer_id', type: 'text', nullable: true },
                    { name: 'location_id', type: 'text', nullable: true },
                    { name: 'last_maintenance', type: 'timestamp', nullable: true },
                    { name: 'next_maintenance', type: 'timestamp', nullable: true }
                ];
            }
        }

        function renderColumnMapping() {
            const tableBody = document.getElementById('column-mapping-table');
            tableBody.innerHTML = '';

            csvHeaders.forEach(csvHeader => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200';
                
                // CSV Column
                const csvCell = document.createElement('td');
                csvCell.className = 'p-2';
                csvCell.textContent = csvHeader;
                row.appendChild(csvCell);
                
                // Sample Value
                const sampleCell = document.createElement('td');
                sampleCell.className = 'p-2 text-gray-600 text-xs';
                const sampleValue = csvSampleRow[csvHeader] || '';
                sampleCell.textContent = sampleValue.length > 30 ? sampleValue.substring(0, 30) + '...' : sampleValue;
                row.appendChild(sampleCell);
                
                // Map To Database Column
                const mapCell = document.createElement('td');
                mapCell.className = 'p-2';
                const select = document.createElement('select');
                select.className = 'form-input text-sm w-full';
                select.id = `map-${csvHeader}`;
                
                // Add "Skip" option
                const skipOption = document.createElement('option');
                skipOption.value = '';
                skipOption.textContent = '-- Skip Column --';
                select.appendChild(skipOption);
                
                // Add database columns
                databaseColumns.forEach(dbCol => {
                    const option = document.createElement('option');
                    option.value = dbCol.name;
                    option.textContent = `${dbCol.name} (${dbCol.type})`;
                    
                    // Auto-map if names match (case-insensitive)
                    if (csvHeader.toLowerCase() === dbCol.name.toLowerCase() || 
                        csvHeader.toLowerCase().replace(/[^a-z0-9]/g, '_') === dbCol.name.toLowerCase()) {
                        option.selected = true;
                        columnMapping[csvHeader] = dbCol.name;
                    }
                    
                    select.appendChild(option);
                });
                
                select.addEventListener('change', (e) => {
                    if (e.target.value) {
                        columnMapping[csvHeader] = e.target.value;
                    } else {
                        delete columnMapping[csvHeader];
                    }
                });
                
                mapCell.appendChild(select);
                row.appendChild(mapCell);
                
                // Data Type
                const typeCell = document.createElement('td');
                typeCell.className = 'p-2 text-xs text-gray-500';
                const mappedCol = databaseColumns.find(c => c.name === columnMapping[csvHeader]);
                typeCell.textContent = mappedCol ? mappedCol.type : 'N/A';
                
                // Update type when selection changes
                select.addEventListener('change', () => {
                    const selectedCol = databaseColumns.find(c => c.name === select.value);
                    typeCell.textContent = selectedCol ? selectedCol.type : 'N/A';
                });
                
                row.appendChild(typeCell);
                tableBody.appendChild(row);
            });
        }

        function backToStep1() {
            document.getElementById('import-step-1').style.display = 'block';
            document.getElementById('import-step-2').style.display = 'none';
        }

        function proceedToPreview() {
            // Validate that at least name is mapped
            if (!columnMapping || Object.keys(columnMapping).length === 0) {
                showToast('Please map at least one column (name is required)', 'error');
                return;
            }
            
            // Check if name is mapped
            const nameMapped = Object.values(columnMapping).includes('name');
            if (!nameMapped) {
                showToast('The "name" column must be mapped to import assets', 'error');
                return;
            }
            
            document.getElementById('import-step-2').style.display = 'none';
            document.getElementById('import-step-3').style.display = 'block';
            
            // Show preview with mapped columns
            const mappedCount = Object.keys(columnMapping).length;
            const previewHtml = `
                <p class="font-semibold mb-2">Found ${csvData.length} assets to import</p>
                <p class="text-sm text-gray-600 mb-2">${mappedCount} column(s) mapped</p>
                <div class="text-sm mb-2"><strong>Mapped columns:</strong> ${Object.entries(columnMapping).map(([csv, db]) => `${csv} â†’ ${db}`).join(', ')}</div>
                <div class="text-sm"><strong>First record:</strong> ${csvData[0] ? Object.entries(columnMapping).map(([csv, db]) => `${db}: ${csvData[0][csv] || 'N/A'}`).join(', ') : 'N/A'}</div>
            `;
            document.getElementById('preview-content').innerHTML = previewHtml;
        }

        function backToStep2() {
            document.getElementById('import-step-2').style.display = 'block';
            document.getElementById('import-step-3').style.display = 'none';
        }

        function downloadTemplate() {
            // Updated template with MMD fields (Type, Make, Model) instead of old category/manufacturer/model
            const template = 'name,serial_number,status,equipment_type,equipment_make,equipment_model,last_maintenance,next_maintenance,purchase_date,purchase_cost,warranty_expiry,customer_id,location_id,description\n"MRI Scanner","SN123456","active","Diagnostic","GE Healthcare","Signa HDxt","2024-01-15","2025-01-15","2020-01-15","2500000","2029-01-15","","","High-field MRI system"';
            const blob = new Blob([template], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'asset_import_template.csv';
            a.click();
        }

        function setupDragDrop() {
            const dropZone = document.getElementById('drop-zone');
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                const file = e.dataTransfer.files[0];
                if (file && file.type === 'text/csv') {
                    handleFile(file);
                } else {
                    showToast('Please drop a CSV file', 'error');
                }
            });
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) handleFile(file);
        }

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                await parseCSV(text);
            };
            reader.readAsText(file);
        }

        async function parseCSV(text) {
            // Handle CSV with proper quote handling
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                showToast('CSV file must have at least a header row and one data row', 'error');
                return;
            }
            
            // Parse header row (handle quoted values)
            const parseCSVLine = (line) => {
                const result = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            };
            
            const headers = parseCSVLine(lines[0]).map(h => h.trim().replace(/^"|"$/g, ''));
            const rows = lines.slice(1).filter(line => line.trim()).map(line => {
                const values = parseCSVLine(line).map(v => v.trim().replace(/^"|"$/g, ''));
                const obj = {};
                headers.forEach((header, i) => { 
                    obj[header] = values[i] || ''; 
                });
                return obj;
            });
            
            csvData = rows;
            csvHeaders = headers;
            csvSampleRow = rows[0] || {};
            columnMapping = {};
            
            // Load database columns and show mapping interface
            await loadDatabaseColumns();
            
            // Auto-map common column names
            headers.forEach(header => {
                const normalized = header.toLowerCase().replace(/[^a-z0-9]/g, '_');
                const match = databaseColumns.find(col => 
                    col.name.toLowerCase() === normalized ||
                    col.name.toLowerCase() === header.toLowerCase()
                );
                if (match) {
                    columnMapping[header] = match.name;
                }
            });
            
            // Show step 2 (column mapping)
            document.getElementById('import-step-1').style.display = 'none';
            document.getElementById('import-step-2').style.display = 'block';
            renderColumnMapping();
        }

        function cancelImport() {
            csvData = null;
            csvHeaders = [];
            csvSampleRow = {};
            columnMapping = {};
            document.getElementById('import-step-1').style.display = 'block';
            document.getElementById('import-step-2').style.display = 'none';
            document.getElementById('import-step-3').style.display = 'none';
        }

        async function confirmImport() {
            if (!csvData || csvData.length === 0) {
                showToast('No data to import', 'error');
                return;
            }
            if (!supabaseClient) {
                showToast('Database not connected', 'error');
                return;
            }
            
            try {
                showToast('Processing import...', 'info');
                
                // Load reference data for lookups (MMD hierarchy)
                const { data: types } = await supabaseClient.from('equipment_types').select('id, name').is('deleted_at', null);
                const { data: makes } = await supabaseClient.from('equipment_makes').select('id, name, type_id').is('deleted_at', null);
                const { data: models } = await supabaseClient.from('equipment_models').select('id, name, make_id').is('deleted_at', null);
                const { data: customers } = await supabaseClient.from('customers').select('id, name');
                const { data: locations } = await supabaseClient.from('locations').select('id, name');
                
                // Create lookup maps for MMD hierarchy
                const typeMap = new Map((types || []).map(t => [t.name.toLowerCase().trim(), t.id]));
                const makeMap = new Map((makes || []).map(m => [`${m.type_id}_${m.name.toLowerCase().trim()}`, m.id]));
                const modelMap = new Map((models || []).map(m => [`${m.make_id}_${m.name.toLowerCase().trim()}`, m.id]));
                const customerMap = new Map((customers || []).map(c => [c.name.toLowerCase().trim(), c.id]));
                const locationMap = new Map((locations || []).map(l => [l.name.toLowerCase().trim(), l.id]));
                
                // Helper function to get value from row with multiple possible keys
                const getValue = (row, ...keys) => {
                    for (const key of keys) {
                        if (row[key] !== undefined && row[key] !== null && row[key] !== '') {
                            return row[key];
                        }
                    }
                    return '';
                };
                
                // Transform CSV data using column mapping
                const transformedData = csvData.map((row, index) => {
                    const asset = {};
                    
                    // Use column mapping to transform data
                    Object.entries(columnMapping).forEach(([csvCol, dbCol]) => {
                        const value = row[csvCol];
                        if (value !== undefined && value !== null && value !== '') {
                            // Handle different data types
                            const dbColumn = databaseColumns.find(c => c.name === dbCol);
                            if (dbColumn) {
                                if (dbColumn.type === 'integer' || dbColumn.type === 'numeric') {
                                    const numValue = parseFloat(value);
                                    asset[dbCol] = isNaN(numValue) ? null : numValue;
                                } else if (dbColumn.type === 'date' || dbColumn.type === 'timestamp') {
                                    try {
                                        const date = new Date(value);
                                        if (!isNaN(date.getTime())) {
                                            asset[dbCol] = dbColumn.type === 'date' 
                                                ? date.toISOString().split('T')[0]
                                                : date.toISOString();
                                        }
                                    } catch (e) {
                                        // Invalid date, skip
                                    }
                                } else if (dbColumn.type === 'boolean') {
                                    asset[dbCol] = value.toLowerCase() === 'true' || value === '1' || value.toLowerCase() === 'yes';
                                } else {
                                    asset[dbCol] = value;
                                }
                            } else {
                                asset[dbCol] = value;
                            }
                        }
                    });
                    
                    // Skip if no name
                    if (!asset.name) {
                        return null;
                    }
                    
                    // Map customer name to ID if customer_id is mapped
                    if (asset.customer_id && !asset.customer_id.match(/^[A-Z0-9-]+$/)) {
                        // Looks like a name, try to map it
                        const customerName = asset.customer_id.toLowerCase();
                        asset.customer_id = customerMap.get(customerName) || asset.customer_id;
                    }
                    
                    // Map location name to ID if location_id is mapped
                    if (asset.location_id && !asset.location_id.match(/^[A-Z0-9-]+$/)) {
                        // Looks like a name, try to map it
                        const locationName = asset.location_id.toLowerCase();
                        asset.location_id = locationMap.get(locationName) || asset.location_id;
                    }
                    
                    // Handle MMD fields: equipment_type, equipment_make, equipment_model -> model_id
                    const equipmentType = getValue(row, 'equipment_type', 'type', 'equipment_type_name');
                    const equipmentMake = getValue(row, 'equipment_make', 'make', 'equipment_make_name');
                    const equipmentModel = getValue(row, 'equipment_model', 'model', 'equipment_model_name');
                    
                    if (equipmentType && equipmentMake && equipmentModel) {
                        const typeName = equipmentType.toLowerCase().trim();
                        const makeName = equipmentMake.toLowerCase().trim();
                        const modelName = equipmentModel.toLowerCase().trim();
                        
                        const typeId = typeMap.get(typeName);
                        if (typeId) {
                            const makeKey = `${typeId}_${makeName}`;
                            const makeId = makeMap.get(makeKey);
                            if (makeId) {
                                const modelKey = `${makeId}_${modelName}`;
                                const modelId = modelMap.get(modelKey);
                                if (modelId) {
                                    asset.model_id = modelId;
                                } else {
                                    console.warn(`Model not found: ${equipmentModel} for make ${equipmentMake}`);
                                }
                            } else {
                                console.warn(`Make not found: ${equipmentMake} for type ${equipmentType}`);
                            }
                        } else {
                            console.warn(`Type not found: ${equipmentType}`);
                        }
                    }
                    
                    // Calculate next_maintenance from last_maintenance if model_id is set
                    // Note: We'll do this after all assets are processed to avoid nested async
                    if (asset.model_id && asset.last_maintenance && !asset.next_maintenance) {
                        // Store model_id for later PM frequency lookup
                        asset._needsPMCalculation = true;
                    }
                    
                    // Set defaults
                    if (!asset.status) asset.status = 'active';
                    if (asset.auto_generate_wo === undefined) asset.auto_generate_wo = true;
                    
                    return asset;
                });
                
                // Filter out null/empty rows
                const validAssets = transformedData.filter(asset => asset && asset.name);
                
                if (validAssets.length === 0) {
                    showToast('No valid data to import', 'error');
                    return;
                }
                
                // Calculate next_maintenance for assets that need it
                for (const asset of validAssets) {
                    if (asset._needsPMCalculation && asset.model_id && asset.last_maintenance) {
                        try {
                            const { data: modelWithFreq } = await supabaseClient
                                .from('equipment_models')
                                .select('pm_frequency_id, pm_frequencies:pm_frequency_id(days)')
                                .eq('id', asset.model_id)
                                .single();
                            
                            if (modelWithFreq?.pm_frequencies?.days) {
                                const pmDays = modelWithFreq.pm_frequencies.days;
                                const lastDate = new Date(asset.last_maintenance);
                                const nextDate = new Date(lastDate);
                                nextDate.setDate(nextDate.getDate() + pmDays);
                                asset.next_maintenance = nextDate.toISOString();
                            }
                        } catch (e) {
                            console.warn('Could not calculate next_maintenance for asset:', asset.name, e);
                        }
                        delete asset._needsPMCalculation;
                    }
                }
                
                // Separate assets into new and existing for upsert
                const assetsToInsert = [];
                const assetsToUpdate = [];
                let updated = 0;
                let imported = 0;
                let errors = [];
                
                // Get all existing assets in one query for efficient lookup
                const assetIds = validAssets.filter(a => a.id).map(a => a.id);
                const assetNames = validAssets.filter(a => a.name && !a.id).map(a => a.name.toLowerCase().trim());
                
                const existingAssetsMap = new Map();
                
                // Query by IDs
                if (assetIds.length > 0) {
                    const { data: existingById } = await supabaseClient
                        .from('assets')
                        .select('id, name')
                        .in('id', assetIds)
                        .is('deleted_at', null);
                    
                    if (existingById) {
                        existingById.forEach(a => existingAssetsMap.set(a.id, a));
                    }
                }
                
                // Query by names (case-insensitive)
                if (assetNames.length > 0) {
                    // Query all non-deleted assets and filter in memory (Supabase doesn't support case-insensitive IN)
                    const { data: allAssets } = await supabaseClient
                        .from('assets')
                        .select('id, name')
                        .is('deleted_at', null);
                    
                    if (allAssets) {
                        allAssets.forEach(a => {
                            const nameLower = (a.name || '').toLowerCase().trim();
                            if (assetNames.includes(nameLower) && !existingAssetsMap.has(a.id)) {
                                existingAssetsMap.set(nameLower, a);
                            }
                        });
                    }
                }
                
                // Categorize assets
                for (const asset of validAssets) {
                    let shouldUpdate = false;
                    
                    if (asset.id && existingAssetsMap.has(asset.id)) {
                        shouldUpdate = true;
                    } else if (asset.name && !asset.id) {
                        const nameLower = asset.name.toLowerCase().trim();
                        const existing = existingAssetsMap.get(nameLower);
                        if (existing) {
                            asset.id = existing.id;
                            shouldUpdate = true;
                        }
                    }
                    
                    if (shouldUpdate) {
                        assetsToUpdate.push(asset);
                    } else {
                        assetsToInsert.push(asset);
                    }
                }
                
                // Update existing assets in batches
                if (assetsToUpdate.length > 0) {
                    const batchSize = 50;
                    for (let i = 0; i < assetsToUpdate.length; i += batchSize) {
                        const batch = assetsToUpdate.slice(i, i + batchSize);
                        // Use upsert for better performance (handles both insert and update)
                        const upsertData = batch.map(asset => {
                            const { id, ...updateData } = asset;
                            return { id, ...updateData };
                        });
                        
                        try {
                            const { error } = await supabaseClient
                                .from('assets')
                                .upsert(upsertData, { onConflict: 'id' });
                            
                            if (error) {
                                errors.push(`Update batch ${Math.floor(i/batchSize) + 1}: ${error.message}`);
                            } else {
                                updated += batch.length;
                            }
                        } catch (e) {
                            errors.push(`Update batch ${Math.floor(i/batchSize) + 1}: ${e.message}`);
                        }
                    }
                }
                
                // Insert new assets in batches
                if (assetsToInsert.length > 0) {
                    const batchSize = 50;
                    for (let i = 0; i < assetsToInsert.length; i += batchSize) {
                        const batch = assetsToInsert.slice(i, i + batchSize);
                        // Generate IDs for assets that don't have them
                        batch.forEach(asset => {
                            if (!asset.id) {
                                asset.id = generateAssetId();
                            }
                        });
                        
                        const { error } = await supabaseClient.from('assets').insert(batch);
                        if (error) {
                            errors.push(`Batch ${Math.floor(i/batchSize) + 1}: ${error.message}`);
                        } else {
                            imported += batch.length;
                        }
                    }
                }
                
                // Show results
                const totalProcessed = imported + updated;
                if (errors.length > 0) {
                    showToast(`Import completed with errors: ${imported} new, ${updated} updated, ${errors.length} error(s)`, 'warning');
                    console.error('Import errors:', errors);
                } else {
                    showToast(`Successfully processed ${totalProcessed} assets (${imported} new, ${updated} updated)`, 'success');
                }
                
                closeBulkImportModal();
                await loadAssets();
            } catch (error) {
                console.error('Import error:', error);
                showToast(`Import failed: ${error.message}`, 'error');
            }
        }

        // Device Configuration Functions
        async function loadDeviceConfigurations() {
            try {
                // deviceConfigurations is already declared at the top of the script
                const { data, error } = await supabaseClient
                    .from('device_configurations')
                    .select(`
                        *,
                        device_categories:category_id(id, name),
                        device_makes:make_id(id, name),
                        device_models:model_id(id, name),
                        pm_frequencies:pm_frequency_id(id, name, code, days)
                    `)
                    .eq('is_active', true)
                    .order('name');

                if (error) {
                    console.warn('Error loading device configurations:', error);
                    deviceConfigurations = [];
                return;
            }
                
                deviceConfigurations = data || [];

                const select = document.getElementById('device-config-select');
                if (select) {
                    select.innerHTML = '<option value="">Select a Device Configuration (or fill manually below)</option>' +
                        deviceConfigurations.map(config => {
                            const type = config.device_categories?.name || '';
                            const make = config.device_makes?.name || '';
                            const model = config.device_models?.name || '';
                            const freq = config.pm_frequencies ? ` - ${config.pm_frequencies.name} PM` : '';
                            return `<option value="${config.id}">${config.name || `${make} ${model} ${type}${freq}`}</option>`;
                        }).join('');
                }
            } catch (error) {
                console.error('Error loading device configurations:', error);
                deviceConfigurations = [];
            }
        }

        function applyDeviceConfiguration(configId) {
            if (!configId || !deviceConfigurations || deviceConfigurations.length === 0) return;

            const config = deviceConfigurations.find(c => c.id === configId);
            if (!config) return;

            // Apply to MMD form if available
            if (window.mmdAssetFormManager) {
                // Set MMD selections
                const typeSelect = document.getElementById('equipment-type-select');
                const makeSelect = document.getElementById('equipment-make-select');
                const modelSelect = document.getElementById('equipment-model-select');
                
                if (config.category_id && typeSelect) {
                    typeSelect.value = config.category_id;
                    if (window.mmdAssetFormManager.updateMakeDropdown) {
                        window.mmdAssetFormManager.updateMakeDropdown(config.category_id);
                    }
                    
                    if (config.make_id && makeSelect) {
                        setTimeout(() => {
                            makeSelect.value = config.make_id;
                            if (window.mmdAssetFormManager.updateModelDropdown) {
                                window.mmdAssetFormManager.updateModelDropdown(config.make_id);
                            }
                            
                            if (config.model_id && modelSelect) {
                                setTimeout(() => {
                                    modelSelect.value = config.model_id;
                                    if (window.mmdAssetFormManager.updatePMFrequencyDisplay) {
                                        window.mmdAssetFormManager.updatePMFrequencyDisplay(config.model_id);
                                    }
                                }, 200);
                            }
                        }, 100);
                    }
                }
            }
            
            // Legacy support for old form fields (if they exist)
            const categorySelect = document.getElementById('category-select');
            const manufacturerSelect = document.getElementById('manufacturer-select');
            const modelSelect = document.getElementById('model-select');
            
            if (config.category_id && categorySelect) {
                categorySelect.value = config.category_id;
                if (typeof updateManufacturerOptions === 'function') {
                    updateManufacturerOptions(config.category_id);
                }
            }

            if (config.make_id && manufacturerSelect) {
                setTimeout(() => {
                    manufacturerSelect.value = config.make_id;
                    if (typeof updateModelOptions === 'function') {
                        updateModelOptions(config.make_id);
                    }
                }, 100);
            }

            if (config.model_id && modelSelect) {
                setTimeout(() => {
                    modelSelect.value = config.model_id;
                }, 200);
            }

            // Apply PM frequency if available
            if (config.pm_frequency_id && config.pm_frequencies) {
                const freq = config.pm_frequencies;
                const pmSelect = document.getElementById('pm-schedule-type');
                if (pmSelect) {
                    // Find matching PM frequency code or use custom
                    const matchingOption = Array.from(pmSelect.options).find(opt => {
                        const optFreq = referenceMaps.pmFrequenciesByCode.get(opt.value);
                        return optFreq && optFreq.days === freq.days;
                    });

                    if (matchingOption) {
                        pmSelect.value = matchingOption.value;
                    } else {
                        pmSelect.value = 'custom';
                        document.getElementById('custom-interval-wrapper').style.display = 'block';
                        document.getElementById('pm-interval-days').value = freq.days;
                    }
                    updatePMPreview();
                }
            }

            // Show success message
            if (typeof showToast === 'function') {
                showToast('Device configuration applied successfully', 'success');
            }
        }

        function switchTab(tab) {
            const button = document.querySelector(`.tab-button[onclick*="${tab}"]`);
            if (!button) return; // Tab doesn't exist
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            button.classList.add('active');
            const tabContent = document.getElementById(`${tab}-tab`);
            if (tabContent) {
                tabContent.classList.add('active');
            }
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('assets-grid').style.display = show ? 'none' : 'grid';
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `<div class="flex items-center gap-3"><i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i><span>${message}</span></div>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }
        
        // Column Visibility Functions
        let draggedColumnId = null;
        let draggedOverElement = null;
        
        function showColumnVisibilityModal() {
            const modal = document.getElementById('column-visibility-modal');
            const list = document.getElementById('column-visibility-list');
            if (!modal || !list) return;
            
            // Create a map of columns by ID for quick lookup
            const columnMap = {};
            availableColumns.forEach(col => {
                columnMap[col.id] = col;
            });
            
            // Build ordered list: first visible columns in their current order, then hidden columns
            const orderedColumns = [];
            const visibleSet = new Set(visibleColumns);
            
            // Add visible columns in their current order
            visibleColumns.forEach(colId => {
                if (columnMap[colId]) {
                    orderedColumns.push({ ...columnMap[colId], isVisible: true });
                }
            });
            
            // Add hidden columns
            availableColumns.forEach(col => {
                if (!visibleSet.has(col.id)) {
                    orderedColumns.push({ ...col, isVisible: false });
                }
            });
            
            // Render columns with drag-and-drop support
            list.innerHTML = orderedColumns.map((col, index) => {
                return `
                    <div class="column-item flex items-center p-3 hover:bg-slate-50 rounded-lg border border-transparent transition-all cursor-move" 
                         draggable="true"
                         data-column-id="${col.id}"
                         data-index="${index}">
                        <i class="fas fa-grip-vertical text-gray-400 mr-3 cursor-grab active:cursor-grabbing" 
                           style="user-select: none;"></i>
                        <label class="flex items-center flex-1 cursor-pointer" onclick="event.stopPropagation()">
                            <input type="checkbox" class="mr-3 h-4 w-4 text-blue-600 rounded" 
                                   data-column-id="${col.id}" 
                                   ${col.isVisible ? 'checked' : ''}>
                            <span class="text-sm font-medium text-gray-900">${col.label}</span>
                            ${col.default ? '<span class="ml-auto text-xs text-gray-500">(Default)</span>' : ''}
                        </label>
                    </div>
                `;
            }).join('');
            
            // Attach drag-and-drop event listeners
            attachDragAndDropListeners();
            
            modal.classList.add('active');
        }
        
        function attachDragAndDropListeners() {
            const items = document.querySelectorAll('#column-visibility-list .column-item');
            
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('dragleave', handleDragLeave);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });
        }
        
        function handleDragStart(e) {
            draggedColumnId = this.getAttribute('data-column-id');
            this.classList.add('opacity-50', 'border-blue-400', 'dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }
        
        function handleDragEnter(e) {
            if (this.getAttribute('data-column-id') !== draggedColumnId) {
                this.classList.add('border-blue-400', 'bg-blue-50', 'drag-over');
                draggedOverElement = this;
            }
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleDragLeave(e) {
            this.classList.remove('border-blue-400', 'bg-blue-50', 'drag-over');
        }
        
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedColumnId && draggedOverElement) {
                const targetColumnId = draggedOverElement.getAttribute('data-column-id');
                if (targetColumnId !== draggedColumnId) {
                    reorderColumns(draggedColumnId, targetColumnId);
                }
            }
            
            return false;
        }
        
        function handleDragEnd(e) {
            const items = document.querySelectorAll('#column-visibility-list .column-item');
            items.forEach(item => {
                item.classList.remove('opacity-50', 'border-blue-400', 'bg-blue-50', 'dragging', 'drag-over');
            });
            draggedColumnId = null;
            draggedOverElement = null;
        }
        
        function reorderColumns(draggedId, targetId) {
            // Get current order from DOM
            const items = Array.from(document.querySelectorAll('#column-visibility-list .column-item'));
            const currentOrder = items.map(item => item.getAttribute('data-column-id'));
            
            // Find indices
            const draggedIndex = currentOrder.indexOf(draggedId);
            const targetIndex = currentOrder.indexOf(targetId);
            
            if (draggedIndex === -1 || targetIndex === -1) return;
            
            // Remove dragged item and insert at target position
            currentOrder.splice(draggedIndex, 1);
            currentOrder.splice(targetIndex, 0, draggedId);
            
            // Update visibleColumns to match new order (only for visible columns)
            const checkboxes = document.querySelectorAll('#column-visibility-list input[type="checkbox"]:checked');
            visibleColumns = Array.from(checkboxes)
                .map(cb => cb.getAttribute('data-column-id'))
                .filter(id => currentOrder.includes(id))
                .sort((a, b) => currentOrder.indexOf(a) - currentOrder.indexOf(b));
            
            // Re-render the list to reflect new order
            showColumnVisibilityModal();
        }
        
        function closeColumnVisibilityModal() {
            const modal = document.getElementById('column-visibility-modal');
            if (modal) modal.classList.remove('active');
        }
        
        function resetColumnVisibility() {
            visibleColumns = availableColumns.filter(c => c.default).map(c => c.id);
            // Re-render the modal to show default order
            showColumnVisibilityModal();
        }
        
        function applyColumnVisibility() {
            // Get order from DOM (preserving the drag-and-drop order)
            const items = Array.from(document.querySelectorAll('#column-visibility-list .column-item'));
            const checkboxes = items
                .map(item => {
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    return checkbox && checkbox.checked ? item.getAttribute('data-column-id') : null;
                })
                .filter(id => id !== null);
            
            visibleColumns = checkboxes;
            
            // Ensure at least one column is visible
            if (visibleColumns.length === 0) {
                visibleColumns = ['name'];
                showToast('At least one column must be visible. Showing Asset Name.', 'warning');
            }
            
            // Always include Actions column
            if (!visibleColumns.includes('actions')) {
                // Actions is not in availableColumns, it's always shown
            }
            
            // Save visibility and order to localStorage immediately
            saveColumnVisibility();
            
            // Apply changes immediately
            renderTableHeader();
            renderAssetsList();
            closeColumnVisibilityModal();
            showToast('Column visibility and order saved', 'success');
        }
        
        function renderTableHeader() {
            const headerRow = document.getElementById('assets-list-header-row');
            if (!headerRow) return;
            
            // Add checkbox column header first
            const checkboxHeader = `
                <th class="px-4 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider w-12">
                    <input type="checkbox" id="select-all-assets" class="h-4 w-4 text-blue-600 rounded border-slate-300 focus:ring-blue-500" 
                           onchange="toggleSelectAllAssets(this.checked)" title="Select all assets">
                </th>
            `;
            
            const headers = visibleColumns.map(colId => {
                const col = availableColumns.find(c => c.id === colId);
                if (!col) return '';
                
                const alignClass = colId === 'actions' ? 'text-right' : 'text-left';
                // Add filter input for each column
                const filterInput = getFilterInputForColumn(colId, col.label);
                
                // Add sort indicator and click handler for sortable columns
                const isSortable = colId !== 'actions' && colId !== 'compliance'; // Compliance is calculated, not directly sortable
                const sortIcon = isSortable ? getSortIcon(colId) : '';
                const sortTitle = isSortable ? 'Click to sort' : '';
                
                // Make only the label area clickable for sorting, not the entire cell
                const sortableLabel = isSortable ? `
                    <div class="mb-2 flex items-center justify-between cursor-pointer hover:bg-slate-100 select-none rounded px-1 py-0.5 -mx-1" 
                         onclick="sortAssets('${colId}')" 
                         title="${sortTitle}">
                        <span>${col.label}</span>
                        ${sortIcon}
                    </div>
                ` : `
                    <div class="mb-2 flex items-center justify-between">
                        <span>${col.label}</span>
                    </div>
                `;
                
                return `
                    <th class="px-6 py-3 ${alignClass} text-xs font-medium text-slate-500 uppercase tracking-wider">
                        ${sortableLabel}
                        ${filterInput}
                    </th>
                `;
            }).filter(h => h).join('');
            
            // Always add Actions column at the end (no filter, no sort)
            headerRow.innerHTML = checkboxHeader + headers + '<th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>';
            
            // Attach event listeners to filter inputs
            attachColumnFilterListeners();
            
            // Update table width based on number of columns
            updateTableWidth();
        }
        
        function getSortIcon(colId) {
            if (currentSortColumn !== colId) {
                return '<i class="fas fa-sort text-slate-400 ml-2"></i>';
            }
            if (currentSortDirection === 'asc') {
                return '<i class="fas fa-sort-up text-blue-600 ml-2"></i>';
            }
            return '<i class="fas fa-sort-down text-blue-600 ml-2"></i>';
        }
        
        function sortAssets(columnId) {
            // Toggle sort direction if clicking the same column
            if (currentSortColumn === columnId) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = columnId;
                currentSortDirection = 'asc';
            }
            
            // Apply sorting
            applySorting();
            
            // Re-render table header to show sort indicator
            renderTableHeader();
            
            // Re-render assets list
            renderAssetsList();
        }
        
        function applySorting() {
            if (!currentSortColumn) return;
            
            filteredAssets.sort((a, b) => {
                let aValue = getSortValue(a, currentSortColumn);
                let bValue = getSortValue(b, currentSortColumn);
                
                // Handle null/undefined values
                if (aValue === null || aValue === undefined) aValue = '';
                if (bValue === null || bValue === undefined) bValue = '';
                
                // Convert to strings for comparison
                aValue = String(aValue).toLowerCase();
                bValue = String(bValue).toLowerCase();
                
                let comparison = 0;
                if (aValue > bValue) {
                    comparison = 1;
                } else if (aValue < bValue) {
                    comparison = -1;
                }
                
                return currentSortDirection === 'asc' ? comparison : -comparison;
            });
        }
        
        function getSortValue(asset, columnId) {
            switch(columnId) {
                case 'status':
                    return asset.status || '';
                case 'name':
                    return asset.name || '';
                case 'category':
                    return asset.category || '';
                case 'serial_number':
                    return asset.serial_number || '';
                case 'next_maintenance':
                    return asset.next_maintenance ? new Date(asset.next_maintenance).getTime() : 0;
                case 'last_maintenance':
                    return asset.last_maintenance ? new Date(asset.last_maintenance).getTime() : 0;
                case 'location':
                    return asset.locations?.name || asset.location || '';
                case 'customer':
                    return asset.customers?.name || asset.customer || '';
                case 'purchase_date':
                    return asset.purchase_date ? new Date(asset.purchase_date).getTime() : 0;
                case 'purchase_cost':
                    return asset.purchase_cost ? parseFloat(asset.purchase_cost) : 0;
                case 'warranty_expiry':
                    return asset.warranty_expiry ? new Date(asset.warranty_expiry).getTime() : 0;
                case 'model':
                    return asset.model || '';
                case 'manufacturer':
                    return asset.manufacturer || '';
                case 'description':
                    return asset.description || '';
                default:
                    return '';
            }
        }
        
        function updateTableWidth() {
            const table = document.getElementById('assets-table');
            if (table) {
                // Calculate minimum width based on number of visible columns (150px per column + Actions)
                const columnCount = visibleColumns.length + 1; // +1 for Actions column
                const minWidth = Math.max(800, columnCount * 150);
                table.style.minWidth = `${minWidth}px`;
            }
        }
        
        function renderPaginationControls() {
            const paginationEl = document.getElementById('assets-pagination');
            if (!paginationEl) return;
            
            const totalPages = Math.ceil(filteredAssets.length / itemsPerPage);
            const startItem = filteredAssets.length === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, filteredAssets.length);
            
            if (totalPages <= 1 && filteredAssets.length <= itemsPerPage) {
                // Show items per page selector even if only one page
                paginationEl.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-slate-600">
                            Showing ${filteredAssets.length} of ${filteredAssets.length} assets
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-slate-600">Items per page:</label>
                            <select id="items-per-page-select" onchange="changeItemsPerPage(this.value)" class="border border-slate-300 rounded-lg px-3 py-1 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="10" ${itemsPerPage === 10 ? 'selected' : ''}>10</option>
                                <option value="25" ${itemsPerPage === 25 ? 'selected' : ''}>25</option>
                                <option value="50" ${itemsPerPage === 50 ? 'selected' : ''}>50</option>
                                <option value="100" ${itemsPerPage === 100 ? 'selected' : ''}>100</option>
                                <option value="all" ${itemsPerPage >= filteredAssets.length ? 'selected' : ''}>All</option>
                            </select>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Build page numbers (show max 5 pages around current)
            const pageNumbers = [];
            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
            
            // Adjust if we're near the end
            if (endPage - startPage < maxPagesToShow - 1) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }
            
            if (startPage > 1) {
                pageNumbers.push(1);
                if (startPage > 2) pageNumbers.push('...');
            }
            
            for (let i = startPage; i <= endPage; i++) {
                pageNumbers.push(i);
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) pageNumbers.push('...');
                pageNumbers.push(totalPages);
            }
            
            paginationEl.innerHTML = `
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div class="text-sm text-slate-600">
                        Showing ${startItem} to ${endItem} of ${filteredAssets.length} assets
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-slate-600">Items per page:</label>
                            <select id="items-per-page-select" onchange="changeItemsPerPage(this.value)" class="border border-slate-300 rounded-lg px-3 py-1 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="10" ${itemsPerPage === 10 ? 'selected' : ''}>10</option>
                                <option value="25" ${itemsPerPage === 25 ? 'selected' : ''}>25</option>
                                <option value="50" ${itemsPerPage === 50 ? 'selected' : ''}>50</option>
                                <option value="100" ${itemsPerPage === 100 ? 'selected' : ''}>100</option>
                                <option value="all" ${itemsPerPage >= filteredAssets.length ? 'selected' : ''}>All</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="goToPage(${currentPage - 1})" 
                                    ${currentPage === 1 ? 'disabled' : ''} 
                                    class="px-3 py-1 text-sm border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            ${pageNumbers.map(page => {
                                if (page === '...') {
                                    return '<span class="px-2 text-slate-400">...</span>';
                                }
                                const isActive = page === currentPage;
                                return `
                                    <button onclick="goToPage(${page})" 
                                            class="px-3 py-1 text-sm border rounded-lg transition-colors ${
                                                isActive 
                                                    ? 'bg-blue-600 text-white border-blue-600' 
                                                    : 'border-slate-300 hover:bg-slate-50'
                                            }">
                                        ${page}
                                    </button>
                                `;
                            }).join('')}
                            <button onclick="goToPage(${currentPage + 1})" 
                                    ${currentPage === totalPages ? 'disabled' : ''} 
                                    class="px-3 py-1 text-sm border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function goToPage(page) {
            const totalPages = Math.ceil(filteredAssets.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderAssetsList();
            // Scroll to top of table
            const table = document.getElementById('assets-table');
            if (table) {
                table.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        function changeItemsPerPage(value) {
            if (value === 'all') {
                itemsPerPage = filteredAssets.length || 1000; // Use a large number for "all"
            } else {
                const parsed = parseInt(value, 10);
                if (!isNaN(parsed) && parsed > 0) {
                    itemsPerPage = parsed;
                }
            }
            
            // Reset to first page
            currentPage = 1;
            
            // Save to localStorage
            savePaginationSettings();
            
            // Re-render
            renderAssetsList();
        }
        
        // Expose functions globally for onclick handlers
        window.goToPage = goToPage;
        window.changeItemsPerPage = changeItemsPerPage;
        window.sortAssets = sortAssets;
        window.toggleSelectAllAssets = toggleSelectAllAssets;
        window.handleAssetCheckboxClick = handleAssetCheckboxClick;
        
        function getFilterInputForColumn(colId, label) {
            // Don't show filter for compliance (calculated field)
            if (colId === 'compliance' || colId === 'actions') {
                return '';
            }
            
            // Different input types based on column - make larger for mobile
            // Add stopPropagation to prevent sorting when clicking filter inputs
            if (colId === 'status') {
                return `
                    <select class="column-filter text-sm border border-gray-300 rounded px-2 py-1.5 w-full min-h-[36px]" 
                            data-column="${colId}" 
                            onclick="event.stopPropagation()" 
                            onmousedown="event.stopPropagation()">
                        <option value="">All</option>
                        <option value="active">Active</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="inactive">Inactive</option>
                        <option value="retired">Retired</option>
                    </select>
                `;
            } else if (colId === 'purchase_cost') {
                return `
                    <input type="text" class="column-filter text-sm border border-gray-300 rounded px-2 py-1.5 w-full min-h-[36px]" 
                           data-column="${colId}" 
                           placeholder="Filter..." 
                           onclick="event.stopPropagation()" 
                           onmousedown="event.stopPropagation()" />
                `;
            } else {
                return `
                    <input type="text" class="column-filter text-sm border border-gray-300 rounded px-2 py-1.5 w-full min-h-[36px]" 
                           data-column="${colId}" 
                           placeholder="Filter..." 
                           onclick="event.stopPropagation()" 
                           onmousedown="event.stopPropagation()" />
                `;
            }
        }
        
        let columnFilters = {};
        
        function attachColumnFilterListeners() {
            // Remove old listeners
            document.querySelectorAll('.column-filter').forEach(input => {
                const newInput = input.cloneNode(true);
                input.parentNode.replaceChild(newInput, input);
            });
            
            // Add new listeners
            document.querySelectorAll('.column-filter').forEach(input => {
                const columnId = input.getAttribute('data-column');
                input.addEventListener('input', debounce((e) => {
                    const value = e.target.value.trim();
                    if (value) {
                        columnFilters[columnId] = value;
                    } else {
                        delete columnFilters[columnId];
                    }
                    applyColumnFilters();
                }, 300));
            });
        }
        
        function resetAllFilters() {
            // Clear search input
            const searchInput = document.getElementById('search-input');
            if (searchInput) searchInput.value = '';
            
            // Clear category and status filters
            const categoryFilter = document.getElementById('category-filter');
            if (categoryFilter) categoryFilter.value = '';
            const statusFilter = document.getElementById('status-filter');
            if (statusFilter) statusFilter.value = '';
            
            // Clear all column filters
            columnFilters = {};
            document.querySelectorAll('.column-filter').forEach(input => {
                if (input.tagName === 'INPUT') {
                    input.value = '';
                } else if (input.tagName === 'SELECT') {
                    input.value = '';
                }
            });
            
            // Reset sorting
            currentSortColumn = null;
            currentSortDirection = 'asc';
            
            // Reset pagination
            currentPage = 1;
            
            // Clear selections
            clearAssetSelections();
            
            // Reset filtered assets to all assets
            filteredAssets = [...allAssets];
            
            // Re-render table header to update sort indicators
            renderTableHeader();
            
            // Re-render assets
            renderAssets();
            
            showToast('All filters have been reset', 'success');
        }
        
        // Expose reset function globally
        window.resetAllFilters = resetAllFilters;
        
        function applyColumnFilters() {
            // Clear selections when filters change
            clearAssetSelections();
            filteredAssets = allAssets.filter(asset => {
                return Object.entries(columnFilters).every(([colId, filterValue]) => {
                    if (!filterValue) return true;
                    
                    const filterLower = filterValue.toLowerCase();
                    
                    switch(colId) {
                        case 'status':
                            return asset.status?.toLowerCase() === filterLower;
                        case 'name':
                            return asset.name?.toLowerCase().includes(filterLower);
                        case 'category':
                            return asset.category?.toLowerCase().includes(filterLower);
                        case 'serial_number':
                            return asset.serial_number?.toLowerCase().includes(filterLower);
                        case 'location':
                            const locationName = asset.locations?.name || asset.location || '';
                            return locationName.toLowerCase().includes(filterLower);
                        case 'customer':
                            const customerName = asset.customers?.name || asset.customer || '';
                            return customerName.toLowerCase().includes(filterLower);
                        case 'purchase_date':
                            const purchaseDate = formatDate(asset.purchase_date);
                            return purchaseDate.toLowerCase().includes(filterLower);
                        case 'purchase_cost':
                            const cost = asset.purchase_cost ? parseFloat(asset.purchase_cost).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '';
                            return cost.includes(filterValue) || String(asset.purchase_cost || '').includes(filterValue);
                        case 'warranty_expiry':
                            const warrantyDate = formatDate(asset.warranty_expiry);
                            return warrantyDate.toLowerCase().includes(filterLower);
                        case 'last_maintenance':
                            const lastPM = formatDate(asset.last_maintenance);
                            return lastPM.toLowerCase().includes(filterLower);
                        case 'next_maintenance':
                            const nextPM = formatDate(asset.next_maintenance);
                            return nextPM.toLowerCase().includes(filterLower);
                        case 'model':
                            return asset.model?.toLowerCase().includes(filterLower);
                        case 'manufacturer':
                            return asset.manufacturer?.toLowerCase().includes(filterLower);
                        case 'description':
                            return asset.description?.toLowerCase().includes(filterLower);
                        default:
                            return true;
                    }
                });
            });
            
            // Apply sorting if active
            if (currentSortColumn) {
                applySorting();
            }
            
            renderAssets();
        }
        
        function getColumnValue(asset, colId) {
            const days = getDaysUntil(asset.next_maintenance);
            const statusColors = {
                active: 'bg-green-100 text-green-800',
                maintenance: 'bg-yellow-100 text-yellow-800',
                inactive: 'bg-gray-100 text-gray-800',
                retired: 'bg-red-100 text-red-800'
            };
            
            switch(colId) {
                case 'status':
                    return `<span class="px-2 py-1 text-xs font-medium rounded-full ${statusColors[asset.status] || 'bg-gray-100 text-gray-800'}">${asset.status ? asset.status.charAt(0).toUpperCase() + asset.status.slice(1) : 'Unknown'}</span>`;
                case 'name':
                    return `<span class="text-sm font-medium text-slate-900">${escapeHtml(asset.name || 'Unnamed')}</span>`;
                case 'category':
                    return `<span class="text-sm text-slate-600">${escapeHtml(asset.category || 'N/A')}</span>`;
                case 'serial_number':
                    return `<span class="text-sm text-slate-600">${escapeHtml(asset.serial_number || 'N/A')}</span>`;
                case 'next_maintenance':
                    return `<span class="text-sm text-slate-600">${formatDate(asset.next_maintenance)}</span>`;
                case 'compliance':
                    const complianceColor = days !== null && days < 0 ? 'text-red-600 font-bold' : days !== null && days <= 7 ? 'text-orange-600 font-semibold' : 'text-green-600';
                    const complianceText = days !== null && days < 0 ? `${Math.abs(days)} days OVERDUE` : days !== null ? `${days} days remaining` : 'N/A';
                    return `<span class="text-sm ${complianceColor}">${complianceText}</span>`;
                case 'location':
                    return `<span class="text-sm text-slate-600">${escapeHtml(asset.locations?.name || asset.location || 'N/A')}</span>`;
                case 'customer':
                    return `<span class="text-sm text-slate-600">${escapeHtml(asset.customers?.name || asset.customer || 'N/A')}</span>`;
                case 'purchase_date':
                    return `<span class="text-sm text-slate-600">${formatDate(asset.purchase_date)}</span>`;
                case 'purchase_cost':
                    return `<span class="text-sm text-slate-600">${asset.purchase_cost ? '$' + parseFloat(asset.purchase_cost).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : 'N/A'}</span>`;
                case 'warranty_expiry':
                    return `<span class="text-sm text-slate-600">${formatDate(asset.warranty_expiry)}</span>`;
                case 'last_maintenance':
                    return `<span class="text-sm text-slate-600">${formatDate(asset.last_maintenance)}</span>`;
                case 'model':
                    return `<span class="text-sm text-slate-600">${escapeHtml(asset.model || 'N/A')}</span>`;
                case 'manufacturer':
                    return `<span class="text-sm text-slate-600">${escapeHtml(asset.manufacturer || 'N/A')}</span>`;
                case 'description':
                    const desc = asset.description || 'N/A';
                    const shortDesc = desc.length > 50 ? desc.substring(0, 50) + '...' : desc;
                    return `<span class="text-sm text-slate-600" title="${escapeHtml(desc)}">${escapeHtml(shortDesc)}</span>`;
                default:
                    return '<span class="text-sm text-slate-600">N/A</span>';
            }
        }
        
        // Asset Image Upload Functions
        let assetImageUrls = [];
        
        async function handleAssetImageUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            if (!supabaseClient) {
                showToast('Database not connected', 'error');
                return;
            }
            
            const previewContainer = document.getElementById('asset-images-preview');
            if (!previewContainer) return;
            
            try {
                showToast('Uploading images...', 'info');
                
                for (const file of files) {
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        showToast(`Skipping ${file.name}: Not an image file`, 'warning');
                        continue;
                    }
                    
                    // Validate file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        showToast(`Skipping ${file.name}: File too large (max 5MB)`, 'warning');
                        continue;
                    }
                    
                    // Upload to Supabase Storage
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
                    const filePath = `assets/${fileName}`;
                    
                    const { data: uploadData, error: uploadError } = await supabaseClient.storage
                        .from('asset-images')
                        .upload(filePath, file, {
                            cacheControl: '3600',
                            upsert: false
                        });
                    
                    if (uploadError) {
                        // Try to create bucket if it doesn't exist
                        if (uploadError.message.includes('Bucket not found')) {
                            showToast('Storage bucket "asset-images" not found. Please create it in Supabase Storage.', 'error');
                            return;
                        }
                        throw uploadError;
                    }
                    
                    // Get public URL
                    const { data: urlData } = supabaseClient.storage
                        .from('asset-images')
                        .getPublicUrl(filePath);
                    
                    assetImageUrls.push(urlData.publicUrl);
                    
                    // Add preview
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'relative group';
                    previewDiv.innerHTML = `
                        <img src="${urlData.publicUrl}" alt="Asset image" class="w-full h-32 object-cover rounded-lg border border-gray-200">
                        <button type="button" onclick="removeAssetImage('${urlData.publicUrl}')" 
                                class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    `;
                    previewContainer.appendChild(previewDiv);
                }
                
                // Update hidden input
                document.getElementById('asset-images-urls').value = JSON.stringify(assetImageUrls);
                showToast(`Uploaded ${files.length} image(s) successfully`, 'success');
                
                // Clear file input
                event.target.value = '';
            } catch (error) {
                console.error('Error uploading images:', error);
                showToast(`Failed to upload images: ${error.message}`, 'error');
            }
        }
        
        function removeAssetImage(imageUrl) {
            assetImageUrls = assetImageUrls.filter(url => url !== imageUrl);
            document.getElementById('asset-images-urls').value = JSON.stringify(assetImageUrls);
            
            // Remove preview
            const previewContainer = document.getElementById('asset-images-preview');
            if (previewContainer) {
                const images = previewContainer.querySelectorAll('div');
                images.forEach(div => {
                    const img = div.querySelector('img');
                    if (img && img.src === imageUrl) {
                        div.remove();
                    }
                });
            }
        }
        
        function loadAssetImages(imageUrls) {
            assetImageUrls = imageUrls || [];
            const previewContainer = document.getElementById('asset-images-preview');
            if (!previewContainer) return;
            
            previewContainer.innerHTML = '';
            
            if (assetImageUrls.length === 0) {
                previewContainer.innerHTML = '<p class="text-sm text-gray-500 col-span-full">No images uploaded</p>';
                return;
            }
            
            assetImageUrls.forEach(url => {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'relative group';
                previewDiv.innerHTML = `
                    <img src="${url}" alt="Asset image" class="w-full h-32 object-cover rounded-lg border border-gray-200">
                    <button type="button" onclick="removeAssetImage('${url}')" 
                            class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                `;
                previewContainer.appendChild(previewDiv);
            });
            
            document.getElementById('asset-images-urls').value = JSON.stringify(assetImageUrls);
        }
        
        // Mobile Filter Functions
        function showMobileFilters() {
            const modal = document.getElementById('mobile-filters-modal');
            const content = document.getElementById('mobile-filters-content');
            if (!modal || !content) return;
            
            // Build mobile-friendly filter UI
            let filterHTML = '';
            
            // Search filter
            const searchValue = document.getElementById('search-input')?.value || '';
            filterHTML += `
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Search</label>
                    <input type="text" id="mobile-search-filter" value="${searchValue}" 
                           placeholder="Search by name or serial number..." 
                           class="w-full border border-gray-300 rounded-lg px-4 py-3 text-base">
                </div>
            `;
            
            // Status filter
            const statusValue = columnFilters.status || '';
            filterHTML += `
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                    <select id="mobile-status-filter" class="w-full border border-gray-300 rounded-lg px-4 py-3 text-base min-h-[44px]">
                        <option value="">All Statuses</option>
                        <option value="active" ${statusValue === 'active' ? 'selected' : ''}>Active</option>
                        <option value="maintenance" ${statusValue === 'maintenance' ? 'selected' : ''}>Maintenance</option>
                        <option value="inactive" ${statusValue === 'inactive' ? 'selected' : ''}>Inactive</option>
                        <option value="retired" ${statusValue === 'retired' ? 'selected' : ''}>Retired</option>
                    </select>
                </div>
            `;
            
            // Category filter
            const categoryValue = document.getElementById('category-filter')?.value || '';
            filterHTML += `
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                    <select id="mobile-category-filter" class="w-full border border-gray-300 rounded-lg px-4 py-3 text-base min-h-[44px]">
                        <option value="">All Categories</option>
                    </select>
                </div>
            `;
            
            // Column-specific filters
            visibleColumns.forEach(colId => {
                if (colId === 'compliance' || colId === 'actions' || colId === 'status') return;
                
                const col = availableColumns.find(c => c.id === colId);
                if (!col) return;
                
                const filterValue = columnFilters[colId] || '';
                filterHTML += `
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">${col.label}</label>
                        <input type="text" id="mobile-filter-${colId}" value="${filterValue}" 
                               placeholder="Filter ${col.label}..." 
                               class="w-full border border-gray-300 rounded-lg px-4 py-3 text-base min-h-[44px]">
                    </div>
                `;
            });
            
            content.innerHTML = filterHTML;
            
            // Populate category dropdown
            const categorySelect = document.getElementById('mobile-category-filter');
            if (categorySelect) {
                const mainCategorySelect = document.getElementById('category-filter');
                if (mainCategorySelect) {
                    categorySelect.innerHTML = mainCategorySelect.innerHTML;
                    categorySelect.value = categoryValue;
                }
            }
            
            updateMobileFilterCount();
            modal.classList.add('active');
        }
        
        function closeMobileFilters() {
            const modal = document.getElementById('mobile-filters-modal');
            if (modal) modal.classList.remove('active');
        }
        
        function clearAllMobileFilters() {
            const searchInput = document.getElementById('mobile-search-filter');
            if (searchInput) searchInput.value = '';
            const statusSelect = document.getElementById('mobile-status-filter');
            if (statusSelect) statusSelect.value = '';
            const categorySelect = document.getElementById('mobile-category-filter');
            if (categorySelect) categorySelect.value = '';
            visibleColumns.forEach(colId => {
                if (colId !== 'compliance' && colId !== 'actions' && colId !== 'status') {
                    const input = document.getElementById(`mobile-filter-${colId}`);
                    if (input) input.value = '';
                }
            });
            updateMobileFilterCount();
        }
        
        function applyMobileFilters() {
            // Clear selections when filters change
            clearAssetSelections();
            // Apply search filter
            const searchInput = document.getElementById('search-input');
            const mobileSearch = document.getElementById('mobile-search-filter');
            if (searchInput && mobileSearch) {
                searchInput.value = mobileSearch.value;
            }
            
            // Apply status filter
            const statusValue = document.getElementById('mobile-status-filter')?.value || '';
            if (statusValue) {
                columnFilters.status = statusValue;
            } else {
                delete columnFilters.status;
            }
            
            // Apply category filter
            const categoryValue = document.getElementById('mobile-category-filter')?.value || '';
            const categorySelect = document.getElementById('category-filter');
            if (categorySelect) {
                categorySelect.value = categoryValue;
            }
            
            // Apply column filters
            visibleColumns.forEach(colId => {
                if (colId === 'compliance' || colId === 'actions' || colId === 'status') return;
                const input = document.getElementById(`mobile-filter-${colId}`);
                if (input) {
                    const value = input.value.trim();
                    if (value) {
                        columnFilters[colId] = value;
                    } else {
                        delete columnFilters[colId];
                    }
                }
            });
            
            // Update desktop filters
            document.querySelectorAll('.column-filter').forEach(input => {
                const colId = input.getAttribute('data-column');
                if (colId && columnFilters[colId]) {
                    input.value = columnFilters[colId];
                } else if (colId && !columnFilters[colId]) {
                    input.value = '';
                }
            });
            
            applyFilters();
            updateMobileFilterCount();
            closeMobileFilters();
        }
        
        function updateMobileFilterCount() {
            let count = 0;
            const searchValue = document.getElementById('mobile-search-filter')?.value || '';
            if (searchValue) count++;
            const statusValue = document.getElementById('mobile-status-filter')?.value || '';
            if (statusValue) count++;
            const categoryValue = document.getElementById('mobile-category-filter')?.value || '';
            if (categoryValue) count++;
            visibleColumns.forEach(colId => {
                if (colId !== 'compliance' && colId !== 'actions' && colId !== 'status') {
                    const input = document.getElementById(`mobile-filter-${colId}`);
                    if (input && input.value.trim()) count++;
                }
            });
            const countBadge = document.getElementById('mobile-filter-count');
            if (countBadge) {
                countBadge.textContent = count;
                countBadge.style.display = count > 0 ? 'block' : 'none';
            }
        }
        
        // Expose functions to window for global access
        window.handleAssetImageUpload = handleAssetImageUpload;
        window.removeAssetImage = removeAssetImage;
        window.loadAssetImages = loadAssetImages;
        window.showMobileFilters = showMobileFilters;
        window.closeMobileFilters = closeMobileFilters;
        window.clearAllMobileFilters = clearAllMobileFilters;
        window.applyMobileFilters = applyMobileFilters;
    </script>
    <script src="js/mmd-validation.js"></script>
    <script src="js/mmd-reference-manager.js"></script>
    <script src="js/unified-mmd-modal.js"></script>
    <script src="js/pm-automation.js"></script>
    <script src="js/pm-management.js"></script>
    <script>
        // MMD Handler Functions - Bridge between HTML and MMDAssetFormManager
        function handleMMDTypeChange() {
            const typeSelect = document.getElementById('mmd-type-select');
            if (!typeSelect || !window.mmdAssetFormManager) return;
            
            const typeId = typeSelect.value;
            window.mmdAssetFormManager.selectedType = typeId;
            window.mmdAssetFormManager.populateMakeDropdown(typeId);
            
            // Enable/disable Make "Add" button
            const addMakeBtn = document.getElementById('add-mmd-make-btn');
            if (addMakeBtn) {
                addMakeBtn.disabled = !typeId;
                if (typeId) {
                    addMakeBtn.setAttribute('onclick', `openUnifiedMMDModal({type_id: '${typeId}'})`);
                }
            }
        }
        
        function handleMMDMakeChange() {
            const makeSelect = document.getElementById('mmd-make-select');
            if (!makeSelect || !window.mmdAssetFormManager) return;
            
            const makeId = makeSelect.value;
            window.mmdAssetFormManager.selectedMake = makeId;
            window.mmdAssetFormManager.populateModelDropdown(makeId);
            
            // Enable/disable Model "Add" button
            const addModelBtn = document.getElementById('add-mmd-model-btn');
            if (addModelBtn) {
                if (makeId) {
                    addModelBtn.disabled = false;
                    const typeId = document.getElementById('mmd-type-select')?.value;
                    // Update onclick to use unified modal with context
                    addModelBtn.setAttribute('onclick', `openUnifiedMMDModal({type_id: '${typeId}', make_id: '${makeId}'})`);
                    console.log('Model Add button enabled for Make ID:', makeId);
                } else {
                    addModelBtn.disabled = true;
                    addModelBtn.removeAttribute('onclick');
                    console.log('Model Add button disabled - no Make selected');
                }
            } else {
                console.error('Add Model button not found!');
            }
        }
        
        async function handleMMDModelChange() {
            const modelSelect = document.getElementById('mmd-model-select');
            if (!modelSelect || !window.mmdAssetFormManager) return;
            
            const modelId = modelSelect.value;
            window.mmdAssetFormManager.selectedModel = modelId;
            await window.mmdAssetFormManager.updatePMFrequency(modelId);
        }
        
        // Expose globally
        window.handleMMDTypeChange = handleMMDTypeChange;
        window.handleMMDMakeChange = handleMMDMakeChange;
        window.handleMMDModelChange = handleMMDModelChange;
        
        // Unified MMD Modal opener - MUST be available immediately
        let unifiedMMDModalInstance = null;
        function openUnifiedMMDModal(context = {}) {
            console.log('openUnifiedMMDModal called with context:', context);
            try {
                // Get Supabase client
                const supabaseClient = window.supabaseClient || window.sharedSupabaseClient;
                if (!supabaseClient) {
                    console.error('No Supabase client available');
                    if (window.showToast) {
                        window.showToast('Database connection not available', 'error');
                    } else {
                        alert('Database connection not available');
                    }
                    return;
                }

                // Check if UnifiedMMDModal class is available
                if (!window.UnifiedMMDModal) {
                    console.error('UnifiedMMDModal class not loaded yet');
                    if (window.showToast) {
                        window.showToast('MMD Modal system not loaded. Please refresh the page.', 'error');
                    } else {
                        alert('MMD Modal system not loaded. Please refresh the page.');
                    }
                    return;
                }

                // Create instance if needed
                if (!unifiedMMDModalInstance) {
                    console.log('Creating new UnifiedMMDModal instance');
                    unifiedMMDModalInstance = new window.UnifiedMMDModal(supabaseClient);
                }

                // Open the modal
                console.log('Opening unified MMD modal');
                unifiedMMDModalInstance.open(context);
            } catch (error) {
                console.error('Error opening unified MMD modal:', error);
                if (window.showToast) {
                    window.showToast(`Error: ${error.message}`, 'error');
                } else {
                    alert(`Error: ${error.message}`);
                }
            }
        }
        // Expose immediately
        window.openUnifiedMMDModal = openUnifiedMMDModal;
        
        // Fix modal closing issue - prevent clicks inside from closing the modal
        document.addEventListener('DOMContentLoaded', function() {
            const lookupModal = document.getElementById('lookup-modal');
            const lookupModalContent = lookupModal?.querySelector('.modal-content');
            const lookupInput = document.getElementById('lookup-modal-input');
            const lookupPMFreq = document.getElementById('lookup-modal-pm-frequency');
            
            // Prevent all clicks inside modal content from bubbling to backdrop
            if (lookupModalContent) {
                ['click', 'mousedown', 'mouseup'].forEach(eventType => {
                    lookupModalContent.addEventListener(eventType, function(e) {
                        e.stopPropagation();
                    }, true);
                });
            }
            
            // Specifically protect input fields
            if (lookupInput) {
                ['click', 'focus', 'mousedown', 'mouseup', 'keydown', 'keyup'].forEach(eventType => {
                    lookupInput.addEventListener(eventType, function(e) {
                        e.stopPropagation();
                    }, true);
                });
            }
            
            // Specifically protect PM Frequency dropdown
            if (lookupPMFreq) {
                ['click', 'focus', 'mousedown', 'mouseup', 'change', 'keydown', 'keyup'].forEach(eventType => {
                    lookupPMFreq.addEventListener(eventType, function(e) {
                        e.stopPropagation();
                    }, true);
                });
            }
            
            // Only close modal when clicking the backdrop (not content)
            if (lookupModal) {
                lookupModal.addEventListener('click', function(e) {
                    // Only close if clicking directly on the modal backdrop (not children)
                    if (e.target === lookupModal) {
                        closeLookupModal();
                    }
                });
            }
        });
        
        // FIX: Protect Asset Modal from backdrop clicks interfering with buttons
        (function setupAssetModalProtection() {
            function attachProtection() {
                const assetModal = document.getElementById('asset-modal');
                if (!assetModal) {
                    setTimeout(attachProtection, 100);
                    return;
                }
                
                const assetModalContent = assetModal.querySelector('.modal-content');
                const assetForm = document.getElementById('asset-form');
                const saveButton = assetForm?.querySelector('button[type="submit"]');
                
                // Stop ALL events on content from reaching backdrop
                if (assetModalContent) {
                    const stopAll = (e) => {
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                    };
                    ['click', 'mousedown', 'mouseup', 'submit'].forEach(type => {
                        assetModalContent.addEventListener(type, stopAll, true);
                    });
                }
                
                // Protect form and submit button
                if (assetForm) {
                    const stopAll = (e) => {
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                    };
                    ['click', 'submit', 'mousedown', 'mouseup'].forEach(type => {
                        assetForm.addEventListener(type, stopAll, true);
                    });
                }
                
                if (saveButton) {
                    const stopAll = (e) => {
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                    };
                    ['click', 'mousedown', 'mouseup'].forEach(type => {
                        saveButton.addEventListener(type, stopAll, true);
                    });
                }
                
                // ONLY close when clicking backdrop directly (not children)
                assetModal.addEventListener('click', function(e) {
                    if (e.target === assetModal) {
                        closeAssetModal();
                    }
                }, false);
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', attachProtection);
            } else {
                attachProtection();
            }
            // Also run after delay to catch any late-loading elements
            setTimeout(attachProtection, 500);
        })();
    </script>
</body>
</html>
