<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asset Management - MERC-CMMS</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
* { font-family: 'Inter', sans-serif; }
.medical-gradient { background: linear-gradient(135deg, #1e293b 0%, #2563eb 50%, #0891b2 100%); }
.card-hover { transition: all 0.3s ease; }
.card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
.notification-badge { position: absolute; top: -8px; right: -8px; background: #dc2626; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; }
.status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
.status-active { background-color: #059669; }
.status-inactive { background-color: #6b7280; }
.status-maintenance { background-color: #d97706; }
.status-retired { background-color: #dc2626; }
.asset-header-bg { background-image: url('/resources/asset-header.jpg'); background-size: cover; background-position: center; }
.form-input { width: 100%; padding: 10px 16px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; transition: all 0.2s; }
.form-input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
.btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s; border: none; }
.btn-primary { background: #2563eb; color: white; }
.btn-primary:hover { background: #1d4ed8; }
.btn-secondary { background: #e2e8f0; color: #475569; }
.btn-secondary:hover { background: #cbd5e1; }
.btn-success { background: #059669; color: white; }
.btn-success:hover { background: #047857; }
.loading-spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: #2563eb; border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.fade-in { animation: fadeIn 0.3s ease-in-out; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
#toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
.toast { padding: 12px 20px; border-radius: 8px; color: white; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); animation: slideIn 0.3s ease-out; max-width: 400px; }
.toast-success { background: #059669; }
.toast-error { background: #dc2626; }
.toast-warning { background: #d97706; }
.toast-info { background: #2563eb; }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
.status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: capitalize; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; }
.modal.active { display: flex; align-items: center; justify-content: center; }
.modal-content { background: white; border-radius: 16px; max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
.tab-button { padding: 12px 24px; border-bottom: 2px solid transparent; font-weight: 600; cursor: pointer; transition: all 0.2s; color: #64748b; }
.tab-button.active { color: #2563eb; border-bottom-color: #2563eb; background: #eff6ff; }
.tab-button:hover { background: #f8fafc; }
.tab-content { display: none; }
.tab-content.active { display: block; }
#mobile-menu { position: fixed; top: 64px; left: 0; right: 0; z-index: 40; background: linear-gradient(135deg, #1e293b 0%, #2563eb 50%, #0891b2 100%); padding: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transform: translateY(0); visibility: visible; opacity: 1; transition: transform 0.3s ease, opacity 0.3s ease; }
#mobile-menu.hidden { transform: translateY(-100%); opacity: 0; pointer-events: none; visibility: hidden; }
.drag-drop-zone { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 40px; text-align: center; transition: all 0.2s; cursor: pointer; }
.drag-drop-zone.drag-over { border-color: #2563eb; background: #eff6ff; }
.wo-card { background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; border-left: 4px solid #2563eb; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
.wo-card.priority-critical { border-left-color: #dc2626; }
.wo-card.priority-high { border-left-color: #d97706; }
.wo-card.priority-medium { border-left-color: #2563eb; }
.wo-card.priority-low { border-left-color: #6b7280; }
</style>
</head>
<body class="bg-slate-50 text-slate-800">
    <!-- Header -->
    <nav class="fixed top-0 left-0 right-0 z-50 medical-gradient shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-wrap justify-between items-center gap-3 py-2 min-h-[4rem]">
                <a href="index.html" class="flex items-center space-x-4 min-w-0">
                    <img src="/resources/Logo_without%20name.png" alt="MERC-CMMS logo" class="w-10 h-10 rounded-full bg-white object-contain p-1">
                    <div class="min-w-0">
                        <h1 class="text-white text-xl font-bold truncate">MERC-CMMS</h1>
                        <p class="text-blue-200 text-xs truncate">Enterprise Medical Device Management</p>
                    </div>
                </a>
                <div class="hidden md:flex items-center space-x-8">
                    <a href="index.html" class="text-blue-200 hover:text-white transition-colors">Dashboard</a>
                    <a href="customers.html" class="text-blue-200 hover:text-white transition-colors">Customers</a>
                    <a href="assets.html" class="text-white font-semibold border-b-2 border-blue-300 pb-1">Assets</a>
                    <a href="work-orders.html" class="text-blue-200 hover:text-white transition-colors">Work Orders</a>
                    <a href="compliance.html" class="text-blue-200 hover:text-white transition-colors">Compliance</a>
                </div>
                <div class="flex items-center gap-3 flex-shrink-0">
                    <button id="mobile-menu-button" class="md:hidden text-white hover:text-blue-200 transition-colors">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <div class="relative">
                        <button class="text-white hover:text-blue-200 transition-colors">
                            <i class="fas fa-bell text-xl"></i>
                        </button>
                        <div class="notification-badge">3</div>
                    </div>
                    <div class="flex items-center space-x-2 min-w-0">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-white text-sm"></i>
                        </div>
                        <div class="hidden md:block min-w-0">
                            <p class="text-white text-sm font-medium truncate">System Admin</p>
                            <p class="text-blue-200 text-xs truncate">Super Administrator</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <div id="mobile-menu" class="md:hidden hidden">
        <div class="px-4 py-4 space-y-2">
            <a href="index.html" class="block text-blue-200 hover:text-white transition-colors">Dashboard</a>
            <a href="customers.html" class="block text-blue-200 hover:text-white transition-colors">Customers</a>
            <a href="assets.html" class="block text-white font-semibold">Assets</a>
            <a href="work-orders.html" class="block text-blue-200 hover:text-white transition-colors">Work Orders</a>
            <a href="compliance.html" class="block text-blue-200 hover:text-white transition-colors">Compliance</a>
        </div>
    </div>

    <!-- Main Content -->
    <main class="pt-16">
        <!-- Header Section -->
        <section class="asset-header-bg relative">
            <div class="absolute inset-0 bg-slate-900 bg-opacity-70"></div>
            <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
                <div class="text-center">
                    <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">Asset Management</h1>
                    <p class="text-xl text-blue-200 mb-8 max-w-3xl mx-auto">
                        Complete medical device lifecycle management with automated PM scheduling and compliance tracking
                    </p>
                </div>
            </div>
        </section>

        <!-- Statistics Dashboard -->
        <section class="py-8 bg-white">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
            <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500 hover:shadow-lg transition-shadow">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-600 font-medium">Total Assets</p>
                        <p class="text-3xl font-bold text-gray-900 mt-1" id="stat-total">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-boxes text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500 hover:shadow-lg transition-shadow">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-600 font-medium">Active</p>
                        <p class="text-3xl font-bold text-green-600 mt-1" id="stat-active">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-check-circle text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-yellow-500 hover:shadow-lg transition-shadow">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-600 font-medium">Maintenance</p>
                        <p class="text-3xl font-bold text-yellow-600 mt-1" id="stat-maintenance">0</p>
                    </div>
                    <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-wrench text-yellow-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-red-500 hover:shadow-lg transition-shadow">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-600 font-medium">Overdue PM</p>
                        <p class="text-3xl font-bold text-red-600 mt-1" id="stat-overdue">0</p>
                    </div>
                    <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-purple-500 hover:shadow-lg transition-shadow">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-600 font-medium">Compliant</p>
                        <p class="text-3xl font-bold text-purple-600 mt-1" id="stat-compliant">0%</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-shield-alt text-purple-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>
            </div>
        </section>

        <!-- Controls Bar -->
        <section class="py-6 bg-slate-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div class="flex-1 min-w-[300px]">
                            <div class="relative">
                                <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <input type="text" id="search-input" placeholder="Search by name, ID, serial number..." class="form-input pl-12">
                            </div>
                        </div>
                        <select id="category-filter" class="form-input max-w-[200px]">
                            <option value="">All Categories</option>
                        </select>
                        <select id="status-filter" class="form-input max-w-[180px]">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="maintenance">Maintenance</option>
                    <option value="inactive">Inactive</option>
                    <option value="retired">Retired</option>
                </select>
                <button onclick="showBulkImportModal()" class="btn btn-secondary">
                    <i class="fas fa-file-import"></i>
                    Bulk Import
                </button>
                <button onclick="exportToCSV()" class="btn btn-success">
                    <i class="fas fa-download"></i>
                    Export CSV
                </button>
                <button onclick="showAddAssetModal()" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    Add Asset
                </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Loading State -->
        <section class="py-8 bg-white">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div id="loading" class="text-center py-16">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-600 font-medium">Loading assets from Supabase...</p>
                </div>
                <div id="assets-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 fade-in" style="display:none"></div>
                <div id="empty-state" class="text-center py-16 bg-slate-50 rounded-xl" style="display:none">
                    <i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-2xl font-bold text-gray-700 mb-2">No Assets Found</h3>
                    <p class="text-gray-500 mb-6">Get started by adding your first medical device asset</p>
                    <button onclick="showAddAssetModal()" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        Add Your First Asset
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-slate-800 text-white py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-slate-400">&copy; 2025 MERC-CMMS Enterprise. All rights reserved.</p>
        </div>
    </footer>

    <!-- Bulk Import Modal -->
    <div id="bulk-import-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">Bulk Import Assets</h2>
                    <button onclick="closeBulkImportModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="mb-6">
                    <h3 class="font-semibold text-gray-900 mb-2">CSV Format Requirements:</h3>
                    <p class="text-sm text-gray-600 mb-3">Your CSV file should include the following columns:</p>
                    <div class="bg-slate-50 p-4 rounded-lg text-sm font-mono">
                        name,category,manufacturer,model,serial_number,status,purchase_date,purchase_cost,warranty_expiry,customer_id,location_id,description
                    </div>
                    <button onclick="downloadTemplate()" class="mt-3 text-blue-600 hover:text-blue-700 text-sm font-semibold">
                        <i class="fas fa-download mr-2"></i>Download CSV Template
                    </button>
                </div>
                <div class="drag-drop-zone" id="drop-zone">
                    <i class="fas fa-cloud-upload-alt text-5xl text-gray-400 mb-4"></i>
                    <p class="text-lg font-semibold text-gray-700 mb-2">Drag and drop your CSV file here</p>
                    <p class="text-sm text-gray-500 mb-4">or</p>
                    <button onclick="document.getElementById('csv-file-input').click()" class="btn btn-primary">
                        <i class="fas fa-file-csv mr-2"></i>Select CSV File
                    </button>
                    <input type="file" id="csv-file-input" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
                </div>
                <div id="import-preview" class="mt-6" style="display: none;">
                    <h3 class="font-semibold text-gray-900 mb-2">Import Preview:</h3>
                    <div id="preview-content" class="bg-slate-50 p-4 rounded-lg max-h-48 overflow-auto"></div>
                    <div class="flex justify-end gap-3 mt-4">
                        <button onclick="cancelImport()" class="btn btn-secondary">Cancel</button>
                        <button onclick="confirmImport()" class="btn btn-primary">
                            <i class="fas fa-check mr-2"></i>Import Assets
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Asset View/Edit Modal with Tabs -->
    <div id="asset-modal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900" id="modal-title">Asset Details</h2>
                        <p class="text-sm text-gray-500 mt-1" id="modal-subtitle"></p>
                    </div>
                    <button onclick="closeAssetModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <!-- Tabs -->
                <div class="flex gap-2 mt-4 border-b">
                    <button class="tab-button active" onclick="switchTab('details')">
                        <i class="fas fa-info-circle mr-2"></i>Details
                    </button>
                    <button class="tab-button" onclick="switchTab('workorders')" id="wo-tab-button">
                        <i class="fas fa-clipboard-list mr-2"></i>Work Orders <span id="wo-count" class="ml-1 bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-xs"></span>
                    </button>
                    <button class="tab-button" onclick="switchTab('pmschedule')" id="pm-tab-button">
                        <i class="fas fa-calendar-alt mr-2"></i>PM Schedule
                    </button>
                </div>
            </div>

            <!-- Details Tab -->
            <div class="p-6">
                <form id="asset-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Asset Name *</label>
                            <input type="text" name="name" required class="form-input" placeholder="e.g., MRI Scanner">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Category *</label>
                            <input type="text" name="category" id="category-input" list="category-list" required class="form-input" placeholder="Start typing to select or add">
                            <datalist id="category-list"></datalist>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Manufacturer *</label>
                            <input type="text" name="manufacturer" list="manufacturer-list" required class="form-input" placeholder="Start typing to select or add">
                            <datalist id="manufacturer-list"></datalist>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Model *</label>
                            <input type="text" name="model" list="model-list" required class="form-input" placeholder="Start typing to select or add">
                            <datalist id="model-list"></datalist>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Serial Number *</label>
                            <input type="text" name="serial_number" required class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                            <select name="status" class="form-input">
                                <option value="active">Active</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="inactive">Inactive</option>
                                <option value="retired">Retired</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Purchase Date</label>
                            <input type="date" name="purchase_date" class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Purchase Cost ($)</label>
                            <input type="number" name="purchase_cost" step="0.01" class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Warranty Expiry</label>
                            <input type="date" name="warranty_expiry" class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Customer</label>
                            <select name="customer_id" id="customer-select" class="form-input">
                                <option value="">Select Customer</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Location</label>
                            <select name="location_id" id="location-select" class="form-input">
                                <option value="">Select Location</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                            <textarea name="description" rows="3" class="form-input"></textarea>
                        </div>
                        <div class="md:col-span-2 border-t border-slate-200 pt-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Preventive Maintenance Schedule</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">PM Schedule Type</label>
                                    <select name="pm_schedule_type" id="pm-schedule-type" class="form-input">
                                        <option value="">No PM Schedule</option>
                                        <option value="daily">Daily (Every 24 hours)</option>
                                        <option value="weekly">Weekly (Every 7 days)</option>
                                        <option value="biweekly">Bi-Weekly (Every 14 days)</option>
                                        <option value="monthly">Monthly (Every 30 days)</option>
                                        <option value="quarterly">Quarterly (Every 90 days)</option>
                                        <option value="semiannually">Semi-Annually (Every 180 days)</option>
                                        <option value="annually">Annually (Every 365 days)</option>
                                        <option value="custom">Custom Interval</option>
                                    </select>
                                </div>
                                <div id="custom-interval-wrapper" style="display: none;">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Custom Interval (days)</label>
                                    <input type="number" name="pm_interval_days" id="pm-interval-days" class="form-input" min="1" placeholder="e.g., 45">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Last Maintenance Date</label>
                                    <input type="date" name="last_maintenance" id="last-maintenance" class="form-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Next Maintenance Due</label>
                                    <input type="date" name="next_maintenance" id="next-maintenance" class="form-input" readonly style="background: #f8fafc;">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" name="auto_generate_wo" id="auto-generate-wo" class="rounded border-gray-300">
                                        <span class="text-sm font-semibold text-gray-700">Auto-Generate Work Orders (7 days before PM due)</span>
                                    </label>
                                </div>
                                <div class="md:col-span-2 bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <h4 class="font-semibold text-blue-900 mb-2">PM Schedule Preview</h4>
                                    <div id="pm-preview" class="text-sm text-blue-800">
                                        <p>Select a PM schedule type to see upcoming maintenance dates.</p>
                                    </div>
                                </div>
                                <div class="md:col-span-2 flex justify-end">
                                    <button type="button" onclick="clearPMSchedule()" class="btn btn-secondary">
                                        <i class="fas fa-times"></i> Clear Schedule
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" name="id" id="edit-asset-id">
                    <div class="flex justify-end gap-3 mt-8">
                        <button type="button" onclick="closeAssetModal()" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> <span id="submit-btn-text">Save Asset</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Work Orders -->
            <div id="workorders-section" class="p-6 border-t border-slate-200">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">Work Orders for this Asset</h3>
                    <button onclick="createWorkOrderForAsset()" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i> Create Work Order
                    </button>
                </div>
                <div id="asset-work-orders-list">
                    <p class="text-center text-gray-500 py-8">Loading work orders...</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Lookup Add New Modal -->
    <div id="lookup-modal" class="modal">
        <div class="modal-content" style="max-width: 480px;">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-900" id="lookup-modal-title">Add New</h2>
                    <button onclick="closeLookupModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2" id="lookup-modal-label">Name</label>
                <input type="text" id="lookup-modal-input" class="form-input" placeholder="Enter value">
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" class="btn btn-secondary" onclick="closeLookupModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveLookupModal()">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        const SUPABASE_URL = 'https://hmdemsbqiqlqcggwblvl.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_Z9oNxTGDCCz3EZnh6NqySg_QzF6amCN';
        let supabaseClient;
        let allAssets = [];
        let filteredAssets = [];
        let customers = [];
        let locations = [];
        let currentAsset = null;
        let csvData = null;
        let assetLookups = { categories: [], manufacturers: [], models: [] };
        let assetSchema = { hasCustomerId: true };
        let lookupContext = { type: null, label: null };

        document.addEventListener('DOMContentLoaded', async () => {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', () => {
                    mobileMenu.classList.toggle('hidden');
                });
            }

            if (!window.supabase) {
                showToast('Supabase library not loaded', 'error');
                return;
            }
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            await detectAssetSchema();
            await Promise.all([loadAssets(), loadCustomers(), loadLocations()]);
            setupEventListeners();
            setupDragDrop();
        });

        async function detectAssetSchema() {
            assetSchema = { hasCustomerId: true };
            try {
                const { error } = await supabaseClient
                    .from('assets')
                    .select('customer_id')
                    .limit(1);
                if (error && /customer_id|column/i.test(error.message)) {
                    assetSchema.hasCustomerId = false;
                }
            } catch (error) {
                console.warn('Unable to detect asset schema, disabling customer field.', error);
                assetSchema.hasCustomerId = false;
            }
        }

        async function loadAssets() {
            try {
                showLoading(true);
                const { data, error } = await supabaseClient
                    .from('assets')
                    .select('*')
                    .order('id', { ascending: false });
                if (error) throw error;

                const enrichedAssets = await Promise.all((data || []).map(async (asset) => {
                    let customerName = null, locationName = null;
                    if (assetSchema.hasCustomerId && asset.customer_id) {
                        const { data: customer } = await supabaseClient
                            .from('customers')
                            .select('name')
                            .eq('id', asset.customer_id)
                            .single();
                        customerName = customer?.name;
                    }
                    if (asset.location_id) {
                        const { data: location } = await supabaseClient
                            .from('locations')
                            .select('name')
                            .eq('id', asset.location_id)
                            .single();
                        locationName = location?.name;
                    }
                    return {
                        ...asset,
                        customers: customerName ? { name: customerName } : null,
                        locations: locationName ? { name: locationName } : null
                    };
                }));

                allAssets = enrichedAssets;
                filteredAssets = [...allAssets];
                refreshAssetLookups();
                updateStatistics();
                renderAssets();
                showToast(`Loaded ${allAssets.length} assets successfully`, 'success');
            } catch (error) {
                console.error('Error loading assets:', error);
                showToast(`Failed to load assets: ${error.message}`, 'error');
                allAssets = [];
                filteredAssets = [];
                renderAssets();
            } finally {
                showLoading(false);
            }
        }

        async function loadCustomers() {
            try {
                const { data, error } = await supabaseClient
                    .from('customers')
                    .select('id, name')
                    .eq('status', 'active')
                    .order('name');
                if (error) throw error;
                customers = data || [];
                updateCustomerDropdown();
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        async function loadLocations() {
            try {
                const { data, error } = await supabaseClient
                    .from('locations')
                    .select('id, name, customer_id')
                    .eq('status', 'active')
                    .order('name');
                if (error) throw error;
                locations = data || [];
                updateLocationDropdown();
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }

        function updateCustomerDropdown() {
            const select = document.getElementById('customer-select');
            select.innerHTML = '<option value="">Select Customer</option>';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name;
                select.appendChild(option);
            });
            select.disabled = !assetSchema.hasCustomerId;
            if (!assetSchema.hasCustomerId) {
                select.innerHTML = '<option value="">Customer field unavailable</option>';
            }
        }

        function updateLocationDropdown(customerId = null) {
            const select = document.getElementById('location-select');
            select.innerHTML = '<option value="">Select Location</option>';
            const filteredLocs = customerId ? locations.filter(loc => loc.customer_id === customerId) : locations;
            filteredLocs.forEach(location => {
                const option = document.createElement('option');
                option.value = location.id;
                option.textContent = location.name;
                select.appendChild(option);
            });
        }

        function refreshAssetLookups() {
            const categories = new Set();
            const manufacturers = new Set();
            const models = new Set();
            allAssets.forEach(asset => {
                if (asset.category) categories.add(asset.category);
                if (asset.manufacturer) manufacturers.add(asset.manufacturer);
                if (asset.model) models.add(asset.model);
            });
            assetLookups = {
                categories: Array.from(categories).sort((a, b) => a.localeCompare(b)),
                manufacturers: Array.from(manufacturers).sort((a, b) => a.localeCompare(b)),
                models: Array.from(models).sort((a, b) => a.localeCompare(b))
            };
            updateCategoryFilterOptions();
            updateCategorySelectOptions();
            updateDatalistOptions('manufacturer-list', assetLookups.manufacturers);
            updateDatalistOptions('model-list', assetLookups.models);
        }

        function updateCategoryFilterOptions() {
            const select = document.getElementById('category-filter');
            const current = select.value;
            select.innerHTML = '<option value="">All Categories</option>';
            assetLookups.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
            if (assetLookups.categories.includes(current)) {
                select.value = current;
            }
        }

        function updateCategorySelectOptions() {
            updateDatalistOptions('category-list', assetLookups.categories);
        }

        function updateDatalistOptions(listId, values) {
            const list = document.getElementById(listId);
            list.innerHTML = '';
            values.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                list.appendChild(option);
            });
        }

        function addNewLookup(type, label) {
            lookupContext = { type, label: label || type.slice(0, -1) };
            const modal = document.getElementById('lookup-modal');
            const title = document.getElementById('lookup-modal-title');
            const inputLabel = document.getElementById('lookup-modal-label');
            const input = document.getElementById('lookup-modal-input');
            title.textContent = `Add New ${lookupContext.label}`;
            inputLabel.textContent = `${lookupContext.label} Name`;
            input.value = '';
            modal.classList.add('active');
            setTimeout(() => input.focus(), 0);
        }

        function applyLookupValue(type, trimmed) {
            const list = assetLookups[type] || [];
            const exists = list.some(item => item.toLowerCase() === trimmed.toLowerCase());
            if (!exists) {
                list.push(trimmed);
                list.sort((a, b) => a.localeCompare(b));
                assetLookups[type] = list;
            }
            if (type === 'categories') {
                updateCategorySelectOptions();
                updateCategoryFilterOptions();
                document.getElementById('category-input').value = trimmed;
            } else if (type === 'manufacturers') {
                updateDatalistOptions('manufacturer-list', assetLookups.manufacturers);
                document.querySelector('input[name="manufacturer"]').value = trimmed;
            } else if (type === 'models') {
                updateDatalistOptions('model-list', assetLookups.models);
                document.querySelector('input[name="model"]').value = trimmed;
            }
        }
        function ensureLookupValue(type, value) {
            const trimmed = value.trim();
            if (!trimmed) return;
            applyLookupValue(type, trimmed);
        }

        function closeLookupModal() {
            document.getElementById('lookup-modal').classList.remove('active');
            lookupContext = { type: null, label: null };
        }

        function saveLookupModal() {
            const input = document.getElementById('lookup-modal-input');
            const value = input.value.trim();
            if (!value || !lookupContext.type) {
                showToast('Please enter a value to add.', 'warning');
                return;
            }
            applyLookupValue(lookupContext.type, value);
            closeLookupModal();
        }

        function updateStatistics() {
            const total = allAssets.length;
            const active = allAssets.filter(a => a.status === 'active').length;
            const maintenance = allAssets.filter(a => a.status === 'maintenance').length;
            const overdue = allAssets.filter(a => {
                if (!a.next_maintenance) return false;
                return new Date(a.next_maintenance) < new Date();
            }).length;
            const compliant = total > 0 ? Math.round(((total - overdue) / total) * 100) : 0;
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-active').textContent = active;
            document.getElementById('stat-maintenance').textContent = maintenance;
            document.getElementById('stat-overdue').textContent = overdue;
            document.getElementById('stat-compliant').textContent = compliant + '%';
        }

        function renderAssets() {
            const grid = document.getElementById('assets-grid');
            const empty = document.getElementById('empty-state');
            if (filteredAssets.length === 0) {
                grid.style.display = 'none';
                empty.style.display = 'block';
                return;
            }
            grid.style.display = 'grid';
            empty.style.display = 'none';
            grid.innerHTML = filteredAssets.map(asset => createAssetCard(asset)).join('');
        }

        function createAssetCard(asset) {
            const days = getDaysUntil(asset.next_maintenance);
            const statusColors = {
                active: 'bg-green-100 text-green-800',
                maintenance: 'bg-yellow-100 text-yellow-800',
                inactive: 'bg-gray-100 text-gray-800',
                retired: 'bg-red-100 text-red-800'
            };
            return `
                <div class="bg-white rounded-xl p-6 shadow-md card-hover border-l-4 ${days !== null && days < 0 ? 'border-red-500' : days !== null && days <= 7 ? 'border-orange-500' : 'border-green-500'}">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-gray-900 mb-1">${escapeHtml(asset.name)}</h3>
                            <p class="text-sm text-gray-500">${asset.id}</p>
                        </div>
                        <span class="text-xs px-3 py-1 rounded-full ${statusColors[asset.status] || 'bg-gray-100 text-gray-800'}">
                            ${asset.status}
                        </span>
                    </div>
                    <div class="space-y-2 mb-4 text-sm">
                        <div class="flex items-center"><i class="fas fa-tag w-5 text-gray-400"></i><span class="text-gray-700">${escapeHtml(asset.category || 'N/A')}</span></div>
                        <div class="flex items-center"><i class="fas fa-industry w-5 text-gray-400"></i><span class="text-gray-700">${escapeHtml(asset.manufacturer || 'N/A')}</span></div>
                        <div class="flex items-center"><i class="fas fa-building w-5 text-gray-400"></i><span class="text-gray-700">${escapeHtml(asset.customers?.name || 'Unassigned')}</span></div>
                        <div class="flex items-center"><i class="fas fa-map-marker-alt w-5 text-gray-400"></i><span class="text-gray-700">${escapeHtml(asset.locations?.name || 'No Location')}</span></div>
                    </div>
                    <div class="border-t pt-4 mb-4">
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div><span class="text-gray-500 block">Last PM:</span><span class="font-medium text-gray-900">${formatDate(asset.last_maintenance)}</span></div>
                            <div><span class="text-gray-500 block">Next PM:</span><span class="font-medium ${days !== null && days < 0 ? 'text-red-600' : 'text-gray-900'}">${formatDate(asset.next_maintenance)}</span></div>
                        </div>
                        ${days !== null ? `<div class="mt-2 text-sm"><span class="text-gray-500">PM Status:</span><span class="font-bold ${days < 0 ? 'text-red-600' : days <= 7 ? 'text-orange-600' : 'text-green-600'}">${days < 0 ? `${Math.abs(days)} days OVERDUE` : `${days} days remaining`}</span></div>` : ''}
                    </div>
                    <div class="flex gap-2">
                        <button onclick='viewAsset(${JSON.stringify(asset).replace(/'/g, "&#39;")})' class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"><i class="fas fa-eye mr-1"></i>View</button>
                        <button onclick="deleteAsset('${asset.id}')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        }

        function getDaysUntil(date) {
            if (!date) return null;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const targetDate = new Date(date);
            targetDate.setHours(0, 0, 0, 0);
            return Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
        }

        function formatDate(date) {
            if (!date) return 'N/A';
            return new Date(date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showAddAssetModal() {
            currentAsset = null;
            document.getElementById('modal-title').textContent = 'Add New Asset';
            document.getElementById('modal-subtitle').textContent = '';
            document.getElementById('submit-btn-text').textContent = 'Save Asset';
            document.getElementById('asset-form').reset();
            document.getElementById('edit-asset-id').value = '';
            document.getElementById('wo-tab-button').style.display = 'none';
            document.getElementById('pm-tab-button').classList.add('opacity-50', 'pointer-events-none');
            switchTab('details');
            document.getElementById('asset-modal').classList.add('active');
        }

        async function viewAsset(asset) {
            currentAsset = asset;
            document.getElementById('modal-title').textContent = asset.name;
            document.getElementById('modal-subtitle').textContent = asset.id;
            const form = document.getElementById('asset-form');
            form.name.value = asset.name || '';
            form.category.value = asset.category || '';
            form.manufacturer.value = asset.manufacturer || '';
            form.model.value = asset.model || '';
            form.serial_number.value = asset.serial_number || '';
            form.status.value = asset.status || 'active';
            form.purchase_date.value = asset.purchase_date || '';
            form.purchase_cost.value = asset.purchase_cost || '';
            form.warranty_expiry.value = asset.warranty_expiry || '';
            if (assetSchema.hasCustomerId) {
                form.customer_id.value = asset.customer_id || '';
            }
            form.location_id.value = asset.location_id || '';
            form.description.value = asset.description || '';
            document.getElementById('edit-asset-id').value = asset.id;
            if (assetSchema.hasCustomerId && asset.customer_id) {
                updateLocationDropdown(asset.customer_id);
            }
            document.getElementById('wo-tab-button').style.display = 'block';
            document.getElementById('pm-tab-button').classList.remove('opacity-50', 'pointer-events-none');
            await loadAssetWorkOrders(asset.id);
            loadPMSchedule(asset);
            document.getElementById('asset-modal').classList.add('active');
        }

        async function loadAssetWorkOrders(assetId) {
            const listEl = document.getElementById('asset-work-orders-list');
            listEl.innerHTML = '<p class="text-center text-gray-500 py-4">Loading...</p>';
            try {
                const { data, error } = await supabaseClient
                    .from('work_orders')
                    .select('*')
                    .eq('asset_id', assetId)
                    .order('created_date', { ascending: false });
                if (error) throw error;
                const workOrders = data || [];
                document.getElementById('wo-count').textContent = workOrders.length;
                if (workOrders.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-gray-500 py-8">No work orders found for this asset.</p>';
                } else {
                    listEl.innerHTML = workOrders.map(wo => `
                        <div class="wo-card priority-${wo.priority}">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-semibold text-gray-900">${wo.id}</h4>
                                    <p class="text-sm text-gray-600">${wo.type?.replace(/_/g, ' ') || 'N/A'}</p>
                                </div>
                                <span class="text-xs px-2 py-1 rounded-full ${wo.status === 'completed' ? 'bg-green-100 text-green-800' : wo.status === 'in-progress' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}">
                                    ${wo.status}
                                </span>
                            </div>
                            <p class="text-sm text-gray-700 mb-2">${escapeHtml(wo.description || '')}</p>
                            <div class="flex justify-between items-center text-xs text-gray-500">
                                <span>Priority: ${wo.priority}</span>
                                <span>Due: ${formatDate(wo.due_date)}</span>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading work orders:', error);
                listEl.innerHTML = '<p class="text-center text-red-600 py-4">Failed to load work orders.</p>';
            }
        }

        function loadPMSchedule(asset) {
            document.getElementById('pm-schedule-type').value = asset.pm_schedule_type || '';
            document.getElementById('pm-interval-days').value = asset.pm_interval_days || '';
            document.getElementById('last-maintenance').value = asset.last_maintenance || '';
            document.getElementById('next-maintenance').value = asset.next_maintenance || '';
            document.getElementById('auto-generate-wo').checked = asset.auto_generate_wo !== false;
            updatePMPreview();
        }

        function createWorkOrderForAsset() {
            showToast('Work order creation modal coming soon!', 'info');
        }

        function clearPMSchedule() {
            document.getElementById('pm-schedule-form').reset();
            document.getElementById('pm-preview').innerHTML = '<p>PM schedule cleared.</p>';
        }

        function updatePMPreview() {
            const scheduleType = document.getElementById('pm-schedule-type').value;
            const lastMaint = document.getElementById('last-maintenance').value;
            const customInterval = document.getElementById('pm-interval-days').value;
            const preview = document.getElementById('pm-preview');
            const customWrapper = document.getElementById('custom-interval-wrapper');
            customWrapper.style.display = scheduleType === 'custom' ? 'block' : 'none';
            if (!scheduleType || !lastMaint) {
                preview.innerHTML = '<p>Select a PM schedule type and last maintenance date to see upcoming dates.</p>';
                return;
            }
            const intervals = { daily: 1, weekly: 7, biweekly: 14, monthly: 30, quarterly: 90, semiannually: 180, annually: 365, custom: parseInt(customInterval) || 30 };
            const days = intervals[scheduleType];
            const lastDate = new Date(lastMaint);
            const nextDates = [];
            for (let i = 1; i <= 5; i++) {
                const nextDate = new Date(lastDate);
                nextDate.setDate(nextDate.getDate() + (days * i));
                nextDates.push(formatDate(nextDate.toISOString()));
            }
            document.getElementById('next-maintenance').value = new Date(new Date(lastMaint).getTime() + (days * 24 * 60 * 60 * 1000)).toISOString().split('T')[0];
            preview.innerHTML = `
                <p class="font-semibold mb-2">Next 5 PM Dates:</p>
                <ul class="list-disc list-inside space-y-1">
                    ${nextDates.map(date => `<li>${date}</li>`).join('')}
                </ul>
            `;
        }

        function closeAssetModal() {
            document.getElementById('asset-modal').classList.remove('active');
            currentAsset = null;
            document.getElementById('pm-tab-button').classList.remove('opacity-50', 'pointer-events-none');
        }

        async function deleteAsset(assetId) {
            if (!confirm('Delete this asset? This cannot be undone.')) return;
            try {
                const { error } = await supabaseClient.from('assets').delete().eq('id', assetId);
                if (error) throw error;
                showToast('Asset deleted successfully', 'success');
                await loadAssets();
            } catch (error) {
                showToast(`Failed to delete asset: ${error.message}`, 'error');
            }
        }

        document.getElementById('asset-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const assetData = {
                name: formData.get('name'),
                category: formData.get('category'),
                manufacturer: formData.get('manufacturer'),
                model: formData.get('model'),
                serial_number: formData.get('serial_number'),
                status: formData.get('status'),
                purchase_date: formData.get('purchase_date') || null,
                purchase_cost: formData.get('purchase_cost') || null,
                warranty_expiry: formData.get('warranty_expiry') || null,
                location_id: formData.get('location_id') || null,
                description: formData.get('description') || null,
                pm_schedule_type: formData.get('pm_schedule_type') || null,
                pm_interval_days: formData.get('pm_interval_days') || null,
                last_maintenance: formData.get('last_maintenance') || null,
                next_maintenance: formData.get('next_maintenance') || null,
                auto_generate_wo: formData.get('auto_generate_wo') === 'on'
            };
            if (assetSchema.hasCustomerId) {
                assetData.customer_id = formData.get('customer_id') || null;
            }
            const assetId = document.getElementById('edit-asset-id').value;
            try {
                if (assetId) {
                    const { error } = await supabaseClient.from('assets').update(assetData).eq('id', assetId);
                    if (error) throw error;
                    showToast('Asset updated successfully', 'success');
                } else {
                    const { error } = await supabaseClient.from('assets').insert([assetData]);
                    if (error) throw error;
                    showToast('Asset created successfully', 'success');
                }
                closeAssetModal();
                await loadAssets();
            } catch (error) {
                showToast(`Failed to save asset: ${error.message}`, 'error');
            }
        });

        document.getElementById('pm-schedule-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentAsset) {
                showToast('Please save the asset before adding a PM schedule.', 'warning');
                return;
            }
            const formData = new FormData(e.target);
            const pmData = {
                pm_schedule_type: formData.get('pm_schedule_type') || null,
                pm_interval_days: formData.get('pm_interval_days') || null,
                last_maintenance: formData.get('last_maintenance') || null,
                next_maintenance: formData.get('next_maintenance') || null,
                auto_generate_wo: formData.get('auto_generate_wo') === 'on'
            };
            try {
                const { error } = await supabaseClient.from('assets').update(pmData).eq('id', currentAsset.id);
                if (error) throw error;
                showToast('PM Schedule updated successfully', 'success');
                await loadAssets();
                closeAssetModal();
            } catch (error) {
                showToast(`Failed to save PM schedule: ${error.message}`, 'error');
            }
        });

        function generateAssetId() {
            const today = new Date();
            const dateStamp = today.toISOString().split('T')[0].replace(/-/g, '');
            const randomPart = Math.random().toString(36).slice(2, 6).toUpperCase();
            return `AST-${dateStamp}-${randomPart}`;
        }

        function setupEventListeners() {
            document.getElementById('search-input').addEventListener('input', debounce((e) => {
                const term = e.target.value.toLowerCase();
                filteredAssets = allAssets.filter(a => a.name?.toLowerCase().includes(term) || a.id?.toLowerCase().includes(term) || a.serial_number?.toLowerCase().includes(term));
                renderAssets();
            }, 300));
            document.getElementById('category-filter').addEventListener('change', applyFilters);
            document.getElementById('status-filter').addEventListener('change', applyFilters);
            document.getElementById('customer-select').addEventListener('change', (e) => updateLocationDropdown(e.target.value));
            document.getElementById('category-input').addEventListener('blur', (e) => ensureLookupValue('categories', e.target.value));
            document.querySelector('input[name="manufacturer"]').addEventListener('blur', (e) => ensureLookupValue('manufacturers', e.target.value));
            document.querySelector('input[name="model"]').addEventListener('blur', (e) => ensureLookupValue('models', e.target.value));
            document.getElementById('pm-schedule-type').addEventListener('change', updatePMPreview);
            document.getElementById('pm-interval-days').addEventListener('input', updatePMPreview);
            document.getElementById('last-maintenance').addEventListener('change', updatePMPreview);
        }

        function applyFilters() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const category = document.getElementById('category-filter').value;
            const status = document.getElementById('status-filter').value;
            filteredAssets = allAssets.filter(a => {
                const matchesTerm = !term || a.name?.toLowerCase().includes(term) || a.id?.toLowerCase().includes(term);
                const matchesCat = !category || a.category === category;
                const matchesStat = !status || a.status === status;
                return matchesTerm && matchesCat && matchesStat;
            });
            renderAssets();
        }

        function exportToCSV() {
            const headers = ['Asset ID', 'Name', 'Category', 'Status', 'Serial Number', 'Manufacturer', 'Model', 'Customer', 'Location', 'Purchase Date', 'Purchase Cost', 'Last PM', 'Next PM'];
            const rows = filteredAssets.map(a => [a.id, a.name, a.category, a.status, a.serial_number, a.manufacturer, a.model, a.customers?.name || '', a.locations?.name || '', a.purchase_date || '', a.purchase_cost || '', a.last_maintenance || '', a.next_maintenance || '']);
            const csvContent = [headers.join(','), ...rows.map(row => row.map(cell => `"${cell}"`).join(','))].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `assets_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            showToast(`Exported ${filteredAssets.length} assets`, 'success');
        }

        function showBulkImportModal() {
            document.getElementById('bulk-import-modal').classList.add('active');
        }

        function closeBulkImportModal() {
            document.getElementById('bulk-import-modal').classList.remove('active');
            csvData = null;
            document.getElementById('import-preview').style.display = 'none';
        }

        function downloadTemplate() {
            const template = 'name,category,manufacturer,model,serial_number,status,purchase_date,purchase_cost,warranty_expiry,customer_id,location_id,description\n"MRI Scanner","diagnostic","GE Healthcare","Signa HDxt","SN123456","active","2024-01-15","2500000","2029-01-15","","","Example asset"';
            const blob = new Blob([template], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'asset_import_template.csv';
            a.click();
        }

        function setupDragDrop() {
            const dropZone = document.getElementById('drop-zone');
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                const file = e.dataTransfer.files[0];
                if (file && file.type === 'text/csv') {
                    handleFile(file);
                } else {
                    showToast('Please drop a CSV file', 'error');
                }
            });
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) handleFile(file);
        }

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                parseCSV(text);
            };
            reader.readAsText(file);
        }

        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const rows = lines.slice(1).filter(line => line.trim()).map(line => {
                const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                const obj = {};
                headers.forEach((header, i) => { obj[header] = values[i] || ''; });
                return obj;
            });
            csvData = rows;
            document.getElementById('preview-content').innerHTML = `
                <p class="font-semibold mb-2">Found ${rows.length} assets to import</p>
                <div class="text-sm"><strong>First record:</strong> ${rows[0]?.name || 'N/A'}</div>
            `;
            document.getElementById('import-preview').style.display = 'block';
        }

        function cancelImport() {
            csvData = null;
            document.getElementById('import-preview').style.display = 'none';
        }

        async function confirmImport() {
            if (!csvData || csvData.length === 0) {
                showToast('No data to import', 'error');
                return;
            }
            try {
                const { error } = await supabaseClient.from('assets').insert(csvData);
                if (error) throw error;
                showToast(`Successfully imported ${csvData.length} assets`, 'success');
                closeBulkImportModal();
                await loadAssets();
            } catch (error) {
                showToast(`Import failed: ${error.message}`, 'error');
            }
        }

        function switchTab(tab) {
            const button = document.querySelector(`.tab-button[onclick*="${tab}"]`);
            if (button?.classList.contains('pointer-events-none')) {
                showToast('Please save the asset before editing the PM schedule.', 'warning');
                return;
            }
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            button.classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('assets-grid').style.display = show ? 'none' : 'grid';
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `<div class="flex items-center gap-3"><i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i><span>${message}</span></div>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }
    </script>
</body>
</html>
