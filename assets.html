<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asset Management - MERC-CMMS</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>
<script src="auth.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
* { font-family: 'Inter', sans-serif; }
.medical-gradient { background: linear-gradient(135deg, #1e293b 0%, #2563eb 50%, #0891b2 100%); }
.card-hover { transition: all 0.3s ease; }
.card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
.notification-badge { position: absolute; top: -8px; right: -8px; background: #dc2626; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; }
.status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
.status-active { background-color: #059669; }
.status-inactive { background-color: #6b7280; }
.status-maintenance { background-color: #d97706; }
.status-retired { background-color: #dc2626; }
.asset-header-bg { background-image: url('/resources/asset-header.jpg'); background-size: cover; background-position: center; }
.form-input { width: 100%; padding: 10px 16px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; transition: all 0.2s; }
.form-input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
.btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s; border: none; }
.btn-primary { background: #2563eb; color: white; }
.btn-primary:hover { background: #1d4ed8; }
.btn-secondary { background: #e2e8f0; color: #475569; }
.btn-secondary:hover { background: #cbd5e1; }
.btn-success { background: #059669; color: white; }
.btn-success:hover { background: #047857; }
.loading-spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: #2563eb; border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.fade-in { animation: fadeIn 0.3s ease-in-out; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
#toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
.toast { padding: 12px 20px; border-radius: 8px; color: white; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); animation: slideIn 0.3s ease-out; max-width: 400px; }
.toast-success { background: #059669; }
.toast-error { background: #dc2626; }
.toast-warning { background: #d97706; }
.toast-info { background: #2563eb; }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
.status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: capitalize; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; }
.modal.active { display: flex; align-items: center; justify-content: center; }
.modal-content { background: white; border-radius: 16px; max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
.tab-button { padding: 12px 24px; border-bottom: 2px solid transparent; font-weight: 600; cursor: pointer; transition: all 0.2s; color: #64748b; }
.tab-button.active { color: #2563eb; border-bottom-color: #2563eb; background: #eff6ff; }
.tab-button:hover { background: #f8fafc; }
.tab-content { display: none; }
.tab-content.active { display: block; }
#mobile-menu { position: fixed; top: 64px; left: 0; right: 0; z-index: 40; background: linear-gradient(135deg, #1e293b 0%, #2563eb 50%, #0891b2 100%); padding: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transform: translateY(0); visibility: visible; opacity: 1; transition: transform 0.3s ease, opacity 0.3s ease; }
#mobile-menu.hidden { transform: translateY(-100%); opacity: 0; pointer-events: none; visibility: hidden; }
.drag-drop-zone { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 40px; text-align: center; transition: all 0.2s; cursor: pointer; }
.drag-drop-zone.drag-over { border-color: #2563eb; background: #eff6ff; }
.wo-card { background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; border-left: 4px solid #2563eb; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
.wo-card.priority-critical { border-left-color: #dc2626; }
.wo-card.priority-high { border-left-color: #d97706; }
.wo-card.priority-medium { border-left-color: #2563eb; }
.wo-card.priority-low { border-left-color: #6b7280; }
.view-toggle-btn { background: white; color: #64748b; border: 1px solid #cbd5e1; }
.view-toggle-btn:hover { background: #f8fafc; }
.view-toggle-btn.active { background: #2563eb; color: white; border-color: #2563eb; }
</style>
</head>
<body class="bg-slate-50 text-slate-800">
    <!-- Header -->
    <nav class="fixed top-0 left-0 right-0 z-50 medical-gradient shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-nowrap justify-between items-center gap-3 py-2 min-h-[4rem]">
                <a href="index.html" class="flex items-center space-x-4 min-w-0">
                    <img src="/resources/Logo_without%20name.png" alt="MERC-CMMS logo" class="w-10 h-10 rounded-full bg-white object-contain p-1">
                    <div class="min-w-0">
                        <h1 class="text-white text-xl font-bold truncate">MERC-CMMS</h1>
                        <p class="text-blue-200 text-xs truncate">Enterprise Medical Device Management</p>
                    </div>
                </a>
                <div class="hidden md:flex items-center space-x-8">
                    <a href="index.html" class="text-blue-200 hover:text-white transition-colors">Dashboard</a>
                    <a href="customers.html" class="text-blue-200 hover:text-white transition-colors">Customers</a>
                    <a href="assets.html" class="text-white font-semibold border-b-2 border-blue-300 pb-1">Assets</a>
                    <a href="work-orders.html" class="text-blue-200 hover:text-white transition-colors">Work Orders</a>
                    <a href="compliance.html" class="text-blue-200 hover:text-white transition-colors">Compliance</a>
                </div>
                <div class="flex items-center gap-3 flex-shrink-0">
                    <button id="mobile-menu-button" class="md:hidden text-white hover:text-blue-200 transition-colors">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <div class="flex items-center gap-3">
                        <div class="relative">
                            <button class="text-white hover:text-blue-200 transition-colors">
                                <i class="fas fa-bell text-xl"></i>
                            </button>
                            <div class="notification-badge">3</div>
                        </div>
                        <a href="settings.html" class="text-white hover:text-blue-200 transition-colors" aria-label="Open settings">
                            <i class="fas fa-gear text-xl"></i>
                        </a>
                        <button id="logout-button" class="text-white hover:text-blue-200 transition-colors" aria-label="Sign out">
                            <i class="fas fa-right-from-bracket text-xl"></i>
                        </button>
                    </div>
                    <div class="flex items-center space-x-2 min-w-0">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-white text-sm"></i>
                        </div>
                        <div class="hidden md:block min-w-0">
                            <p class="text-white text-sm font-medium truncate">System Admin</p>
                            <p class="text-blue-200 text-xs truncate">Super Administrator</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <div id="mobile-menu" class="md:hidden hidden">
        <div class="px-4 py-4 space-y-2">
            <a href="index.html" class="block text-blue-200 hover:text-white transition-colors">Dashboard</a>
            <a href="customers.html" class="block text-blue-200 hover:text-white transition-colors">Customers</a>
            <a href="assets.html" class="block text-white font-semibold">Assets</a>
            <a href="work-orders.html" class="block text-blue-200 hover:text-white transition-colors">Work Orders</a>
            <a href="compliance.html" class="block text-blue-200 hover:text-white transition-colors">Compliance</a>
        </div>
    </div>

    <!-- Main Content -->
    <main class="pt-16">
        <!-- Header Section -->
        <section class="asset-header-bg relative">
            <div class="absolute inset-0 bg-slate-900 bg-opacity-70"></div>
            <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
                <div class="text-center">
                    <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">Asset Management</h1>
                    <p class="text-xl text-blue-200 mb-8 max-w-3xl mx-auto">
                        Complete medical device lifecycle management with automated PM scheduling and compliance tracking
                    </p>
                </div>
            </div>
        </section>

        <!-- Statistics Dashboard -->
        <section class="py-8 bg-white">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Asset Summary</h2>
                        <p class="text-sm text-slate-500">Counts update automatically from the latest asset data.</p>
                    </div>
                    <div class="text-sm text-slate-500">Last refreshed: <span id="assets-last-refresh">--</span></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                    <div class="bg-slate-50 rounded-lg p-4 text-center">
                        <div id="stat-total" class="text-2xl font-bold text-blue-600">0</div>
                        <div class="text-slate-600 text-sm">Total Assets</div>
                    </div>
                    <div class="bg-slate-50 rounded-lg p-4 text-center">
                        <div id="stat-active" class="text-2xl font-bold text-green-600">0</div>
                        <div class="text-slate-600 text-sm">Active</div>
                    </div>
                    <div class="bg-slate-50 rounded-lg p-4 text-center">
                        <div id="stat-maintenance" class="text-2xl font-bold text-amber-600">0</div>
                        <div class="text-slate-600 text-sm">In Maintenance</div>
                    </div>
                    <div class="bg-slate-50 rounded-lg p-4 text-center">
                        <div id="stat-overdue" class="text-2xl font-bold text-red-600">0</div>
                        <div class="text-slate-600 text-sm">Overdue PM</div>
                    </div>
                    <div class="bg-slate-50 rounded-lg p-4 text-center">
                        <div id="stat-compliant" class="text-2xl font-bold text-purple-600">0%</div>
                        <div class="text-slate-600 text-sm">Compliant</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Controls Bar -->
        <section class="py-6 bg-slate-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div class="flex-1 min-w-[300px]">
                            <div class="relative">
                                <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <input type="text" id="search-input" placeholder="Search by name or serial number..." class="form-input pl-12">
                            </div>
                        </div>
                        <select id="category-filter" class="form-input max-w-[200px]">
                            <option value="">All Categories</option>
                        </select>
                        <select id="status-filter" class="form-input max-w-[180px]">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="maintenance">Maintenance</option>
                    <option value="inactive">Inactive</option>
                    <option value="retired">Retired</option>
                </select>
                <div class="flex gap-2 border border-slate-300 rounded-lg overflow-hidden">
                    <button id="grid-view-btn" onclick="switchView('grid')" class="view-toggle-btn active px-4 py-2 text-sm font-medium transition-colors">
                        <i class="fas fa-th-large mr-2"></i>Grid View
                    </button>
                    <button id="list-view-btn" onclick="switchView('list')" class="view-toggle-btn px-4 py-2 text-sm font-medium transition-colors">
                        <i class="fas fa-list mr-2"></i>List View
                    </button>
                </div>
                <button onclick="showBulkImportModal()" class="btn btn-secondary">
                    <i class="fas fa-file-import"></i>
                    Bulk Import
                </button>
                <button onclick="exportToCSV()" class="btn btn-success">
                    <i class="fas fa-download"></i>
                    Export CSV
                </button>
                <button onclick="showAddAssetModal()" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    Add Asset
                </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Loading State -->
        <section class="py-8 bg-white">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div id="loading" class="text-center py-16">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-600 font-medium">Loading assets from Supabase...</p>
                </div>
                <div id="assets-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 fade-in" style="display:none"></div>
                <div id="assets-list" class="hidden">
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Asset ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Category</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Serial Number</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Next PM</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Compliance</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="assets-list-body" class="bg-white divide-y divide-slate-200">
                                <!-- Assets will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="empty-state" class="text-center py-16 bg-slate-50 rounded-xl" style="display:none">
                    <i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-2xl font-bold text-gray-700 mb-2">No Assets Found</h3>
                    <p class="text-gray-500 mb-6">Get started by adding your first medical device asset</p>
                    <button onclick="showAddAssetModal()" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        Add Your First Asset
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-slate-800 text-white py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-slate-400">&copy; 2025 MERC-CMMS Enterprise. All rights reserved.</p>
        </div>
    </footer>

    <!-- Bulk Import Modal -->
    <div id="bulk-import-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">Bulk Import Assets</h2>
                    <button onclick="closeBulkImportModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="mb-6">
                    <h3 class="font-semibold text-gray-900 mb-2">CSV Format Requirements:</h3>
                    <p class="text-sm text-gray-600 mb-3">Your CSV file should include the following columns:</p>
                    <div class="bg-slate-50 p-4 rounded-lg text-sm font-mono">
                        name,category,manufacturer,model,serial_number,status,purchase_date,purchase_cost,warranty_expiry,customer_id,location_id,description
                    </div>
                    <button onclick="downloadTemplate()" class="mt-3 text-blue-600 hover:text-blue-700 text-sm font-semibold">
                        <i class="fas fa-download mr-2"></i>Download CSV Template
                    </button>
                </div>
                <div class="drag-drop-zone" id="drop-zone">
                    <i class="fas fa-cloud-upload-alt text-5xl text-gray-400 mb-4"></i>
                    <p class="text-lg font-semibold text-gray-700 mb-2">Drag and drop your CSV file here</p>
                    <p class="text-sm text-gray-500 mb-4">or</p>
                    <button onclick="document.getElementById('csv-file-input').click()" class="btn btn-primary">
                        <i class="fas fa-file-csv mr-2"></i>Select CSV File
                    </button>
                    <input type="file" id="csv-file-input" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
                </div>
                <div id="import-preview" class="mt-6" style="display: none;">
                    <h3 class="font-semibold text-gray-900 mb-2">Import Preview:</h3>
                    <div id="preview-content" class="bg-slate-50 p-4 rounded-lg max-h-48 overflow-auto"></div>
                    <div class="flex justify-end gap-3 mt-4">
                        <button onclick="cancelImport()" class="btn btn-secondary">Cancel</button>
                        <button onclick="confirmImport()" class="btn btn-primary">
                            <i class="fas fa-check mr-2"></i>Import Assets
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Asset View/Edit Modal with Tabs -->
    <div id="asset-modal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900" id="modal-title">Asset Details</h2>
                        <p class="text-sm text-gray-500 mt-1" id="modal-subtitle"></p>
                    </div>
                    <button onclick="closeAssetModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <!-- Tabs -->
                <div class="flex gap-2 mt-4 border-b">
                    <button class="tab-button active" onclick="switchTab('details')">
                        <i class="fas fa-info-circle mr-2"></i>Details
                    </button>
                    <button class="tab-button" onclick="switchTab('workorders')" id="wo-tab-button">
                        <i class="fas fa-clipboard-list mr-2"></i>Work Orders <span id="wo-count" class="ml-1 bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-xs"></span>
                    </button>
                    <button class="tab-button" onclick="switchTab('pmschedule')" id="pm-tab-button">
                        <i class="fas fa-calendar-alt mr-2"></i>PM Schedule
                    </button>
                </div>
            </div>

            <!-- Details Tab -->
            <div id="details-tab" class="tab-content active p-6">
                <form id="asset-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Asset Name *</label>
                            <input type="text" name="name" required class="form-input" placeholder="e.g., MRI Scanner">
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label class="block text-sm font-semibold text-gray-700">Category *</label>
                                <button type="button" id="add-category-btn" class="text-sm font-semibold text-blue-600 hover:text-blue-700" onclick="addNewLookup('categories', 'Category')">
                                    <i class="fas fa-plus mr-1"></i>Add
                                </button>
                            </div>
                            <select name="category_id" id="category-select" required class="form-input">
                                <option value="">Select Category</option>
                            </select>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label class="block text-sm font-semibold text-gray-700">Make *</label>
                                <button type="button" id="add-manufacturer-btn" class="text-sm font-semibold text-blue-600 hover:text-blue-700" onclick="addNewLookup('manufacturers', 'Make')">
                                    <i class="fas fa-plus mr-1"></i>Add
                                </button>
                            </div>
                            <select name="manufacturer_id" id="manufacturer-select" required class="form-input" disabled>
                                <option value="">Select Make</option>
                            </select>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label class="block text-sm font-semibold text-gray-700">Model *</label>
                                <button type="button" id="add-model-btn" class="text-sm font-semibold text-blue-600 hover:text-blue-700" onclick="addNewLookup('models', 'Model')">
                                    <i class="fas fa-plus mr-1"></i>Add
                                </button>
                            </div>
                            <select name="model_id" id="model-select" required class="form-input" disabled>
                                <option value="">Select Model</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Serial Number *</label>
                            <input type="text" name="serial_number" required class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                            <select name="status" class="form-input">
                                <option value="active">Active</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="inactive">Inactive</option>
                                <option value="retired">Retired</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Purchase Date</label>
                            <input type="date" name="purchase_date" class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Purchase Cost ($)</label>
                            <input type="number" name="purchase_cost" step="0.01" class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Warranty Expiry</label>
                            <input type="date" name="warranty_expiry" class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Customer</label>
                            <select name="customer_id" id="customer-select" class="form-input">
                                <option value="">Select Customer</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Location</label>
                            <select name="location_id" id="location-select" class="form-input">
                                <option value="">Select Location</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                            <textarea name="description" rows="3" class="form-input"></textarea>
                        </div>
                        <div class="md:col-span-2 border-t border-slate-200 pt-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Preventive Maintenance Schedule</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">PM Schedule Type</label>
                                    <select name="pm_schedule_type" id="pm-schedule-type" class="form-input">
                                        <option value="">No PM Schedule</option>
                                        <option value="daily">Daily (Every 24 hours)</option>
                                        <option value="weekly">Weekly (Every 7 days)</option>
                                        <option value="biweekly">Bi-Weekly (Every 14 days)</option>
                                        <option value="monthly">Monthly (Every 30 days)</option>
                                        <option value="quarterly">Quarterly (Every 90 days)</option>
                                        <option value="semiannually">Semi-Annually (Every 180 days)</option>
                                        <option value="annually">Annually (Every 365 days)</option>
                                        <option value="custom">Custom Interval</option>
                                    </select>
                                </div>
                                <div id="custom-interval-wrapper" style="display: none;">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Custom Interval (days)</label>
                                    <input type="number" name="pm_interval_days" id="pm-interval-days" class="form-input" min="1" placeholder="e.g., 45">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Last Maintenance Date</label>
                                    <input type="date" name="last_maintenance" id="last-maintenance" class="form-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Next Maintenance Due</label>
                                    <input type="date" name="next_maintenance" id="next-maintenance" class="form-input" readonly style="background: #f8fafc;">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" name="auto_generate_wo" id="auto-generate-wo" class="rounded border-gray-300">
                                        <span class="text-sm font-semibold text-gray-700">Auto-Generate Work Orders (7 days before PM due)</span>
                                    </label>
                                </div>
                                <div class="md:col-span-2 bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <h4 class="font-semibold text-blue-900 mb-2">PM Schedule Preview</h4>
                                    <div id="pm-preview" class="text-sm text-blue-800">
                                        <p>Select a PM schedule type to see upcoming maintenance dates.</p>
                                    </div>
                                </div>
                                <div class="md:col-span-2 flex justify-end">
                                    <button type="button" onclick="clearPMSchedule()" class="btn btn-secondary">
                                        <i class="fas fa-times"></i> Clear Schedule
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" name="id" id="edit-asset-id">
                    <div class="flex justify-end gap-3 mt-8">
                        <button type="button" onclick="closeAssetModal()" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> <span id="submit-btn-text">Save Asset</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Work Orders Tab -->
            <div id="workorders-tab" class="tab-content p-6 border-t border-slate-200">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">Work Orders for this Asset</h3>
                    <button onclick="createWorkOrderForAsset()" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i> Create Work Order
                    </button>
                </div>
                <div id="asset-work-orders-list">
                    <p class="text-center text-gray-500 py-8">Loading work orders...</p>
                </div>
            </div>

            <!-- PM Schedule Tab -->
            <div id="pmschedule-tab" class="tab-content p-6 border-t border-slate-200">
                <form id="pm-schedule-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">PM Schedule Type</label>
                            <select name="pm_schedule_type" id="pm-schedule-type-edit" class="form-input">
                                <option value="">No PM Schedule</option>
                                <option value="daily">Daily (Every 24 hours)</option>
                                <option value="weekly">Weekly (Every 7 days)</option>
                                <option value="biweekly">Bi-Weekly (Every 14 days)</option>
                                <option value="monthly">Monthly (Every 30 days)</option>
                                <option value="quarterly">Quarterly (Every 90 days)</option>
                                <option value="semiannually">Semi-Annually (Every 180 days)</option>
                                <option value="annually">Annually (Every 365 days)</option>
                                <option value="custom">Custom Interval</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Custom Interval (days)</label>
                            <input type="number" name="pm_interval_days" id="pm-interval-days-edit" class="form-input" min="1" placeholder="e.g., 45">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Last Maintenance Date</label>
                            <input type="date" name="last_maintenance" id="last-maintenance-edit" class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Next Maintenance Due</label>
                            <input type="date" name="next_maintenance" id="next-maintenance-edit" class="form-input" readonly style="background: #f8fafc;">
                        </div>
                        <div class="md:col-span-2">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" name="auto_generate_wo" id="auto-generate-wo-edit" class="rounded border-gray-300">
                                <span class="text-sm font-semibold text-gray-700">Auto-Generate Work Orders (7 days before PM due)</span>
                            </label>
                        </div>
                        <div class="md:col-span-2 bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-semibold text-blue-900 mb-2">PM Schedule Preview</h4>
                            <div id="pm-preview-edit" class="text-sm text-blue-800">
                                <p>Select a PM schedule type to see upcoming maintenance dates.</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-8">
                        <button type="button" onclick="closeAssetModal()" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Schedule
                        </button>
                    </div>
                </form>
            </div>

        </div>
    </div>

    <!-- Lookup Add New Modal -->
    <div id="lookup-modal" class="modal">
        <div class="modal-content" style="max-width: 480px;">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-900" id="lookup-modal-title">Add New</h2>
                    <button onclick="closeLookupModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2" id="lookup-modal-label">Name</label>
                <input type="text" id="lookup-modal-input" class="form-input" placeholder="Enter value">
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" class="btn btn-secondary" onclick="closeLookupModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveLookupModal()">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        const SUPABASE_URL = 'https://hmdemsbqiqlqcggwblvl.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_Z9oNxTGDCCz3EZnh6NqySg_QzF6amCN';
        let supabaseClient;
        let allAssets = [];
        let filteredAssets = [];
        let customers = [];
        let locations = [];
        let currentAsset = null;
        let csvData = null;
        let assetSchema = { hasCustomerId: true, hasLookupIds: true, makeField: 'manufacturer_id' };
        let referenceData = { categories: [], manufacturers: [], models: [] };
        let referenceMaps = {
            categoriesById: new Map(),
            manufacturersById: new Map(),
            modelsById: new Map()
        };
        let lookupContext = { type: null, label: null, parentId: null };
        let canManageReferenceData = false;

        document.addEventListener('DOMContentLoaded', async () => {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', () => {
                    mobileMenu.classList.toggle('hidden');
                });
            }

            if (!window.supabase) {
                showToast('Supabase library not loaded', 'error');
                return;
            }
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            await detectAssetSchema();
            await loadReferenceData();
            await Promise.all([loadAssets(), loadCustomers(), loadLocations()]);
            setupEventListeners();
            setupDragDrop();
        });

        async function detectAssetSchema() {
            assetSchema = { hasCustomerId: true, hasLookupIds: true, makeField: 'manufacturer_id' };
            try {
                const { error } = await supabaseClient
                    .from('assets')
                    .select('customer_id')
                    .limit(1);
                if (error && /customer_id|column/i.test(error.message)) {
                    assetSchema.hasCustomerId = false;
                }
                const { error: categoryError } = await supabaseClient
                    .from('assets')
                    .select('category_id')
                    .limit(1);
                if (categoryError && /category_id|column/i.test(categoryError.message)) {
                    assetSchema.hasLookupIds = false;
                }
                const { error: makeError } = await supabaseClient
                    .from('assets')
                    .select('manufacturer_id')
                    .limit(1);
                if (makeError && /manufacturer_id|column/i.test(makeError.message)) {
                    const { error: altMakeError } = await supabaseClient
                        .from('assets')
                        .select('make_id')
                        .limit(1);
                    if (altMakeError && /make_id|column/i.test(altMakeError.message)) {
                        assetSchema.hasLookupIds = false;
                    } else {
                        assetSchema.makeField = 'make_id';
                    }
                }
                const { error: modelError } = await supabaseClient
                    .from('assets')
                    .select('model_id')
                    .limit(1);
                if (modelError && /model_id|column/i.test(modelError.message)) {
                    assetSchema.hasLookupIds = false;
                }
            } catch (error) {
                console.warn('Unable to detect asset schema, disabling customer field.', error);
                assetSchema.hasCustomerId = false;
                assetSchema.hasLookupIds = false;
            }
        }

        async function detectReferenceAccess() {
            try {
                if (!supabaseClient.auth?.getUser) {
                    canManageReferenceData = false;
                    return;
                }
                const { data, error } = await supabaseClient.auth.getUser();
                if (error) throw error;
                canManageReferenceData = Boolean(data?.user);
            } catch (error) {
                if (error?.name === 'AuthSessionMissingError' || /auth session missing/i.test(error?.message || '')) {
                    canManageReferenceData = false;
                    return;
                }
                console.warn('Unable to detect reference access.', error);
                canManageReferenceData = false;
            }
        }

        async function loadReferenceData() {
            try {
                await detectReferenceAccess();
                const [{ data: categories, error: categoryError }, { data: manufacturers, error: manufacturerError }, { data: models, error: modelError }] = await Promise.all([
                    supabaseClient.from('device_categories').select('id, name').order('name'),
                    supabaseClient.from('device_makes').select('id, name, category_id').order('name'),
                    supabaseClient.from('device_models').select('id, name, make_id').order('name')
                ]);
                const missingTableErrors = [categoryError, manufacturerError, modelError].filter(error => error && /does not exist|not found|schema cache/i.test(error.message || ''));
                if (missingTableErrors.length) {
                    referenceData = { categories: [], manufacturers: [], models: [] };
                    assetSchema.hasLookupIds = false;
                    buildReferenceMaps();
                    refreshReferenceLookups();
                    updateReferenceActionState();
                    return;
                }
                if (categoryError) throw categoryError;
                if (manufacturerError) throw manufacturerError;
                if (modelError) throw modelError;
                referenceData = {
                    categories: categories || [],
                    manufacturers: manufacturers || [],
                    models: models || []
                };
                buildReferenceMaps();
                refreshReferenceLookups();
                updateReferenceActionState();
            } catch (error) {
                console.error('Error loading reference data:', error);
                showToast(`Failed to load reference data: ${error.message}`, 'error');
            }
        }

        function buildReferenceMaps() {
            referenceMaps.categoriesById = new Map(referenceData.categories.map(category => [category.id, category]));
            referenceMaps.manufacturersById = new Map(referenceData.manufacturers.map(manufacturer => [manufacturer.id, manufacturer]));
            referenceMaps.modelsById = new Map(referenceData.models.map(model => [model.id, model]));
        }

        async function loadAssets() {
            try {
                showLoading(true);
                const { data, error } = await supabaseClient
                    .from('assets')
                    .select('*')
                    .order('id', { ascending: false });
                if (error) throw error;

                const enrichedAssets = await Promise.all((data || []).map(async (asset) => {
                    let customerName = null, locationName = null;
                    if (assetSchema.hasCustomerId && asset.customer_id) {
                        const { data: customer } = await supabaseClient
                            .from('customers')
                            .select('name')
                            .eq('id', asset.customer_id)
                            .single();
                        customerName = customer?.name;
                    }
                    if (asset.location_id) {
                        const { data: location } = await supabaseClient
                            .from('locations')
                            .select('name')
                            .eq('id', asset.location_id)
                            .single();
                        locationName = location?.name;
                    }
                    const categoryName = referenceMaps.categoriesById.get(asset.category_id)?.name || asset.category;
                    const manufacturerKey = asset.manufacturer_id || asset.make_id;
                    const manufacturerName = referenceMaps.manufacturersById.get(manufacturerKey)?.name || asset.manufacturer;
                    const modelName = referenceMaps.modelsById.get(asset.model_id)?.name || asset.model;
                    return {
                        ...asset,
                        category: categoryName,
                        manufacturer: manufacturerName,
                        model: modelName,
                        customers: customerName ? { name: customerName } : null,
                        locations: locationName ? { name: locationName } : null
                    };
                }));

                allAssets = enrichedAssets;
                filteredAssets = [...allAssets];
                updateStatistics();
                renderAssets();
                const lastRefresh = document.getElementById('assets-last-refresh');
                if (lastRefresh) {
                    lastRefresh.textContent = new Date().toLocaleString();
                }
                showToast(`Loaded ${allAssets.length} assets successfully`, 'success');
            } catch (error) {
                console.error('Error loading assets:', error);
                showToast(`Failed to load assets: ${error.message}`, 'error');
                allAssets = [];
                filteredAssets = [];
                renderAssets();
            } finally {
                showLoading(false);
            }
        }

        async function loadCustomers() {
            try {
                const { data, error } = await supabaseClient
                    .from('customers')
                    .select('id, name')
                    .eq('status', 'active')
                    .order('name');
                if (error) throw error;
                customers = data || [];
                updateCustomerDropdown();
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        async function loadLocations() {
            try {
                const { data, error } = await supabaseClient
                    .from('locations')
                    .select('id, name, customer_id')
                    .eq('status', 'active')
                    .order('name');
                if (error) throw error;
                locations = data || [];
                updateLocationDropdown();
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }

        function updateCustomerDropdown() {
            const select = document.getElementById('customer-select');
            select.innerHTML = '<option value="">Select Customer</option>';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name;
                select.appendChild(option);
            });
            select.disabled = !assetSchema.hasCustomerId;
            if (!assetSchema.hasCustomerId) {
                select.innerHTML = '<option value="">Customer field unavailable</option>';
            }
        }

        function updateLocationDropdown(customerId = null) {
            const select = document.getElementById('location-select');
            select.innerHTML = '<option value="">Select Location</option>';
            const filteredLocs = customerId ? locations.filter(loc => loc.customer_id === customerId) : locations;
            filteredLocs.forEach(location => {
                const option = document.createElement('option');
                option.value = location.id;
                option.textContent = location.name;
                select.appendChild(option);
            });
        }

        function refreshReferenceLookups() {
            updateCategoryFilterOptions();
            updateCategorySelectOptions();
        }

        function updateCategoryFilterOptions() {
            const select = document.getElementById('category-filter');
            const current = select.value;
            select.innerHTML = '<option value="">All Categories</option>';
            referenceData.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
            if (referenceMaps.categoriesById.has(current)) {
                select.value = current;
            }
        }

        function updateCategorySelectOptions() {
            const select = document.getElementById('category-select');
            const current = select.value;
            select.innerHTML = '<option value="">Select Category</option>';
            referenceData.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
            if (referenceMaps.categoriesById.has(current)) {
                select.value = current;
            }
            updateManufacturerOptions(select.value);
        }

        function updateManufacturerOptions(categoryId, selectedManufacturerId = '') {
            const select = document.getElementById('manufacturer-select');
            select.innerHTML = '<option value="">Select Make</option>';
            if (!categoryId) {
                select.disabled = true;
                updateModelOptions('', '');
                return;
            }
            const manufacturers = referenceData.manufacturers.filter(manufacturer => manufacturer.category_id === categoryId);
            manufacturers.forEach(manufacturer => {
                const option = document.createElement('option');
                option.value = manufacturer.id;
                option.textContent = manufacturer.name;
                select.appendChild(option);
            });
            select.disabled = false;
            if (selectedManufacturerId) {
                select.value = selectedManufacturerId;
            }
            updateModelOptions(selectedManufacturerId || select.value);
        }

        function updateModelOptions(manufacturerId, selectedModelId = '') {
            const select = document.getElementById('model-select');
            select.innerHTML = '<option value="">Select Model</option>';
            if (!manufacturerId) {
                select.disabled = true;
                return;
            }
            const models = referenceData.models.filter(model => model.make_id === manufacturerId);
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.name;
                select.appendChild(option);
            });
            select.disabled = false;
            if (selectedModelId) {
                select.value = selectedModelId;
            }
        }

        function updateReferenceActionState() {
            const buttons = [
                document.getElementById('add-category-btn'),
                document.getElementById('add-manufacturer-btn'),
                document.getElementById('add-model-btn')
            ];
            buttons.forEach(button => {
                if (!button) return;
                button.disabled = !canManageReferenceData;
                button.classList.toggle('opacity-50', !canManageReferenceData);
                button.classList.toggle('pointer-events-none', !canManageReferenceData);
            });
        }

        function addNewLookup(type, label) {
            if (!canManageReferenceData) {
                showToast('You do not have permission to add reference data.', 'warning');
                return;
            }
            let parentId = null;
            if (type === 'manufacturers') {
                parentId = document.getElementById('category-select').value;
                if (!parentId) {
                    showToast('Select a category before adding a manufacturer.', 'warning');
                    return;
                }
            }
            if (type === 'models') {
                parentId = document.getElementById('manufacturer-select').value;
                if (!parentId) {
                    showToast('Select a manufacturer before adding a model.', 'warning');
                    return;
                }
            }
            lookupContext = { type, label: label || type.slice(0, -1), parentId };
            const modal = document.getElementById('lookup-modal');
            const title = document.getElementById('lookup-modal-title');
            const inputLabel = document.getElementById('lookup-modal-label');
            const input = document.getElementById('lookup-modal-input');
            title.textContent = `Add New ${lookupContext.label}`;
            inputLabel.textContent = `${lookupContext.label} Name`;
            input.value = '';
            modal.classList.add('active');
            setTimeout(() => input.focus(), 0);
        }

        function closeLookupModal() {
            document.getElementById('lookup-modal').classList.remove('active');
            lookupContext = { type: null, label: null, parentId: null };
        }

        async function saveLookupModal() {
            const input = document.getElementById('lookup-modal-input');
            const value = input.value.trim();
            if (!value || !lookupContext.type) {
                showToast('Please enter a value to add.', 'warning');
                return;
            }
            
            if (!supabaseClient) {
                showToast('Supabase is not connected. Please check your configuration.', 'error');
                return;
            }
            
            try {
                const payload = { name: value };
                let table = '';
                let tableDisplayName = '';
                if (lookupContext.type === 'categories') {
                    table = 'device_categories';
                    tableDisplayName = 'device_categories';
                } else if (lookupContext.type === 'manufacturers') {
                    table = 'device_makes';
                    tableDisplayName = 'device_makes';
                    payload.category_id = lookupContext.parentId;
                    if (!lookupContext.parentId) {
                        showToast('Please select a category first.', 'warning');
                        return;
                    }
                } else if (lookupContext.type === 'models') {
                    table = 'device_models';
                    tableDisplayName = 'device_models';
                    payload.make_id = lookupContext.parentId;
                    if (!lookupContext.parentId) {
                        showToast('Please select a manufacturer first.', 'warning');
                        return;
                    }
                }
                if (!table) {
                    showToast('Unknown reference type.', 'error');
                    return;
                }
                
                // First, check if the table exists by attempting a simple select
                const tableCheck = await supabaseClient
                    .from(table)
                    .select('id')
                    .limit(1);
                
                if (tableCheck.error && /does not exist|not found|schema cache|relation.*does not exist/i.test(tableCheck.error.message || '')) {
                    const errorMsg = `The ${tableDisplayName} table does not exist in your Supabase database.\n\n` +
                                   `To fix this:\n` +
                                   `1. Open your Supabase Dashboard\n` +
                                   `2. Go to SQL Editor\n` +
                                   `3. Open the file: device_catalog_schema.sql\n` +
                                   `4. Copy and paste the entire contents\n` +
                                   `5. Click "Run" to execute\n\n` +
                                   `This will create the required tables: device_categories, device_makes, and device_models.`;
                    showToast(errorMsg, 'error');
                    closeLookupModal();
                    return;
                }
                
                // Generate IDs for all lookup types
                if (lookupContext.type === 'categories') {
                    // Generate ID from name (lowercase, replace spaces with underscores)
                    payload.id = value.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '').substring(0, 50);
                    // Ensure ID is not empty
                    if (!payload.id) {
                        payload.id = 'category_' + Date.now();
                    }
                } else if (lookupContext.type === 'manufacturers') {
                    // Generate ID from category_id and name
                    const nameSlug = value.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '').substring(0, 30);
                    payload.id = `${lookupContext.parentId}_${nameSlug}`;
                    if (!payload.id || payload.id.length < 2) {
                        payload.id = `${lookupContext.parentId}_make_${Date.now()}`;
                    }
                } else if (lookupContext.type === 'models') {
                    // Generate ID from make_id and name
                    const nameSlug = value.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '').substring(0, 30);
                    payload.id = `${lookupContext.parentId}_${nameSlug}`;
                    if (!payload.id || payload.id.length < 2) {
                        payload.id = `${lookupContext.parentId}_model_${Date.now()}`;
                    }
                }
                
                // Check for duplicate name
                const duplicateCheck = await supabaseClient
                    .from(table)
                    .select('id, name')
                    .eq('name', value);
                
                if (duplicateCheck.data && duplicateCheck.data.length > 0) {
                    showToast(`A ${lookupContext.label.toLowerCase()} with this name already exists.`, 'warning');
                    return;
                }
                
                const { data, error } = await supabaseClient
                    .from(table)
                    .insert([payload])
                    .select('id, name, category_id, make_id')
                    .single();
                
                // If table doesn't exist, provide helpful error message
                if (error && /does not exist|not found|schema cache|relation.*does not exist/i.test(error.message || '')) {
                    const errorMsg = `The ${tableDisplayName} table does not exist in your Supabase database.\n\n` +
                                   `To fix this:\n` +
                                   `1. Open your Supabase Dashboard\n` +
                                   `2. Go to SQL Editor\n` +
                                   `3. Open the file: device_catalog_schema.sql\n` +
                                   `4. Copy and paste the entire contents\n` +
                                   `5. Click "Run" to execute\n\n` +
                                   `This will create the required tables: device_categories, device_makes, and device_models.`;
                    showToast(errorMsg, 'error', 10000);
                    closeLookupModal();
                    return;
                }
                
                if (error) {
                    console.error('Error inserting into', table, ':', error);
                    // Check for specific error types
                    if (error.message && error.message.includes('duplicate key') || error.message.includes('unique constraint')) {
                        showToast(`A ${lookupContext.label.toLowerCase()} with this name or ID already exists.`, 'error');
                    } else if (error.message && error.message.includes('foreign key')) {
                        showToast(`Invalid parent reference. Please ensure the parent ${lookupContext.type === 'manufacturers' ? 'category' : 'manufacturer'} exists.`, 'error');
                    } else {
                        showToast(`Failed to add ${lookupContext.label.toLowerCase()}: ${error.message || 'Unknown error'}`, 'error');
                    }
                    return;
                }
                if (lookupContext.type === 'categories') {
                    referenceData.categories.push({ id: data.id, name: data.name });
                    referenceData.categories.sort((a, b) => a.name.localeCompare(b.name));
                    buildReferenceMaps();
                    updateCategorySelectOptions();
                    updateCategoryFilterOptions();
                    document.getElementById('category-select').value = data.id;
                } else if (lookupContext.type === 'manufacturers') {
                    referenceData.manufacturers.push({ id: data.id, name: data.name, category_id: data.category_id });
                    referenceData.manufacturers.sort((a, b) => a.name.localeCompare(b.name));
                    buildReferenceMaps();
                    const categoryId = lookupContext.parentId;
                    updateManufacturerOptions(categoryId, data.id);
                    document.getElementById('manufacturer-select').value = data.id;
                } else if (lookupContext.type === 'models') {
                    referenceData.models.push({ id: data.id, name: data.name, make_id: data.make_id });
                    referenceData.models.sort((a, b) => a.name.localeCompare(b.name));
                    buildReferenceMaps();
                    const manufacturerId = lookupContext.parentId;
                    updateModelOptions(manufacturerId, data.id);
                    document.getElementById('model-select').value = data.id;
                }
                closeLookupModal();
            } catch (error) {
                console.error('Error saving lookup value:', error);
                showToast(`Failed to add ${lookupContext.label}: ${error.message}`, 'error');
            }
        }

        function updateStatistics() {
            const total = allAssets.length;
            const active = allAssets.filter(a => a.status === 'active').length;
            const maintenance = allAssets.filter(a => a.status === 'maintenance').length;
            const overdue = allAssets.filter(a => {
                if (!a.next_maintenance) return false;
                return new Date(a.next_maintenance) < new Date();
            }).length;
            const compliant = total > 0 ? Math.round(((total - overdue) / total) * 100) : 0;
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-active').textContent = active;
            document.getElementById('stat-maintenance').textContent = maintenance;
            document.getElementById('stat-overdue').textContent = overdue;
            document.getElementById('stat-compliant').textContent = compliant + '%';
        }

        let currentView = 'grid';

        function switchView(view) {
            currentView = view;
            const gridBtn = document.getElementById('grid-view-btn');
            const listBtn = document.getElementById('list-view-btn');
            if (gridBtn) {
                gridBtn.classList.toggle('active', view === 'grid');
            }
            if (listBtn) {
                listBtn.classList.toggle('active', view === 'list');
            }
            renderAssets();
        }

        function renderAssets() {
            if (currentView === 'grid') {
                renderAssetsGrid();
            } else {
                renderAssetsList();
            }
        }

        function renderAssetsGrid() {
            const grid = document.getElementById('assets-grid');
            const list = document.getElementById('assets-list');
            const empty = document.getElementById('empty-state');
            
            if (list) list.classList.add('hidden');
            if (grid) grid.classList.remove('hidden');
            
            if (filteredAssets.length === 0) {
                if (grid) grid.style.display = 'none';
                if (empty) empty.style.display = 'block';
                return;
            }
            if (grid) grid.style.display = 'grid';
            if (empty) empty.style.display = 'none';
            if (grid) grid.innerHTML = filteredAssets.map(asset => createAssetCard(asset)).join('');
        }

        function renderAssetsList() {
            const grid = document.getElementById('assets-grid');
            const list = document.getElementById('assets-list');
            const listBody = document.getElementById('assets-list-body');
            const empty = document.getElementById('empty-state');
            
            if (grid) grid.style.display = 'none';
            if (list) list.classList.remove('hidden');
            if (empty) empty.style.display = 'none';
            
            if (!listBody) return;
            
            if (filteredAssets.length === 0) {
                listBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-12 text-center text-slate-500">
                            <i class="fas fa-box-open text-4xl mb-4 text-slate-300"></i>
                            <p class="text-lg font-semibold mb-2">No assets found</p>
                            <p class="text-sm mb-4">Get started by adding your first medical device asset</p>
                            <button onclick="showAddAssetModal()" class="btn btn-primary">
                                <i class="fas fa-plus"></i>Add Your First Asset
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            listBody.innerHTML = filteredAssets.map(asset => {
                const days = getDaysUntil(asset.next_maintenance);
                const statusColors = {
                    active: 'bg-green-100 text-green-800',
                    maintenance: 'bg-yellow-100 text-yellow-800',
                    inactive: 'bg-gray-100 text-gray-800',
                    retired: 'bg-red-100 text-red-800'
                };
                const complianceColor = days !== null && days < 0 ? 'text-red-600 font-bold' : days !== null && days <= 7 ? 'text-orange-600 font-semibold' : 'text-green-600';
                const complianceText = days !== null && days < 0 ? `${Math.abs(days)} days OVERDUE` : days !== null ? `${days} days remaining` : 'N/A';
                
                return `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${escapeHtml(asset.id || 'N/A')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">${escapeHtml(asset.name || 'Unnamed')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${escapeHtml(asset.category || 'N/A')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${escapeHtml(asset.serial_number || 'N/A')}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColors[asset.status] || 'bg-gray-100 text-gray-800'}">
                                ${asset.status ? asset.status.charAt(0).toUpperCase() + asset.status.slice(1) : 'Unknown'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${formatDate(asset.next_maintenance)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${complianceColor}">${complianceText}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick='viewAsset(${JSON.stringify(asset).replace(/'/g, "&#39;")})' class="text-blue-600 hover:text-blue-900 mr-3">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button onclick="deleteAsset('${asset.id}')" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function createAssetCard(asset) {
            const days = getDaysUntil(asset.next_maintenance);
            const statusColors = {
                active: 'bg-green-100 text-green-800',
                maintenance: 'bg-yellow-100 text-yellow-800',
                inactive: 'bg-gray-100 text-gray-800',
                retired: 'bg-red-100 text-red-800'
            };
            return `
                <div class="bg-white rounded-xl p-6 shadow-md card-hover border-l-4 ${days !== null && days < 0 ? 'border-red-500' : days !== null && days <= 7 ? 'border-orange-500' : 'border-green-500'}">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-gray-900 mb-1">${escapeHtml(asset.name)}</h3>
                        </div>
                        <span class="text-xs px-3 py-1 rounded-full ${statusColors[asset.status] || 'bg-gray-100 text-gray-800'}">
                            ${asset.status}
                        </span>
                    </div>
                    <div class="space-y-2 mb-4 text-sm">
                        <div class="flex items-center"><i class="fas fa-tag w-5 text-gray-400"></i><span class="text-gray-700">${escapeHtml(asset.category || 'N/A')}</span></div>
                        <div class="flex items-center"><i class="fas fa-industry w-5 text-gray-400"></i><span class="text-gray-700">${escapeHtml(asset.manufacturer || 'N/A')}</span></div>
                        <div class="flex items-center"><i class="fas fa-building w-5 text-gray-400"></i><span class="text-gray-700">${escapeHtml(asset.customers?.name || 'Unassigned')}</span></div>
                        <div class="flex items-center"><i class="fas fa-map-marker-alt w-5 text-gray-400"></i><span class="text-gray-700">${escapeHtml(asset.locations?.name || 'No Location')}</span></div>
                    </div>
                    <div class="border-t pt-4 mb-4">
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div><span class="text-gray-500 block">Last PM:</span><span class="font-medium text-gray-900">${formatDate(asset.last_maintenance)}</span></div>
                            <div><span class="text-gray-500 block">Next PM:</span><span class="font-medium ${days !== null && days < 0 ? 'text-red-600' : 'text-gray-900'}">${formatDate(asset.next_maintenance)}</span></div>
                        </div>
                        ${days !== null ? `<div class="mt-2 text-sm"><span class="text-gray-500">PM Status:</span><span class="font-bold ${days < 0 ? 'text-red-600' : days <= 7 ? 'text-orange-600' : 'text-green-600'}">${days < 0 ? `${Math.abs(days)} days OVERDUE` : `${days} days remaining`}</span></div>` : ''}
                    </div>
                    <div class="flex gap-2">
                        <button onclick='viewAsset(${JSON.stringify(asset).replace(/'/g, "&#39;")})' class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"><i class="fas fa-eye mr-1"></i>View</button>
                        <button onclick="deleteAsset('${asset.id}')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        }

        function getDaysUntil(date) {
            if (!date) return null;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const targetDate = new Date(date);
            targetDate.setHours(0, 0, 0, 0);
            return Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
        }

        function formatDate(date) {
            if (!date) return 'N/A';
            return new Date(date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showAddAssetModal() {
            currentAsset = null;
            document.getElementById('modal-title').textContent = 'Add New Asset';
            document.getElementById('modal-subtitle').textContent = '';
            document.getElementById('submit-btn-text').textContent = 'Save Asset';
            document.getElementById('asset-form').reset();
            document.getElementById('edit-asset-id').value = '';
            updateCategorySelectOptions();
            document.getElementById('manufacturer-select').disabled = true;
            document.getElementById('model-select').disabled = true;
            document.getElementById('wo-tab-button').style.display = 'none';
            document.getElementById('pm-tab-button').classList.add('opacity-50', 'pointer-events-none');
            switchTab('details');
            document.getElementById('asset-modal').classList.add('active');
        }

        async function viewAsset(asset) {
            currentAsset = asset;
            document.getElementById('modal-title').textContent = asset.name;
            document.getElementById('modal-subtitle').textContent = asset.name || 'Asset details';
            const form = document.getElementById('asset-form');
            form.name.value = asset.name || '';
            const categoryId = asset.category_id || resolveCategoryIdByName(asset.category);
            const manufacturerId = asset.manufacturer_id || asset.make_id || resolveManufacturerIdByName(asset.manufacturer, categoryId);
            const modelId = asset.model_id || resolveModelIdByName(asset.model, manufacturerId);
            form.category_id.value = categoryId || '';
            updateManufacturerOptions(categoryId, manufacturerId);
            form.manufacturer_id.value = manufacturerId || '';
            updateModelOptions(manufacturerId, modelId);
            form.model_id.value = modelId || '';
            form.serial_number.value = asset.serial_number || '';
            form.status.value = asset.status || 'active';
            form.purchase_date.value = asset.purchase_date || '';
            form.purchase_cost.value = asset.purchase_cost || '';
            form.warranty_expiry.value = asset.warranty_expiry || '';
            if (assetSchema.hasCustomerId) {
                form.customer_id.value = asset.customer_id || '';
            }
            form.location_id.value = asset.location_id || '';
            form.description.value = asset.description || '';
            document.getElementById('edit-asset-id').value = asset.id;
            if (assetSchema.hasCustomerId && asset.customer_id) {
                updateLocationDropdown(asset.customer_id);
            }
            document.getElementById('wo-tab-button').style.display = 'block';
            document.getElementById('pm-tab-button').classList.remove('opacity-50', 'pointer-events-none');
            await loadAssetWorkOrders(asset.id);
            loadPMSchedule(asset);
            document.getElementById('asset-modal').classList.add('active');
        }

        function resolveCategoryIdByName(name) {
            if (!name) return '';
            const match = referenceData.categories.find(category => category.name.toLowerCase() === name.toLowerCase());
            return match?.id || '';
        }

        function resolveManufacturerIdByName(name, categoryId = '') {
            if (!name) return '';
            return referenceData.manufacturers.find(manufacturer => {
                const matchesName = manufacturer.name.toLowerCase() === name.toLowerCase();
                const matchesCategory = !categoryId || manufacturer.category_id === categoryId;
                return matchesName && matchesCategory;
            })?.id || '';
        }

        function resolveModelIdByName(name, manufacturerId = '') {
            if (!name) return '';
            return referenceData.models.find(model => {
                const matchesName = model.name.toLowerCase() === name.toLowerCase();
                const matchesManufacturer = !manufacturerId || model.make_id === manufacturerId;
                return matchesName && matchesManufacturer;
            })?.id || '';
        }

        async function loadAssetWorkOrders(assetId) {
            const listEl = document.getElementById('asset-work-orders-list');
            listEl.innerHTML = '<p class="text-center text-gray-500 py-4">Loading...</p>';
            try {
                const { data, error } = await supabaseClient
                    .from('work_orders')
                    .select('*')
                    .eq('asset_id', assetId)
                    .in('status', ['open', 'in-progress'])
                    .order('created_date', { ascending: false });
                if (error) throw error;
                const workOrders = data || [];
                document.getElementById('wo-count').textContent = workOrders.length;
                if (workOrders.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-gray-500 py-8">No work orders found for this asset.</p>';
                } else {
                    listEl.innerHTML = workOrders.map(wo => `
                        <div class="wo-card priority-${wo.priority}">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-semibold text-gray-900">${wo.id}</h4>
                                    <p class="text-sm text-gray-600">${wo.type?.replace(/_/g, ' ') || 'N/A'}</p>
                                </div>
                                <span class="text-xs px-2 py-1 rounded-full ${wo.status === 'completed' ? 'bg-green-100 text-green-800' : wo.status === 'in-progress' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}">
                                    ${wo.status}
                                </span>
                            </div>
                            <p class="text-sm text-gray-700 mb-2">${escapeHtml(wo.description || '')}</p>
                            <div class="flex justify-between items-center text-xs text-gray-500">
                                <span>Priority: ${wo.priority}</span>
                                <span>Due: ${formatDate(wo.due_date)}</span>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading work orders:', error);
                listEl.innerHTML = '<p class="text-center text-red-600 py-4">Failed to load work orders.</p>';
            }
        }

        function loadPMSchedule(asset) {
            document.getElementById('pm-schedule-type').value = asset.pm_schedule_type || '';
            document.getElementById('pm-interval-days').value = asset.pm_interval_days || '';
            document.getElementById('last-maintenance').value = asset.last_maintenance || '';
            document.getElementById('next-maintenance').value = asset.next_maintenance || '';
            document.getElementById('auto-generate-wo').checked = asset.auto_generate_wo !== false;
            updatePMPreview();
        }

        function createWorkOrderForAsset() {
            if (!currentAsset?.id) {
                showToast('Please select an asset first.', 'warning');
                return;
            }
            window.location.href = `work-orders.html?asset=${encodeURIComponent(currentAsset.id)}`;
        }

        function clearPMSchedule() {
            document.getElementById('pm-schedule-form').reset();
            document.getElementById('pm-preview').innerHTML = '<p>PM schedule cleared.</p>';
        }

        function updatePMPreview() {
            const scheduleType = document.getElementById('pm-schedule-type').value;
            const lastMaint = document.getElementById('last-maintenance').value;
            const customInterval = document.getElementById('pm-interval-days').value;
            const preview = document.getElementById('pm-preview');
            const customWrapper = document.getElementById('custom-interval-wrapper');
            customWrapper.style.display = scheduleType === 'custom' ? 'block' : 'none';
            if (!scheduleType || !lastMaint) {
                preview.innerHTML = '<p>Select a PM schedule type and last maintenance date to see upcoming dates.</p>';
                return;
            }
            const intervals = { daily: 1, weekly: 7, biweekly: 14, monthly: 30, quarterly: 90, semiannually: 180, annually: 365, custom: parseInt(customInterval) || 30 };
            const days = intervals[scheduleType];
            const lastDate = new Date(lastMaint);
            const nextDates = [];
            for (let i = 1; i <= 5; i++) {
                const nextDate = new Date(lastDate);
                nextDate.setDate(nextDate.getDate() + (days * i));
                nextDates.push(formatDate(nextDate.toISOString()));
            }
            document.getElementById('next-maintenance').value = new Date(new Date(lastMaint).getTime() + (days * 24 * 60 * 60 * 1000)).toISOString().split('T')[0];
            preview.innerHTML = `
                <p class="font-semibold mb-2">Next 5 PM Dates:</p>
                <ul class="list-disc list-inside space-y-1">
                    ${nextDates.map(date => `<li>${date}</li>`).join('')}
                </ul>
            `;
        }

        function calculateNextMaintenanceDate(scheduleType, lastMaint, customInterval) {
            if (!scheduleType || !lastMaint) return null;
            const intervals = { daily: 1, weekly: 7, biweekly: 14, monthly: 30, quarterly: 90, semiannually: 180, annually: 365, custom: parseInt(customInterval) || 30 };
            const days = intervals[scheduleType];
            const lastDate = new Date(lastMaint);
            const nextDate = new Date(lastDate);
            nextDate.setDate(nextDate.getDate() + days);
            return nextDate;
        }

        function closeAssetModal() {
            document.getElementById('asset-modal').classList.remove('active');
            currentAsset = null;
            document.getElementById('pm-tab-button').classList.remove('opacity-50', 'pointer-events-none');
        }

        async function deleteAsset(assetId) {
            if (!confirm('Delete this asset? This cannot be undone.')) return;
            try {
                const { error } = await supabaseClient.from('assets').delete().eq('id', assetId);
                if (error) throw error;
                showToast('Asset deleted successfully', 'success');
                await loadAssets();
            } catch (error) {
                showToast(`Failed to delete asset: ${error.message}`, 'error');
            }
        }

        document.getElementById('asset-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const assetData = {
                name: formData.get('name'),
                serial_number: formData.get('serial_number'),
                status: formData.get('status'),
                purchase_date: formData.get('purchase_date') || null,
                purchase_cost: formData.get('purchase_cost') || null,
                warranty_expiry: formData.get('warranty_expiry') || null,
                description: formData.get('description') || null
            };
            const categoryId = formData.get('category_id');
            const manufacturerId = formData.get('manufacturer_id');
            const modelId = formData.get('model_id');
            if (assetSchema.hasLookupIds) {
                assetData.category_id = categoryId;
                assetData[assetSchema.makeField] = manufacturerId;
                assetData.model_id = modelId;
            } else {
                assetData.category = getSelectOptionText('category-select');
                assetData.manufacturer = getSelectOptionText('manufacturer-select');
                assetData.model = getSelectOptionText('model-select');
            }
            
            // Only include location_id if it has a value
            const locationId = formData.get('location_id');
            if (locationId) {
                assetData.location_id = locationId;
            }
            
            if (assetSchema.hasCustomerId) {
                const customerId = formData.get('customer_id');
                if (customerId) {
                    assetData.customer_id = customerId;
                }
            }
            
            const assetId = document.getElementById('edit-asset-id').value;
            try {
                if (assetId) {
                    const { error } = await supabaseClient.from('assets').update(assetData).eq('id', assetId);
                    if (error) throw error;
                    showToast('Asset updated successfully', 'success');
                } else {
                    assetData.id = generateAssetId();
                    const { error } = await supabaseClient.from('assets').insert([assetData]);
                    if (error) throw error;
                    showToast('Asset created successfully', 'success');
                }
                closeAssetModal();
                await loadAssets();
            } catch (error) {
                showToast(`Failed to save asset: ${error.message}`, 'error');
            }
        });

        function getSelectOptionText(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return '';
            const option = select.selectedOptions?.[0];
            if (!option || !select.value) return '';
            return option.textContent?.trim() || '';
        }

        document.getElementById('pm-schedule-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentAsset) {
                showToast('Please save the asset before adding a PM schedule.', 'warning');
                return;
            }
            const scheduleType = document.getElementById('pm-schedule-type').value;
            const intervalDays = document.getElementById('pm-interval-days').value;
            const lastMaintenance = document.getElementById('last-maintenance').value;
            const nextMaintenanceInput = document.getElementById('next-maintenance').value;
            const autoGenerate = document.getElementById('auto-generate-wo').checked;

            const nextMaintenanceDate = calculateNextMaintenanceDate(scheduleType, lastMaintenance, intervalDays);
            const nextMaintenance = nextMaintenanceDate
                ? nextMaintenanceDate.toISOString()
                : (nextMaintenanceInput ? new Date(nextMaintenanceInput).toISOString() : null);

            try {
                const { error: updateError } = await supabaseClient
                    .from('assets')
                    .update({
                        pm_schedule_type: scheduleType || null,
                        pm_interval_days: intervalDays ? Number(intervalDays) : null,
                        last_maintenance: lastMaintenance || null,
                        next_maintenance: nextMaintenance,
                        auto_generate_wo: autoGenerate
                    })
                    .eq('id', currentAsset.id);

                if (updateError) throw updateError;

                if (autoGenerate && nextMaintenance) {
                    const now = new Date();
                    const threshold = new Date();
                    threshold.setDate(threshold.getDate() + 7);
                    if (new Date(nextMaintenance) <= threshold) {
                        const { data: existingWorkOrders, error: woError } = await supabaseClient
                            .from('work_orders')
                            .select('id')
                            .eq('asset_id', currentAsset.id)
                            .eq('type', 'preventive_maintenance')
                            .in('status', ['open', 'in-progress'])
                            .limit(1);
                        if (woError) throw woError;
                        if (!existingWorkOrders?.length) {
                            const { error: createError } = await supabaseClient
                                .from('work_orders')
                                .insert([{
                                    asset_id: currentAsset.id,
                                    type: 'preventive_maintenance',
                                    priority: 'medium',
                                    status: 'open',
                                    due_date: nextMaintenance,
                                    description: `Auto-generated PM for ${currentAsset.name || currentAsset.id}`
                                }]);
                            if (createError) throw createError;
                            await supabaseClient
                                .from('assets')
                                .update({ pm_last_generated_at: now.toISOString() })
                                .eq('id', currentAsset.id);
                        }
                    }
                }

                showToast('PM schedule saved successfully.', 'success');
                await loadAssets();
                await loadAssetWorkOrders(currentAsset.id);
                closeAssetModal();
            } catch (error) {
                showToast(`Failed to save PM schedule: ${error.message}`, 'error');
            }
        });

        function generateAssetId() {
            const today = new Date();
            const dateStamp = today.toISOString().split('T')[0].replace(/-/g, '');
            const randomPart = Math.random().toString(36).slice(2, 6).toUpperCase();
            return `AST-${dateStamp}-${randomPart}`;
        }

        function setupEventListeners() {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('input', debounce((e) => {
                    const term = e.target.value.toLowerCase();
                    filteredAssets = allAssets.filter(a => a.name?.toLowerCase().includes(term) || a.serial_number?.toLowerCase().includes(term));
                    renderAssets();
                }, 300));
            }
            document.getElementById('category-filter').addEventListener('change', applyFilters);
            document.getElementById('status-filter').addEventListener('change', applyFilters);
            document.getElementById('customer-select').addEventListener('change', (e) => updateLocationDropdown(e.target.value));
            document.getElementById('category-select').addEventListener('change', (e) => {
                updateManufacturerOptions(e.target.value);
            });
            document.getElementById('manufacturer-select').addEventListener('change', (e) => {
                updateModelOptions(e.target.value);
            });
            document.getElementById('pm-schedule-type').addEventListener('change', updatePMPreview);
            document.getElementById('pm-interval-days').addEventListener('input', updatePMPreview);
            document.getElementById('last-maintenance').addEventListener('change', updatePMPreview);
        }

        function applyFilters() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const category = document.getElementById('category-filter').value;
            const status = document.getElementById('status-filter').value;
            const selectedCategoryName = category ? referenceMaps.categoriesById.get(category)?.name : '';
            filteredAssets = allAssets.filter(a => {
                const matchesTerm = !term || a.name?.toLowerCase().includes(term);
                const matchesCat = !category || a.category_id === category || (selectedCategoryName && a.category === selectedCategoryName);
                const matchesStat = !status || a.status === status;
                return matchesTerm && matchesCat && matchesStat;
            });
            renderAssets();
        }

        function exportToCSV() {
            const headers = ['Name', 'Category', 'Status', 'Serial Number', 'Manufacturer', 'Model', 'Customer', 'Location', 'Purchase Date', 'Purchase Cost', 'Last PM', 'Next PM'];
            const rows = filteredAssets.map(a => [a.name, a.category, a.status, a.serial_number, a.manufacturer, a.model, a.customers?.name || '', a.locations?.name || '', a.purchase_date || '', a.purchase_cost || '', a.last_maintenance || '', a.next_maintenance || '']);
            const csvContent = [headers.join(','), ...rows.map(row => row.map(cell => `"${cell}"`).join(','))].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `assets_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            showToast(`Exported ${filteredAssets.length} assets`, 'success');
        }

        function showBulkImportModal() {
            document.getElementById('bulk-import-modal').classList.add('active');
        }

        function closeBulkImportModal() {
            document.getElementById('bulk-import-modal').classList.remove('active');
            csvData = null;
            document.getElementById('import-preview').style.display = 'none';
        }

        function downloadTemplate() {
            const template = 'name,category,manufacturer,model,serial_number,status,purchase_date,purchase_cost,warranty_expiry,customer_id,location_id,description\n"MRI Scanner","diagnostic","GE Healthcare","Signa HDxt","SN123456","active","2024-01-15","2500000","2029-01-15","","","Example asset"';
            const blob = new Blob([template], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'asset_import_template.csv';
            a.click();
        }

        function setupDragDrop() {
            const dropZone = document.getElementById('drop-zone');
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                const file = e.dataTransfer.files[0];
                if (file && file.type === 'text/csv') {
                    handleFile(file);
                } else {
                    showToast('Please drop a CSV file', 'error');
                }
            });
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) handleFile(file);
        }

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                parseCSV(text);
            };
            reader.readAsText(file);
        }

        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const rows = lines.slice(1).filter(line => line.trim()).map(line => {
                const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                const obj = {};
                headers.forEach((header, i) => { obj[header] = values[i] || ''; });
                return obj;
            });
            csvData = rows;
            document.getElementById('preview-content').innerHTML = `
                <p class="font-semibold mb-2">Found ${rows.length} assets to import</p>
                <div class="text-sm"><strong>First record:</strong> ${rows[0]?.name || 'N/A'}</div>
            `;
            document.getElementById('import-preview').style.display = 'block';
        }

        function cancelImport() {
            csvData = null;
            document.getElementById('import-preview').style.display = 'none';
        }

        async function confirmImport() {
            if (!csvData || csvData.length === 0) {
                showToast('No data to import', 'error');
                return;
            }
            try {
                const { error } = await supabaseClient.from('assets').insert(csvData);
                if (error) throw error;
                showToast(`Successfully imported ${csvData.length} assets`, 'success');
                closeBulkImportModal();
                await loadAssets();
            } catch (error) {
                showToast(`Import failed: ${error.message}`, 'error');
            }
        }

        function switchTab(tab) {
            const button = document.querySelector(`.tab-button[onclick*="${tab}"]`);
            if (button?.classList.contains('pointer-events-none')) {
                showToast('Please save the asset before editing the PM schedule.', 'warning');
                return;
            }
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            button.classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('assets-grid').style.display = show ? 'none' : 'grid';
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `<div class="flex items-center gap-3"><i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i><span>${message}</span></div>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }
    </script>
</body>
</html>
